<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>核心概念 | 流程引擎原理与实践</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?925c3dadc75643902ba1d4bef48fa406";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
        </script></script>
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="国内首本从工程角度系统性介绍流程引擎的技术体系">
    <meta name="baidu-site-verification" content="codeva-c7FETTq8fo">
    <meta name="keywords" content="开源电子书，工作流技术体系，流程引擎技术体系，工作流，流程引擎，事件驱动机制，权限系统设计，云原生工作流，Crontab工作流，工作流系统架构，流程建模，DAG，FSM，WFMC，BPMN，BPM，Airflow，OsWorkflow，Petri">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.b8820ad2.js" as="script"><link rel="preload" href="/assets/js/2.a6c4a04f.js" as="script"><link rel="preload" href="/assets/js/1.04b49174.js" as="script"><link rel="preload" href="/assets/js/20.2fd50ddb.js" as="script"><link rel="prefetch" href="/assets/js/10.01c85a43.js"><link rel="prefetch" href="/assets/js/11.36ba8367.js"><link rel="prefetch" href="/assets/js/12.49270403.js"><link rel="prefetch" href="/assets/js/13.9964bf6f.js"><link rel="prefetch" href="/assets/js/14.1ffdb2cc.js"><link rel="prefetch" href="/assets/js/15.3ec6e020.js"><link rel="prefetch" href="/assets/js/16.223f06e4.js"><link rel="prefetch" href="/assets/js/17.49a0611a.js"><link rel="prefetch" href="/assets/js/18.5e539e58.js"><link rel="prefetch" href="/assets/js/19.08beb14f.js"><link rel="prefetch" href="/assets/js/21.94815126.js"><link rel="prefetch" href="/assets/js/22.7335372f.js"><link rel="prefetch" href="/assets/js/23.efd43c2e.js"><link rel="prefetch" href="/assets/js/24.33511251.js"><link rel="prefetch" href="/assets/js/25.9103752e.js"><link rel="prefetch" href="/assets/js/26.be3c6fce.js"><link rel="prefetch" href="/assets/js/27.a66d9ab9.js"><link rel="prefetch" href="/assets/js/28.db24d1a7.js"><link rel="prefetch" href="/assets/js/29.e639cc41.js"><link rel="prefetch" href="/assets/js/3.8ee85a39.js"><link rel="prefetch" href="/assets/js/30.9f96cad1.js"><link rel="prefetch" href="/assets/js/31.76245b5d.js"><link rel="prefetch" href="/assets/js/32.01a0bbd7.js"><link rel="prefetch" href="/assets/js/33.6cb05ad6.js"><link rel="prefetch" href="/assets/js/34.370a24a6.js"><link rel="prefetch" href="/assets/js/35.83692dfe.js"><link rel="prefetch" href="/assets/js/36.c783d15a.js"><link rel="prefetch" href="/assets/js/37.ac210fe0.js"><link rel="prefetch" href="/assets/js/38.07dc64eb.js"><link rel="prefetch" href="/assets/js/39.4ef28dca.js"><link rel="prefetch" href="/assets/js/4.9d17ba4d.js"><link rel="prefetch" href="/assets/js/40.a8fcb556.js"><link rel="prefetch" href="/assets/js/41.98d7d1f0.js"><link rel="prefetch" href="/assets/js/42.e31dd182.js"><link rel="prefetch" href="/assets/js/43.822702b0.js"><link rel="prefetch" href="/assets/js/44.50c68594.js"><link rel="prefetch" href="/assets/js/45.4e32699e.js"><link rel="prefetch" href="/assets/js/46.09f04e77.js"><link rel="prefetch" href="/assets/js/47.35c13096.js"><link rel="prefetch" href="/assets/js/48.99dfb60f.js"><link rel="prefetch" href="/assets/js/49.e1984c48.js"><link rel="prefetch" href="/assets/js/5.5682b71e.js"><link rel="prefetch" href="/assets/js/50.4242e15e.js"><link rel="prefetch" href="/assets/js/51.bdee7514.js"><link rel="prefetch" href="/assets/js/52.3b23c6f4.js"><link rel="prefetch" href="/assets/js/53.b6798440.js"><link rel="prefetch" href="/assets/js/54.ac356f09.js"><link rel="prefetch" href="/assets/js/55.79840f1c.js"><link rel="prefetch" href="/assets/js/56.343306c2.js"><link rel="prefetch" href="/assets/js/57.90f7511a.js"><link rel="prefetch" href="/assets/js/58.59457ff7.js"><link rel="prefetch" href="/assets/js/59.a05e2b0c.js"><link rel="prefetch" href="/assets/js/6.6aa986f5.js"><link rel="prefetch" href="/assets/js/60.7d6e698d.js"><link rel="prefetch" href="/assets/js/61.d1952570.js"><link rel="prefetch" href="/assets/js/62.a15b1cb5.js"><link rel="prefetch" href="/assets/js/63.69030ee5.js"><link rel="prefetch" href="/assets/js/64.a60b63a8.js"><link rel="prefetch" href="/assets/js/65.c1986cb9.js"><link rel="prefetch" href="/assets/js/66.e5747c76.js"><link rel="prefetch" href="/assets/js/67.c7de5e6a.js"><link rel="prefetch" href="/assets/js/68.96f4e3c6.js"><link rel="prefetch" href="/assets/js/69.db66370e.js"><link rel="prefetch" href="/assets/js/7.1fb8aaeb.js"><link rel="prefetch" href="/assets/js/70.8962d544.js"><link rel="prefetch" href="/assets/js/71.695bacdf.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.7bd035a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.png" alt="流程引擎原理与实践" class="logo"> <span class="site-name can-hide">流程引擎原理与实践</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/1-引言.html" class="nav-link">
  1 引言
</a></li><li class="dropdown-item"><!----> <a href="/2-概念.html" class="nav-link">
  2 概念
</a></li><li class="dropdown-item"><!----> <a href="/3-流程建模和解析.html" class="nav-link">
  3 流程建模和解析
</a></li><li class="dropdown-item"><!----> <a href="/4-流程引擎的核心组件.html" class="nav-link">
  4 流程引擎的核心组件
</a></li><li class="dropdown-item"><!----> <a href="/5-事件驱动机制.html" class="nav-link">
  5 事件驱动机制
</a></li><li class="dropdown-item"><!----> <a href="/6-核心表结构与接口设计.html" class="nav-link">
  6 核心表结构与接口设计
</a></li><li class="dropdown-item"><!----> <a href="/7-权限系统设计.html" class="nav-link">
  7 权限系统设计
</a></li><li class="dropdown-item"><!----> <a href="/8-分布式Crontab任务调度.html" class="nav-link">
  8 分布式Crontab任务调度
</a></li><li class="dropdown-item"><!----> <a href="/9-流程分析.html" class="nav-link">
  9 流程分析
</a></li><li class="dropdown-item"><!----> <a href="/10-云原生工作流.html" class="nav-link">
  10 云原生工作流
</a></li><li class="dropdown-item"><!----> <a href="/11-多引擎分布式系统实现.html" class="nav-link">
  11 多引擎分布式系统实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="帮助" class="dropdown-title"><span class="title">帮助</span> <span class="arrow down"></span></button> <button type="button" aria-label="帮助" class="mobile-dropdown-title"><span class="title">帮助</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about.html" class="nav-link">
  关于
</a></li><li class="dropdown-item"><!----> <a href="/sponsor.html" class="nav-link">
  打赏赞助
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/guanchao/workflow-engine-book" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/1-引言.html" class="nav-link">
  1 引言
</a></li><li class="dropdown-item"><!----> <a href="/2-概念.html" class="nav-link">
  2 概念
</a></li><li class="dropdown-item"><!----> <a href="/3-流程建模和解析.html" class="nav-link">
  3 流程建模和解析
</a></li><li class="dropdown-item"><!----> <a href="/4-流程引擎的核心组件.html" class="nav-link">
  4 流程引擎的核心组件
</a></li><li class="dropdown-item"><!----> <a href="/5-事件驱动机制.html" class="nav-link">
  5 事件驱动机制
</a></li><li class="dropdown-item"><!----> <a href="/6-核心表结构与接口设计.html" class="nav-link">
  6 核心表结构与接口设计
</a></li><li class="dropdown-item"><!----> <a href="/7-权限系统设计.html" class="nav-link">
  7 权限系统设计
</a></li><li class="dropdown-item"><!----> <a href="/8-分布式Crontab任务调度.html" class="nav-link">
  8 分布式Crontab任务调度
</a></li><li class="dropdown-item"><!----> <a href="/9-流程分析.html" class="nav-link">
  9 流程分析
</a></li><li class="dropdown-item"><!----> <a href="/10-云原生工作流.html" class="nav-link">
  10 云原生工作流
</a></li><li class="dropdown-item"><!----> <a href="/11-多引擎分布式系统实现.html" class="nav-link">
  11 多引擎分布式系统实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="帮助" class="dropdown-title"><span class="title">帮助</span> <span class="arrow down"></span></button> <button type="button" aria-label="帮助" class="mobile-dropdown-title"><span class="title">帮助</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about.html" class="nav-link">
  关于
</a></li><li class="dropdown-item"><!----> <a href="/sponsor.html" class="nav-link">
  打赏赞助
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/guanchao/workflow-engine-book" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第一部份：流程引擎基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>第二部份：流程引擎实现</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>4 流程引擎的核心组件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/4.1-WFMC工作流参考模型.html" class="sidebar-link">4.1 WFMC工作流参考模型</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>4.2 任务调度机制</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/4.2.1-DAG调度算法原理与实践.html" class="sidebar-link">4.2.1 DAG调度算法原理与实践</a></li><li><a href="/4.2.2-开源Airflow DAG调度算法剖析.html" class="active sidebar-link">4.2.2 开源Airflow DAG调度算法剖析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#核心概念" class="sidebar-link">核心概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#部署架构" class="sidebar-link">部署架构</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#dag" class="sidebar-link">DAG</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#dagrun" class="sidebar-link">DagRun</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#task" class="sidebar-link">Task</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#taskinstance" class="sidebar-link">TaskInstance</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#operators" class="sidebar-link">Operators</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#sensors" class="sidebar-link">Sensors</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#scheduler" class="sidebar-link">Scheduler</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#executor" class="sidebar-link">Executor</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#workers" class="sidebar-link">Workers</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#xcoms" class="sidebar-link">XComs</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#variables" class="sidebar-link">Variables</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#metadata-database" class="sidebar-link">Metadata Database</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#web-server" class="sidebar-link">Web Server</a></li></ul></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#核心类和方法" class="sidebar-link">核心类和方法</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#核心调度流程" class="sidebar-link">核心调度流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#_1、启动scheduler调度器" class="sidebar-link">1、启动Scheduler调度器</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#_2、dag定义和任务依赖定义" class="sidebar-link">2、DAG定义和任务依赖定义</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#_3、dag解析" class="sidebar-link">3、DAG解析</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#_5、dag调度" class="sidebar-link">5、DAG调度</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#_6、dagrun实例创建" class="sidebar-link">6、DAGRun实例创建</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#_7、dagrun任务实例调度" class="sidebar-link">7、DagRun任务实例调度</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#_8、dagrun任务实例入队列" class="sidebar-link">8、DagRun任务实例入队列</a></li><li class="sidebar-sub-header"><a href="/4.2.2-开源Airflow DAG调度算法剖析.html#_9、dagrun任务实例执行" class="sidebar-link">9、DagRun任务实例执行</a></li></ul></li></ul></li><li><a href="/4.2.3-FSM调度算法原理与实践.html" class="sidebar-link">4.2.3 FSM调度算法原理与实践</a></li><li><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html" class="sidebar-link">4.2.4 开源OSWorkflow FSM调度算法剖析</a></li><li><a href="/4.2.5-Petri网调度算法原理与实践.html" class="sidebar-link">4.2.5 Petri网调度算法原理与实践</a></li><li><a href="/4.2.6-开源YAWL Petri网调度算法剖析.html" class="sidebar-link">4.2.6 开源YAWL Petri网调度算法剖析</a></li></ul></section></li><li><a href="/4.3-工作流模式-控制流模式.html" class="sidebar-link">4.3 工作流模式-控制流模式</a></li><li><a href="/4.4-资源调度机制-资源模式.html" class="sidebar-link">4.4 资源调度机制-资源模式</a></li><li><a href="/4.5-数据管理机制-数据模式.html" class="sidebar-link">4.5 数据管理机制-数据模式</a></li><li><a href="/4.6-异常处理机制-异常处理模式.html" class="sidebar-link">4.6 异常处理机制-异常处理模式</a></li><li><a href="/4.7-引擎执行模式.html" class="sidebar-link">4.7 引擎执行模式</a></li></ul></section></li><li><a href="/5-事件驱动机制.html" class="sidebar-link">5 事件驱动机制</a></li><li><a href="/6-核心表结构与接口设计.html" class="sidebar-link">6 核心表结构与接口设计</a></li><li><a href="/7-权限系统设计.html" class="sidebar-link">7 权限系统设计</a></li><li><a href="/8-分布式Crontab任务调度.html" class="sidebar-link">8 分布式Crontab任务调度</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第三部份：流程引擎进阶</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="核心概念"><a href="#核心概念" class="header-anchor">#</a> 核心概念</h2> <h3 id="部署架构"><a href="#部署架构" class="header-anchor">#</a> 部署架构</h3> <p>下面是 Airflow 的分布式部署架构，其中 Airflow 的组件分布在多台机器上，并引入了各种用户角色 - Deployment Manager、DAG Author、Operations User。</p> <p>在分布式部署的情况下，Airflow考虑了组件的安全性。 其中，Webserver无法直接访问 DAG 文件。 UI 的“代码”选项卡中的代码是从Metadata DB中读取的。网络服务器无法执行 DAG Author提交的任何代码。它只能执行由部署管理器作为安装包或插件安装的代码。Operations User只能访问 UI，并且只能触发 DAG 和任务，但无法创作 DAG。</p> <p>DAG 文件需要在使用它们的所有组件（scheduler、trigger和workers）之间进行同步。 DAG Processor组件是独立的，该组件允许将Scheduler与访问 DAG 文件分开。如果部署重点是解析的任务之间的隔离，那么这是合适的。虽然 Airflow 尚不支持完整的多租户功能，但它可用于确保 DAG Author提供的代码永远不会在Scheduler的上下文中执行。</p> <img src="https://airflow.apache.org/docs/apache-airflow/stable/_images/diagram_dag_processor_airflow_architecture.png" style="zoom:67%;"> <h3 id="dag"><a href="#dag" class="header-anchor">#</a> DAG</h3> <p>Airflow中的工作流由一组有向无环图DAG（Directed Acyclic Graph）表示，其中节点表示任务（Task），边表示任务之间的依赖关系。DAG定义了任务的执行顺序和依赖关系，以确保工作流程按照预期的逻辑执行。如上图所示，这些DAG定义存储在DAG目录中，Airflow会定期去扫描。</p> <img src="https://airflow.apache.org/docs/apache-airflow/stable/_images/basic-dag.png" style="zoom:67%;"> <p>如下是一个简单的DAG定义，DAG定义本身就是一个python文件。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>dummy_operator <span class="token keyword">import</span> DummyOperator

<span class="token comment"># 定义DAG参数</span>
dag_args <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'owner'</span><span class="token punctuation">:</span> <span class="token string">'airflow'</span><span class="token punctuation">,</span>
    <span class="token string">'start_date'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'retries'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">'retry_delay'</span><span class="token punctuation">:</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment"># 创建DAG实例</span>
dag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">'my_example_dag'</span><span class="token punctuation">,</span>
    default_args<span class="token operator">=</span>dag_args<span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">'A simple example DAG'</span><span class="token punctuation">,</span>
    schedule_interval<span class="token operator">=</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 定义任务</span>
task_1 <span class="token operator">=</span> DummyOperator<span class="token punctuation">(</span>
    task_id<span class="token operator">=</span><span class="token string">'task_1'</span><span class="token punctuation">,</span>
    dag<span class="token operator">=</span>dag<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

task_2 <span class="token operator">=</span> DummyOperator<span class="token punctuation">(</span>
    task_id<span class="token operator">=</span><span class="token string">'task_2'</span><span class="token punctuation">,</span>
    dag<span class="token operator">=</span>dag<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 定义任务依赖关系(指定执行顺序：先task_1，再task_2)</span>
task_1 <span class="token operator">&gt;&gt;</span> task_2
</code></pre></div><p>如下是airflow中dag的表定义：</p> <img src="/assets/img/4 airflow-table-dag.fd0c090f.png" alt="image-20231107200240499" style="zoom:50%;"> <h3 id="dagrun"><a href="#dagrun" class="header-anchor">#</a> DagRun</h3> <p>Dag的一次运行，即工作流实例。如下所示是Dag Run的表定义，可以看到其中包含了Dag主键ID。</p> <img src="/assets/img/4 airflow-table-dagrun.7808f388.png" alt="image-20231107200316323" style="zoom:50%;"> <h3 id="task"><a href="#task" class="header-anchor">#</a> Task</h3> <p>Task任务是Airflow的Dag定义中的基本执行单元，相当于工作流中的一个节点。任务被排列成 DAG，然后在它们之间设置上游和下游依赖关系，以表达它们应该运行的顺序。</p> <p>Task任务分为三种基本类型：</p> <ul><li><p>Operators：预定义任务模板，可以将它们快速串联起来以构建 DAG 的大部分。</p></li> <li><p>Sensors：是操作员的一个特殊子类，完全用于等待外部事件发生。</p></li> <li><p>TaskFlow：修饰的@task，它是一个打包为Task的自定义Python函数。</p></li></ul> <p>在内部，这些实际上都是 Airflow BaseOperator 的子类，Task和Operator的概念在某种程度上可以互换，但将它们视为单独的概念很有用 - 本质上，Operators和Sensors是模板，当您在 DAG 文件中调用其中一个时，你正在做一个任务。</p> <p>在Dag中不同Task之间一般有先后的顺序关系。例如下面的Dag中包含了两个Task。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">with</span> DAG<span class="token punctuation">(</span><span class="token string">'my_example_dag'</span><span class="token punctuation">,</span> start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    task_1 <span class="token operator">=</span> DummyOperator<span class="token punctuation">(</span><span class="token string">'task_1'</span><span class="token punctuation">)</span>
    task_2 <span class="token operator">=</span> DummyOperator<span class="token punctuation">(</span><span class="token string">'task_2'</span><span class="token punctuation">)</span>
    task_1 <span class="token operator">&gt;&gt;</span> task_2
</code></pre></div><p>除了用位操作符表示顺序关系，也可以通过<code>set_upstream</code>和<code>set_downstream</code>方法：</p> <div class="language-python extra-class"><pre class="language-python"><code>task_1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>task_2<span class="token punctuation">)</span>
</code></pre></div><h3 id="taskinstance"><a href="#taskinstance" class="header-anchor">#</a> TaskInstance</h3> <p>TaskInstance是DagRun下面的一个任务实例，表示某个Task任务的一次运行。对于每个DagRun实例，Operator都将转换成对应的TaskInstance。</p> <p>如下图是TaskInstance的表定义：</p> <img src="/assets/img/4 airflow-table-task_instance.4dab27ff.png" alt="image-20231107200638502" style="zoom:50%;"> <p>TaskInstance有如下一些状态：</p> <ul><li><p>none: 任务尚未排队执行（其依赖项尚未满足）</p></li> <li><p>scheduled: 调度程序已确定任务的依赖项已满足，应该运行</p></li> <li><p>queued: 任务已分配给执行器，正在等待worker</p></li> <li><p>running: 任务正在worker上运行（或在本地/同步执行器上运行）</p></li> <li><p>success: 任务已成功运行而没有错误</p></li> <li><p>restarting: 任务在运行时被外部请求重新启动</p></li> <li><p>failed: 任务在执行过程中出现错误，无法运行</p></li> <li><p>skipped: 任务被跳过。</p></li> <li><p>upstream_failed: 上游任务失败，触发规则表示需要它</p></li> <li><p>up_for_retry: 任务失败，但还有重试尝试，并将被重新安排。</p></li> <li><p>up_for_reschedule: 任务是处于重新安排模式的Sensor</p></li> <li><p>deferred: 任务已推迟到触发器</p></li> <li><p>removed: 由于运行开始，任务已从DAG中消失</p></li></ul> <p>其状态流转如下图所示：</p> <img src="https://airflow.apache.org/docs/apache-airflow/stable/_images/task_lifecycle_diagram.png" style="zoom:67%;"> <h3 id="operators"><a href="#operators" class="header-anchor">#</a> Operators</h3> <p>Airflow提供了一组预定义的操作符（Operator），用于创建和执行任务。操作符是Python类，可以用于实例化任务并定义任务的执行逻辑。其中内置了一下一些常用的Operator：</p> <ul><li><code>BashOperator</code>- 执行bash命令</li> <li><code>PythonOperator</code>- 调用python函数</li> <li><code>EmailOperator</code> - 发送邮件</li></ul> <img src="/assets/img/4.2.2 operator.1ffae418.png" alt="image-20240322090843274" style="zoom:50%;"> <p>如下在DAG中使用预定义的Operator声明Task任务：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">with</span> DAG<span class="token punctuation">(</span><span class="token string">&quot;my-dag&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    ping <span class="token operator">=</span> SimpleHttpOperator<span class="token punctuation">(</span>endpoint<span class="token operator">=</span><span class="token string">&quot;http://example.com/update/&quot;</span><span class="token punctuation">)</span>
    email <span class="token operator">=</span> EmailOperator<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&quot;admin@example.com&quot;</span><span class="token punctuation">,</span> subject<span class="token operator">=</span><span class="token string">&quot;Update complete&quot;</span><span class="token punctuation">)</span>

    ping <span class="token operator">&gt;&gt;</span> email
</code></pre></div><h3 id="sensors"><a href="#sensors" class="header-anchor">#</a> Sensors</h3> <p>传感器是一种特殊类型的Operator，旨在完成一件事 - 等待某些事情发生。它可以是基于时间的，或者等待文件或外部事件，但它们所做的只是等到事情发生，然后成功，以便下游任务可以运行。</p> <p>其中内置了一些常用的Sensor，例如：BashSensor、PythonSensor、DateTimeSensor等。</p> <img src="/assets/img/4.2.2 sensors.d6fa8663.png" alt="image-20240322090701122" style="zoom:50%;"> <h3 id="scheduler"><a href="#scheduler" class="header-anchor">#</a> Scheduler</h3> <p>Airflow中的调度器（Scheduler）负责根据DAG的定义和调度时间，触发任务的执行。调度器会周期性地检查DAG，并在满足调度条件时创建任务实例（Task Instance）并将其提交给执行器（Executor）。从下图的架构可以知道调度器是Airflow工作流引擎的核心组件。</p> <img src="/assets/img/4.2 airflow架构.ff727812.png" alt="image-20240131092519679" style="zoom:50%;"> <h3 id="executor"><a href="#executor" class="header-anchor">#</a> Executor</h3> <p>执行器（Executor）负责执行任务实例（Task Instance）。Airflow支持多种执行器，如LocalExecutor（本地执行器）、CeleryExecutor（基于Celery的分布式执行器）、KubernetesExecutor（基于Kubernetes的执行器）等。执行器可以根据任务的需求分配资源，并处理任务的并发和故障恢复。</p> <p>可以通过下面的命令查看当前使用的Executor类型：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>airflow config get-value core executor
SequentialExecutor
</code></pre></div><h3 id="workers"><a href="#workers" class="header-anchor">#</a> Workers</h3> <p>实际执行任务的进程，由Executor确定。</p> <h3 id="xcoms"><a href="#xcoms" class="header-anchor">#</a> XComs</h3> <p>XCom（跨任务通信）是一种机制，允许任务之间交换数据。XCom是存储在Airflow元数据数据库中的键值对，每个XCom都与一个特定的任务实例和执行日期相关联。任务可以通过XCom将数据推送（push）到数据库中，以便其他任务可以在稍后拉取（pull）这些数据。</p> <p>以下是一个简单的示例，说明了如何在Airflow任务之间使用XCom传递数据：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>python_operator <span class="token keyword">import</span> PythonOperator
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">def</span> <span class="token function">push_function</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    value_to_push <span class="token operator">=</span> <span class="token string">&quot;Hello, XCom!&quot;</span>
    kwargs<span class="token punctuation">[</span><span class="token string">'ti'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xcom_push<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">'my_key'</span><span class="token punctuation">,</span> value<span class="token operator">=</span>value_to_push<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">pull_function</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    value_to_pull <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">'ti'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xcom_pull<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">'my_key'</span><span class="token punctuation">,</span> task_ids<span class="token operator">=</span><span class="token string">'push_task'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Pulled value: </span><span class="token interpolation"><span class="token punctuation">{</span>value_to_pull<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>dag_id<span class="token operator">=</span><span class="token string">'xcom_example_dag'</span><span class="token punctuation">,</span> start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schedule_interval<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    push_task <span class="token operator">=</span> PythonOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">'push_task'</span><span class="token punctuation">,</span>
        python_callable<span class="token operator">=</span>push_function<span class="token punctuation">,</span>
        provide_context<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span>

    pull_task <span class="token operator">=</span> PythonOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">'pull_task'</span><span class="token punctuation">,</span>
        python_callable<span class="token operator">=</span>pull_function<span class="token punctuation">,</span>
        provide_context<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span>

    push_task <span class="token operator">&gt;&gt;</span> pull_task
</code></pre></div><p>在这个示例中，我们创建了一个简单的DAG，包含两个<code>PythonOperator</code>任务：<code>push_task</code>和<code>pull_task</code>。<code>push_task</code>任务调用<code>push_function</code>，将一个字符串值（&quot;Hello, XCom!&quot;）推送到XCom中，键名为<code>my_key</code>。<code>pull_task</code>任务调用<code>pull_function</code>，从XCom中拉取键名为<code>my_key</code>的值，并将其打印出来。</p> <p>注意，在这个示例中，我们将<code>provide_context=True</code>设置为任务的参数，以便将任务实例（<code>ti</code>）和其他上下文信息传递给<code>push_function</code>和<code>pull_function</code>。</p> <p>XCom 与Variables相对，主要区别在于 XCom 是针对每个任务实例的，专为 DAG 运行中的通信而设计，而 Variables 是全局的，专为整体配置和价值共享而设计。</p> <h3 id="variables"><a href="#variables" class="header-anchor">#</a> Variables</h3> <p><code>Variable</code>是一种在DAG中存储和管理全局配置信息的机制。<code>Variable</code>允许你在Airflow元数据数据库中存储键值对，这些键值对可以在整个DAG中的任务之间共享。使用<code>Variable</code>可以帮助你将配置信息与任务代码分离，从而使DAG更易于维护和扩展。</p> <p>以下是一个简单的示例，说明了如何在Airflow任务中使用<code>Variable</code>：</p> <p><img src="https://airflow.apache.org/docs/apache-airflow/stable/_images/variable_hidden.png" alt=""></p> <p>首先，在Airflow Web UI的Admin菜单中，进入Variables页面。点击“创建”按钮，创建一个新的变量，例如键名为<code>example_key</code>，值为<code>example_value</code>。</p> <p>然后，在DAG中使用这个变量：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>python_operator <span class="token keyword">import</span> PythonOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models <span class="token keyword">import</span> Variable
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">def</span> <span class="token function">print_variable</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    example_value <span class="token operator">=</span> Variable<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;example_key&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Variable 'example_key': </span><span class="token interpolation"><span class="token punctuation">{</span>example_value<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>dag_id<span class="token operator">=</span><span class="token string">'variable_example_dag'</span><span class="token punctuation">,</span> start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schedule_interval<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    print_variable_task <span class="token operator">=</span> PythonOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">'print_variable_task'</span><span class="token punctuation">,</span>
        python_callable<span class="token operator">=</span>print_variable<span class="token punctuation">,</span>
        provide_context<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>在这个示例中，我们创建了一个简单的DAG，包含一个<code>PythonOperator</code>任务：<code>print_variable_task</code>。这个任务调用<code>print_variable</code>函数，从<code>Variable</code>中获取键名为<code>example_key</code>的值，并将其打印出来。</p> <p>注意，我们使用<code>Variable.get()</code>方法从Airflow的变量中获取值。这个方法接受一个键名作为参数，并返回与该键名关联的值。</p> <h3 id="metadata-database"><a href="#metadata-database" class="header-anchor">#</a> Metadata Database</h3> <p>Airflow使用元数据数据库（Metadata Database）来存储DAG的定义、任务实例的状态、调度历史等信息。元数据数据库可以是关系型数据库（如PostgreSQL、MySQL等）或其他兼容的存储系统。通过元数据数据库，Airflow可以实现对任务实例的持久化存储和状态管理。</p> <p>注意：DAG的持久化存储是从2.x版本开始。</p> <p><img src="https://airflow.apache.org/docs/apache-airflow/stable/_images/dag_serialization.png" alt=""></p> <h3 id="web-server"><a href="#web-server" class="header-anchor">#</a> Web Server</h3> <p>Airflow提供了一个Web服务器，用于展示工作流程的状态、任务实例的执行情况、任务日志等信息。用户可以通过Web界面监控和管理工作流程，以及手动触发任务、重试失败的任务等。</p> <img src="https://airflow.apache.org/docs/apache-airflow/stable/_images/dags.png" style="zoom:33%;"> <h2 id="核心类和方法"><a href="#核心类和方法" class="header-anchor">#</a> 核心类和方法</h2> <p>Apache Airflow是一个用于编排、调度和监控复杂数据管道的工具。其核心概念是基于Directed Acyclic Graph (DAG)算法实现的。以下是一些与Airflow DAG相关的核心函数和类：</p> <ol><li><p><code>Dag</code>：定义DAG的主要类。它包含了DAG的所有基本属性，如dag_id、start_date、schedule_interval等。</p></li> <li><p><code>BaseOperator</code>：所有Airflow任务都是从这个基类派生的。这个类包含了任务的基本属性和方法，如task_id、retries、execute()等。</p> <p>这个类是抽象的，不应该被实例化。实例化从此类派生的类会导致创建一个任务对象，该对象最终成为 DAG 对象中的一个节点。同时，使用 set_upstream 或 set_downstream 方法设置任务依赖关系。例如下面几种常见的Operator：</p> <ol><li><p><code>PythonOperator</code>：用于执行Python函数的操作符。</p></li> <li><p><code>BranchOperator</code>：用于在DAG中实现条件分支的操作符。它根据提供的Python可调用对象的返回值来选择要执行的分支。</p></li> <li><p><code>SubDagOperator</code>：用于将一个子DAG嵌套到另一个DAG中的操作符。</p></li></ol></li> <li><p><code>TaskInstance</code>：表示任务实例。它包含了任务实例的状态、执行时间、重试次数等信息。</p></li> <li><p><code>DagBag</code>：用于存储和管理所有DAG的容器。它提供了一些方法来查找和操作DAG。</p></li> <li><p><code>DagRun</code>：表示DAG运行的类。它包含了DAG运行的状态、执行时间、外部触发等信息。</p></li> <li><p><code>SchedulerJob</code>：负责调度和执行DAG的类。它包含了一些核心方法，如_process_dags()、_execute_task_instances()等。</p></li></ol> <h2 id="核心调度流程"><a href="#核心调度流程" class="header-anchor">#</a> 核心调度流程</h2> <p>Airflow的从DAG文件的定义，到DAG调度，以及任务的执行，其整体调度流程如下所示：</p> <img src="/assets/img/4.2.2 airflow调度流程图.28e647b0.png" alt="image-20240326202349569" style="zoom:150%;"> <p><em><strong>注意：下面所有源码基于的airflow版本是：2.x。</strong></em></p> <h3 id="_1、启动scheduler调度器"><a href="#_1、启动scheduler调度器" class="header-anchor">#</a> 1、启动Scheduler调度器</h3> <blockquote><p>main</p></blockquote> <p>在安装好python环境后，我们通过如下pip命令安装airflow</p> <div class="language-shell extra-class"><pre class="language-shell"><code>pip <span class="token function">install</span> apache-airflow

<span class="token comment"># 初始化数据库</span>
airflow db init
</code></pre></div><p>安装成功后可以看到airflow版本：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>airflow version
<span class="token number">2.7</span>.2
</code></pre></div><p>我们可以查看airflow支持的命令行参数，其中的scheduler命令就是我们需要关注的airflow调度器。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>airflow <span class="token parameter variable">-help</span>
Usage: airflow <span class="token punctuation">[</span>-h<span class="token punctuation">]</span> GROUP_OR_COMMAND <span class="token punctuation">..</span>.

Positional Arguments:
  GROUP_OR_COMMAND

    Groups
      config         View configuration
      connections    Manage connections
      dags           Manage DAGs
      db             Database operations
      <span class="token function">jobs</span>           Manage <span class="token function">jobs</span>
      pools          Manage pools
      providers      Display providers
      roles          Manage roles
      tasks          Manage tasks
      <span class="token function">users</span>          Manage <span class="token function">users</span>
      variables      Manage variables

    Commands:
      cheat-sheet    Display cheat sheet
      dag-processor  Start a standalone Dag Processor instance
      info           Show information about current Airflow and environment
      kerberos       Start a kerberos ticket renewer
      plugins        Dump information about loaded plugins
      rotate-fernet-key
                     Rotate encrypted connection credentials and variables
      scheduler      Start a scheduler instance
      standalone     Run an all-in-one copy of Airflow
      sync-perm      Update permissions <span class="token keyword">for</span> existing roles and optionally DAGs
      triggerer      Start a triggerer instance
      version        Show the version
      webserver      Start a Airflow webserver instance

Options:
  -h, <span class="token parameter variable">--help</span>         show this <span class="token builtin class-name">help</span> message and <span class="token builtin class-name">exit</span>

airflow <span class="token builtin class-name">command</span> error: argument -h/--help: ignored explicit argument <span class="token string">'elp'</span>, see <span class="token builtin class-name">help</span> above.
</code></pre></div><p><em>备注：如果想要快速方便去调试观察Airflow的运行流程，可以使用上面的<code>airflow standalone</code>命令一键部署所有服务。</em></p> <p>运行webserver服务，成功运行后显示如下日志，默认是8080端口。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>airflow webserver
<span class="token punctuation">[</span><span class="token number">2023</span>-11-02T12:51:52.192+0800<span class="token punctuation">]</span> <span class="token punctuation">{</span>configuration.py:2067<span class="token punctuation">}</span> INFO - Creating new FAB webserver config <span class="token function">file</span> in: /Users/shuwoom/Desktop/airflow/webserver_config.py
  ____________       _____________
 ____    <span class="token operator">|</span>__<span class="token punctuation">(</span> <span class="token punctuation">)</span>_________  __/__  /________      __
____  /<span class="token operator">|</span> <span class="token operator">|</span>_  /__  ___/_  /_ __  /_  __ <span class="token punctuation">\</span>_ <span class="token operator">|</span> /<span class="token operator">|</span> / /
___  ___ <span class="token operator">|</span>  / _  /   _  __/ _  / / /_/ /_ <span class="token operator">|</span>/ <span class="token operator">|</span>/ /
 _/_/  <span class="token operator">|</span>_/_/  /_/    /_/    /_/  <span class="token punctuation">\</span>____/____/<span class="token operator">|</span>__/
Running the Gunicorn Server with:
Workers: <span class="token number">4</span> <span class="token function">sync</span>
Host: <span class="token number">0.0</span>.0.0:8080
Timeout: <span class="token number">120</span>
Logfiles: - -
Access Logformat:
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>创建一个管理员账号：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>airflow <span class="token function">users</span> create <span class="token parameter variable">--username</span> airflow <span class="token parameter variable">--role</span> Admin  <span class="token parameter variable">--email</span> test@qq.com <span class="token parameter variable">--firstname</span> admin <span class="token parameter variable">--lastname</span> admin  <span class="token parameter variable">--password</span> airflow
</code></pre></div><p>访问上述地址，就进入到airflow的web管理页面。</p> <img src="/assets/img/3 airflow-webserver.6ab26862.png" alt="image-20231102125855751" style="zoom:50%;"> <p>通过如下命令，我们可以运行scheduler调度器，运行成功后打印如下日志。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>airflow scheduler 

<span class="token punctuation">[</span><span class="token number">2023</span>-11-02T13:00:46.811+0800<span class="token punctuation">]</span> <span class="token punctuation">{</span>migration.py:213<span class="token punctuation">}</span> INFO - Context impl SQLiteImpl.
<span class="token punctuation">[</span><span class="token number">2023</span>-11-02T13:00:46.812+0800<span class="token punctuation">]</span> <span class="token punctuation">{</span>migration.py:216<span class="token punctuation">}</span> INFO - Will assume non-transactional DDL.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Context impl SQLiteImpl.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Will assume non-transactional DDL.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Running stamp_revision  -<span class="token operator">&gt;</span> 405de8318b3a
WARNI <span class="token punctuation">[</span>airflow.models.crypto<span class="token punctuation">]</span> empty cryptography key - values will not be stored encrypted.
DB initialize <span class="token keyword">done</span>
  ____________       _____________
 ____    <span class="token operator">|</span>__<span class="token punctuation">(</span> <span class="token punctuation">)</span>_________  __/__  /________      __
____  /<span class="token operator">|</span> <span class="token operator">|</span>_  /__  ___/_  /_ __  /_  __ <span class="token punctuation">\</span>_ <span class="token operator">|</span> /<span class="token operator">|</span> / /
___  ___ <span class="token operator">|</span>  / _  /   _  __/ _  / / /_/ /_ <span class="token operator">|</span>/ <span class="token operator">|</span>/ /
 _/_/  <span class="token operator">|</span>_/_/  /_/    /_/    /_/  <span class="token punctuation">\</span>____/____/<span class="token operator">|</span>__/
<span class="token punctuation">[</span><span class="token number">2023</span>-11-02 <span class="token number">13</span>:00:47 +0800<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55179</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">21.2</span>.0
<span class="token punctuation">[</span><span class="token number">2023</span>-11-02 <span class="token number">13</span>:00:47 +0800<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55179</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://<span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8793 <span class="token punctuation">(</span><span class="token number">55179</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2023</span>-11-02 <span class="token number">13</span>:00:47 +0800<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55179</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2023</span>-11-02 <span class="token number">13</span>:00:47 +0800<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55181</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">55181</span>
</code></pre></div><p>而airflow命令行参数的入口正是下面的main函数，通过传递scheduler命令启动airflow的调度器服务。</p> <h4 id="main入口"><a href="#main入口" class="header-anchor">#</a> main入口</h4> <p><code>main</code> 函数的主要目的是解析命令行参数，并根据解析后的参数执行相应的 Airflow 命令。在执行命令之前，它还确保了默认配置文件已经写入磁盘。</p> <p>以下是该函数的功能说明：</p> <p>文件路径：airflow/_<em>main</em>_.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1.从 Airflow 配置文件中获取配置对象 conf。</span>
    conf <span class="token operator">=</span> configuration<span class="token punctuation">.</span>conf
    
    <span class="token comment"># 2.如果配置文件中的 core.security 设置为 &quot;kerberos&quot;，则从配置文件中读取 Kerberos 相关的设置（如 ccache 和 keytab），并将它们设置为环境变量。</span>
    <span class="token keyword">if</span> conf<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;core&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;security&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;kerberos&quot;</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&quot;KRB5CCNAME&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> conf<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;kerberos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ccache&quot;</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&quot;KRB5_KTNAME&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> conf<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;kerberos&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;keytab&quot;</span><span class="token punctuation">)</span>
        
    <span class="token comment"># 3.调用 cli_parser.get_parser() 函数创建一个命令行参数解析器。</span>
    parser <span class="token operator">=</span> cli_parser<span class="token punctuation">.</span>get_parser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 4.使用 argcomplete.autocomplete(parser) 为解析器启用自动补全功能。</span>
    argcomplete<span class="token punctuation">.</span>autocomplete<span class="token punctuation">(</span>parser<span class="token punctuation">)</span>
    
    <span class="token comment"># 5.解析命令行参数，并将结果存储在 args 变量中。</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    
    <span class="token comment"># 6.如果子命令不是 &quot;lazy_loaded&quot; 或 &quot;version&quot;，则执行以下操作：    </span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>subcommand <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&quot;lazy_loaded&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;version&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># 7.调用 write_default_airflow_configuration_if_needed 函数，确保在运行任何可能需要默认配置的命令之前，将默认配置文件写入磁盘（如果需要的话）。</span>
        <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>configuration <span class="token keyword">import</span> write_default_airflow_configuration_if_needed
        conf <span class="token operator">=</span> write_default_airflow_configuration_if_needed<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 8.如果子命令是 &quot;webserver&quot;、&quot;internal-api&quot; 或 &quot;worker&quot;，则调用 write_webserver_configuration_if_needed 函数，确保在运行这些命令之前，将 Web 服务器的默认配置文件写入磁盘（如果需要的话）。</span>
        <span class="token keyword">if</span> args<span class="token punctuation">.</span>subcommand <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&quot;webserver&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;internal-api&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;worker&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            write_webserver_configuration_if_needed<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    args<span class="token punctuation">.</span>func<span class="token punctuation">(</span>args<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>这里会加载Airflow配置文件，Airflow 配置文件（默认为 <code>airflow.cfg</code>）包含了许多配置参数，这些参数被分为不同的节（sections）。以下是一些主要的节和它们的部分参数：</p> <p><code>[core]</code>：核心配置参数。</p> <ul><li><code>dags_folder</code>：DAG 文件的存放路径。</li> <li><code>load_examples</code>：是否加载示例 DAG。</li> <li><code>executor</code>：使用的执行器类型，如 <code>SequentialExecutor</code>、<code>LocalExecutor</code> 或 <code>CeleryExecutor</code>，默认是<code>SequentialExecutor</code>。</li> <li><code>sql_alchemy_conn</code>：用于连接元数据库的 SQL Alchemy 连接字符串。</li> <li><code>parallelism</code>：允许的最大并行任务数。</li></ul> <p>接下来展开分析get_parser函数。</p> <h4 id="get-parser函数"><a href="#get-parser函数" class="header-anchor">#</a> get_parser函数</h4> <p><code>get_parser</code> 函数的主要目的是创建一个命令行参数解析器，用于解析 Airflow 命令行工具中的命令和参数。</p> <p>以下是该函数的功能说明：</p> <p>文件路径：airflow/airflow/cli/cli_parser.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 这里的core_commands包含了scheduler命令，见下面介绍</span>
airflow_commands <span class="token operator">=</span> core_commands<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
ALL_COMMANDS_DICT<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> CLICommand<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>sp<span class="token punctuation">.</span>name<span class="token punctuation">:</span> sp <span class="token keyword">for</span> sp <span class="token keyword">in</span> airflow_commands<span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">get_parser</span><span class="token punctuation">(</span>dag_parser<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Create and returns command line argument parser.&quot;&quot;&quot;</span>
    <span class="token comment"># 1.创建一个名为 airflow 的 argparse.ArgumentParser 实例，使用自定义的帮助解析器 DefaultHelpParser 和格式化类 AirflowHelpFormatter。</span>
    parser <span class="token operator">=</span> DefaultHelpParser<span class="token punctuation">(</span>prog<span class="token operator">=</span><span class="token string">&quot;airflow&quot;</span><span class="token punctuation">,</span> formatter_class<span class="token operator">=</span>AirflowHelpFormatter<span class="token punctuation">)</span>
    
    <span class="token comment"># 2.为解析器添加子解析器（subparsers），用于处理子命令（如 airflow scheduler 中的 scheduler）。设置子解析器的目标属性为 &quot;subcommand&quot;，元变量为 &quot;GROUP_OR_COMMAND&quot;。这样，在解析命令行参数时，子命令将被存储在 args.subcommand 属性中。</span>
    subparsers <span class="token operator">=</span> parser<span class="token punctuation">.</span>add_subparsers<span class="token punctuation">(</span>dest<span class="token operator">=</span><span class="token string">&quot;subcommand&quot;</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">&quot;GROUP_OR_COMMAND&quot;</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3.设置 subparsers.required 为 True，表示必须提供一个子命令。</span>
    subparsers<span class="token punctuation">.</span>required <span class="token operator">=</span> <span class="token boolean">True</span>
    
    <span class="token comment"># 4.根据 dag_parser 参数的值，选择要添加的命令字典。如果 dag_parser 为 True，则使用 DAG_CLI_DICT，否则使用 ALL_COMMANDS_DICT。</span>
    command_dict <span class="token operator">=</span> DAG_CLI_DICT <span class="token keyword">if</span> dag_parser <span class="token keyword">else</span> ALL_COMMANDS_DICT
    <span class="token keyword">for</span> _<span class="token punctuation">,</span> sub <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>command_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 5.遍历命令字典，将每个命令添加到子解析器中。这是通过调用 _add_command 函数完成的，它将命令的名称、帮助文本、参数等信息添加到子解析器中。</span>
        _add_command<span class="token punctuation">(</span>subparsers<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>
    <span class="token comment"># 6.返回创建好的解析器实例。</span>
    <span class="token keyword">return</span> parser
</code></pre></div><p>接下来展开分析scheduler命令。</p> <h4 id="scheduler命令"><a href="#scheduler命令" class="header-anchor">#</a> scheduler命令</h4> <p>下面这段代码定义了一个名为 <code>core_commands</code> 的列表，其中包含了 Airflow 命令行工具的核心命令。这些命令是通过 <code>CLICommand</code> 类的实例表示的。在这个例子中，我们重点关注 <code>scheduler</code> 命令。</p> <p><code>scheduler</code> 命令的定义如下：</p> <ul><li><code>name</code>: 命令的名称，这里为 &quot;scheduler&quot;。</li> <li><code>help</code>: 命令的帮助文本，用于描述命令的功能。这里为 &quot;Start a scheduler instance&quot;。</li> <li><code>func</code>: 命令的实际执行函数。这里使用 <code>lazy_load_command</code> 函数导入 <code>scheduler_command.scheduler</code> 函数。<code>lazy_load_command</code> 用于在实际需要时才导入命令的执行函数，以减少启动时间。</li> <li><code>args</code>: 命令支持的命令行参数。这里包括了一系列预定义的参数，如 <code>ARG_SUBDIR</code>（DAG 子目录）、<code>ARG_NUM_RUNS</code>（调度器运行次数）等。</li> <li><code>epilog</code>: 命令的附加帮助信息，用于在命令帮助文本的末尾显示。这里包含了关于 <code>scheduler</code> 命令支持的信号（如 <code>SIGUSR2</code>）的说明。</li></ul> <p>这个列表中的其他命令也采用类似的结构进行定义。最终，这些命令将被添加到命令行参数解析器中，以便用户在运行 Airflow 命令行工具时可以使用它们。</p> <p>文件路径：airflow/airflow/cli/cli_config.py</p> <div class="language-python extra-class"><pre class="language-python"><code>core_commands<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>CLICommand<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  ActionCommand<span class="token punctuation">(</span>
          name<span class="token operator">=</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span>
          <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;Start a scheduler instance&quot;</span><span class="token punctuation">,</span>
          func<span class="token operator">=</span>lazy_load_command<span class="token punctuation">(</span><span class="token string">&quot;airflow.cli.commands.scheduler_command.scheduler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          args<span class="token operator">=</span><span class="token punctuation">(</span>
              ARG_SUBDIR<span class="token punctuation">,</span>
              ARG_NUM_RUNS<span class="token punctuation">,</span>
              ARG_DO_PICKLE<span class="token punctuation">,</span>
              ARG_PID<span class="token punctuation">,</span>
              ARG_DAEMON<span class="token punctuation">,</span>
              ARG_STDOUT<span class="token punctuation">,</span>
              ARG_STDERR<span class="token punctuation">,</span>
              ARG_LOG_FILE<span class="token punctuation">,</span>
              ARG_SKIP_SERVE_LOGS<span class="token punctuation">,</span>
              ARG_VERBOSE<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          epilog<span class="token operator">=</span><span class="token punctuation">(</span>
              <span class="token string">&quot;Signals:\n&quot;</span>
              <span class="token string">&quot;\n&quot;</span>
              <span class="token string">&quot;  - SIGUSR2: Dump a snapshot of task state being tracked by the executor.\n&quot;</span>
              <span class="token string">&quot;\n&quot;</span>
              <span class="token string">&quot;    Example:\n&quot;</span>
              <span class="token string">'        pkill -f -USR2 &quot;airflow scheduler&quot;'</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">]</span>
</code></pre></div><p>我们可以通过如下的命令开启守护进程启动scheduler服务</p> <div class="language- extra-class"><pre class="language-text"><code>airflow scheduler -D
</code></pre></div><p>接下来看看这个被调用的scheduler方法。</p> <h4 id="scheduler函数"><a href="#scheduler函数" class="header-anchor">#</a> scheduler函数</h4> <p><code>scheduler</code> 函数的主要目的是通过调用 <code>run_command_with_daemon_option</code> 函数来启动 Airflow 调度器。</p> <p>以下是该函数的功能说明：</p> <p>文件路径：airflow/airflow/cli/commands/scheduler_command.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">scheduler</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> Namespace<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Start Airflow Scheduler.&quot;&quot;&quot;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>HEADER<span class="token punctuation">)</span>
    <span class="token comment"># 启动调度器作业</span>
    run_command_with_daemon_option<span class="token punctuation">(</span>
        args<span class="token operator">=</span>args<span class="token punctuation">,</span> <span class="token comment"># 命令行参数</span>
        process_name<span class="token operator">=</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token comment"># 进程名称，设置为 &quot;scheduler&quot;</span>
        callback<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> _run_scheduler_job<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 启动调度器作业的回调函数，这里使用 _run_scheduler_job(args)</span>
        should_setup_logging<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token comment"># 是否设置日志记录，设置为 True。</span>
</code></pre></div><p>接下来展开分析_run_scheduler_job函数。</p> <h4 id="run-scheduler-job函数"><a href="#run-scheduler-job函数" class="header-anchor">#</a> _run_scheduler_job函数</h4> <p>创建SchedulerJob对象，并调用该对象的_execute方法。Airflow就是通过调用_execute方法来启动scheduler调度服务。</p> <p><code>_run_scheduler_job</code> 函数的主要目的是创建并运行一个调度器作业，启动日志服务和健康检查服务。</p> <p>以下是该函数的功能说明：</p> <p>文件路径：airflow/airflow/cli/commands/scheduler_command.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_run_scheduler_job</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token comment"># 1.创建一个 SchedulerJobRunner 实例，设置相关参数，如DAG目录（subdir）、最大运行次数（num_runs）和是否进行pickle序列化（do_pickle）。</span>
    job_runner <span class="token operator">=</span> SchedulerJobRunner<span class="token punctuation">(</span>
        job<span class="token operator">=</span>Job<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subdir<span class="token operator">=</span>process_subdir<span class="token punctuation">(</span>args<span class="token punctuation">.</span>subdir<span class="token punctuation">)</span><span class="token punctuation">,</span> num_runs<span class="token operator">=</span>args<span class="token punctuation">.</span>num_runs<span class="token punctuation">,</span> do_pickle<span class="token operator">=</span>args<span class="token punctuation">.</span>do_pickle
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 2.验证执行器与数据库的兼容性。</span>
    ExecutorLoader<span class="token punctuation">.</span>validate_database_executor_compatibility<span class="token punctuation">(</span>job_runner<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">)</span>
    
    <span class="token comment"># 3.强制使用直接访问数据库的方式。</span>
    InternalApiConfig<span class="token punctuation">.</span>force_database_direct_access<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 4.从配置文件中获取调度器的健康检查设置（enable_health_check）。</span>
    enable_health_check <span class="token operator">=</span> conf<span class="token punctuation">.</span>getboolean<span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ENABLE_HEALTH_CHECK&quot;</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 5.使用上下文管理器 _serve_logs 和 _serve_health_check 启动日志服务和健康检查服务。</span>
    <span class="token keyword">with</span> _serve_logs<span class="token punctuation">(</span>args<span class="token punctuation">.</span>skip_serve_logs<span class="token punctuation">)</span><span class="token punctuation">,</span> _serve_health_check<span class="token punctuation">(</span>enable_health_check<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 6.尝试运行调度器作业，将 job_runner._execute 作为执行方法传递给 run_job 函数。</span>
            run_job<span class="token punctuation">(</span>job<span class="token operator">=</span>job_runner<span class="token punctuation">.</span>job<span class="token punctuation">,</span> execute_callable<span class="token operator">=</span>job_runner<span class="token punctuation">.</span>_execute<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            <span class="token comment"># 7.如果在运行调度器作业过程中发生异常，记录异常信息。</span>
            log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">&quot;Exception when running scheduler job&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>这里我们看到该函数通过传递_execute函数来运行调度器进行作业，下面我们继续展开这个函数进行分析。</p> <h4 id="schedulerjobrunner-execute"><a href="#schedulerjobrunner-execute" class="header-anchor">#</a> SchedulerJobRunner._execute</h4> <p>它是 Airflow 调度器的核心执行逻辑，包括启动执行器、处理器代理，以及执行调度器循环。</p> <p>以下是具体的步骤：</p> <ol><li><p>从 <code>DagFileProcessorAgent</code> 类导入 Dag 文件处理器代理。</p></li> <li><p>导入默认执行器类，这里默认使用的是SequentialExecutor。</p></li> <li><p>判断是否需要对 DAGs 进行序列化（pickling），以便某些执行器更容易地进行远程执行。</p></li> <li><p>当使用 SQLite 时，不使用异步模式，以避免调度器工作进程和 DAG 解析器同时访问数据库。</p></li> <li><p>设置 DAG 文件处理器超时时间。</p></li> <li><p>如果没有使用独立的 DAG 处理器并且没有处理器代理，创建一个 <code>DagFileProcessorAgent</code> 实例。</p></li> <li><p>尝试执行以下操作：</p> <p>a. 设置执行器的 job ID。</p> <p>b. 根据是否使用处理器代理，设置执行器的回调接收器（callback sink）。</p> <p>c. 启动执行器。</p> <p>d. 注册信号处理器。</p> <p>e. 如果使用处理器代理，启动处理器代理。</p> <p>f. 记录调度器循环的开始时间。</p> <p>g. 执行调度器循环（<code>_run_scheduler_loop</code> 方法）。</p> <p>h. 如果使用处理器代理，停止处理器代理。</p> <p>i. 如果所有文件都已处理，停用自调度器循环开始以来未被触及的 DAG，因为它们可能已被删除。</p> <p>j. 移除数据库会话。</p></li> <li><p>如果在执行过程中发生异常，记录异常日志并抛出异常。</p></li> <li><p>在 finally 语句中，尝试结束执行器和处理器代理，并记录日志表示已退出执行循环。</p></li></ol> <p>这个方法的返回值为 <code>None</code>。</p> <p>文件路径：airflow/airflow/jobs/scheduler_job_runner.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_execute</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>dag_processing<span class="token punctuation">.</span>manager <span class="token keyword">import</span> DagFileProcessorAgent

    self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Starting the scheduler&quot;</span><span class="token punctuation">)</span>

    executor_class<span class="token punctuation">,</span> _ <span class="token operator">=</span> ExecutorLoader<span class="token punctuation">.</span>import_default_executor_cls<span class="token punctuation">(</span><span class="token punctuation">)</span>

    pickle_dags <span class="token operator">=</span> self<span class="token punctuation">.</span>do_pickle <span class="token keyword">and</span> executor_class<span class="token punctuation">.</span>supports_pickling

    self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Processing each file at most %s times&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_times_parse_dags<span class="token punctuation">)</span>

    async_mode <span class="token operator">=</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>using_sqlite

    processor_timeout_seconds<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> conf<span class="token punctuation">.</span>getint<span class="token punctuation">(</span><span class="token string">&quot;core&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dag_file_processor_timeout&quot;</span><span class="token punctuation">)</span>
    processor_timeout <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>processor_timeout_seconds<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_standalone_dag_processor <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>processor_agent <span class="token operator">=</span> DagFileProcessorAgent<span class="token punctuation">(</span>
            dag_directory<span class="token operator">=</span>Path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>subdir<span class="token punctuation">)</span><span class="token punctuation">,</span>
            max_runs<span class="token operator">=</span>self<span class="token punctuation">.</span>num_times_parse_dags<span class="token punctuation">,</span>
            processor_timeout<span class="token operator">=</span>processor_timeout<span class="token punctuation">,</span>
            dag_ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            pickle_dags<span class="token operator">=</span>pickle_dags<span class="token punctuation">,</span>
            async_mode<span class="token operator">=</span>async_mode<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>job_id <span class="token operator">=</span> self<span class="token punctuation">.</span>job<span class="token punctuation">.</span><span class="token builtin">id</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Using PipeCallbackSink as callback sink.&quot;</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>callback_sink <span class="token operator">=</span> PipeCallbackSink<span class="token punctuation">(</span>
                get_sink_pipe<span class="token operator">=</span>self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>get_callbacks_pipe
            <span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span>database_callback_sink <span class="token keyword">import</span> DatabaseCallbackSink

            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Using DatabaseCallbackSink as callback sink.&quot;</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>callback_sink <span class="token operator">=</span> DatabaseCallbackSink<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>register_signals<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

        execute_start_time <span class="token operator">=</span> timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_run_scheduler_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>all_files_processed<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                    <span class="token string">&quot;Deactivating DAGs that haven't been touched since %s&quot;</span><span class="token punctuation">,</span> execute_start_time<span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                DAG<span class="token punctuation">.</span>deactivate_stale_dags<span class="token punctuation">(</span>execute_start_time<span class="token punctuation">)</span>

        settings<span class="token punctuation">.</span>Session<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># type: ignore</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">&quot;Exception when executing SchedulerJob._run_scheduler_loop&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>end<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">&quot;Exception when executing Executor.end&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>end<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">&quot;Exception when executing DagFileProcessorAgent.end&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Exited execute loop&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre></div><p>在这个方法中有3个关键的操作：</p> <ul><li><p><code>self.job.executor.start()</code>： 它调用执行器的 <code>start</code> 方法，执行器是负责执行任务的组件。在调度器启动时，执行器需要初始化相关资源，如线程、进程或其他分布式资源。具体的实现取决于所使用的执行器类型（如 <code>SequentialExecutor</code>，<code>LocalExecutor</code>, <code>CeleryExecutor</code> 等）。</p></li> <li><p><code>self.processor_agent.start()</code>： 这个方法调用 <code>DagFileProcessorAgent</code> 的 <code>start</code> 方法。<code>DagFileProcessorAgent</code> 是负责解析和处理 DAG 文件的组件。它在后台运行，周期性地扫描 DAG 文件目录，解析找到的 DAG 文件并将其更新到数据库中。调用 <code>start</code> 方法会启动 DAG 文件处理器代理，使其开始工作。</p></li> <li><p><code>self._run_scheduler_loop()</code>： 这个方法是调度器的核心循环，负责处理和调度任务。在这个循环中，调度器会根据任务的依赖关系和状态来决定哪些任务可以执行。然后，它会将这些任务添加到executor的队列中。此外，调度器还会检查已完成的任务并更新它们的状态。这个循环会一直运行，直到调度器被停止。</p></li></ul> <h3 id="_2、dag定义和任务依赖定义"><a href="#_2、dag定义和任务依赖定义" class="header-anchor">#</a> 2、DAG定义和任务依赖定义</h3> <p>首先，在文件中定义DAG和任务，然后定义任务之间的依赖关系。前面我们介绍了Dag的定义，下面来介绍依赖关系的定义。</p> <p>在Airflow中，<code>chain</code>函数、位移操作符<code>&gt;&gt;</code>或<code>&lt;&lt;</code>以及<code>set_upstream</code>和<code>set_downstream</code>方法都可以用于设置任务之间的依赖关系。它们在使用方式和适用场景上有一些区别：</p> <ol><li><code>chain</code>函数：这个函数可以接受任意数量的任务作为参数，并在这些任务之间建立一条依赖链。这个函数的一个优点是可以接受任务列表作为参数，这使得可以在多个任务之间建立复杂的依赖关系。例如，<code>chain(t1, [t2, t3], t4)</code>将会创建以下的依赖关系：<code>t1 -&gt; t2 -&gt; t4</code>和<code>t1 -&gt; t3 -&gt; t4</code>。</li> <li>位移操作符<code>&gt;&gt;</code>或<code>&lt;&lt;</code>：这些操作符可以用于设置两个任务之间的依赖关系。例如，<code>t1 &gt;&gt; t2</code>或<code>t2 &lt;&lt; t1</code>都表示<code>t1</code>任务执行完后执行<code>t2</code>任务。这种方式的一个优点是语法简洁，易于阅读和理解。但是，它只能用于设置两个任务之间的依赖关系，如果需要设置多个任务之间的依赖关系，就需要多次使用这些操作符，例如：<code>t1 &gt;&gt; t2 &gt;&gt; t3 &gt;&gt; t4</code>。</li> <li><code>set_upstream</code>和<code>set_downstream</code>方法：这些方法可以用于设置两个任务之间的上游和下游依赖关系。例如，<code>t1.set_downstream(t2)</code>表示在<code>t1</code>任务执行完后执行<code>t2</code>任务，而<code>t2.set_upstream(t1)</code>表示在<code>t2</code>任务执行前执行<code>t1</code>任务。这种方式的一个优点是可以明确地设置任务之间的依赖关系，但它相对比较繁琐，尤其是在设置多个任务之间的依赖关系时。</li></ol> <p>例如下面的例子：</p> <p>op1 -&gt; op2依赖关系的三种写法：</p> <div class="language-python extra-class"><pre class="language-python"><code>op1 <span class="token operator">&gt;&gt;</span> op2
op1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>op2<span class="token punctuation">)</span>
chain<span class="token punctuation">(</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">)</span>
</code></pre></div><p>op2 &lt;- op1依赖关系的三种写法：</p> <div class="language- extra-class"><pre class="language-text"><code>op2 &lt;&lt; op1
op2.set_upstream(op1)
chain(op1, op2)
</code></pre></div><p>总的来说，<code>chain</code>函数、位移操作符<code>&gt;&gt;</code>或<code>&lt;&lt;</code>以及<code>set_upstream</code>和<code>set_downstream</code>方法在设置任务依赖关系时都有各自的优点和适用场景，可以根据实际需要选择使用。</p> <ul><li>官方文档：https://github.com/apache/airflow/blob/1a9b71a1298da76fc254f670e1032fa12131901a/docs/apache-airflow/core-concepts/dags.rst#L128</li></ul> <h4 id="chain的四种使用方法"><a href="#chain的四种使用方法" class="header-anchor">#</a> chain的四种使用方法</h4> <p>路径：airflow/models/taskmixin.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">DependencyMixin</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Mixing implementing common dependency setting methods like &gt;&gt; and &lt;&lt;.&quot;&quot;&quot;</span>

    <span class="token decorator annotation punctuation">@abstractmethod</span>
    <span class="token keyword">def</span> <span class="token function">set_upstream</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> other<span class="token punctuation">:</span> DependencyMixin <span class="token operator">|</span> Sequence<span class="token punctuation">[</span>DependencyMixin<span class="token punctuation">]</span><span class="token punctuation">,</span> edge_modifier<span class="token punctuation">:</span> EdgeModifier <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Set a task or a task list to be directly upstream from the current task.&quot;&quot;&quot;</span>
        <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@abstractmethod</span>
    <span class="token keyword">def</span> <span class="token function">set_downstream</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> other<span class="token punctuation">:</span> DependencyMixin <span class="token operator">|</span> Sequence<span class="token punctuation">[</span>DependencyMixin<span class="token punctuation">]</span><span class="token punctuation">,</span> edge_modifier<span class="token punctuation">:</span> EdgeModifier <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Set a task or a task list to be directly downstream from the current task.&quot;&quot;&quot;</span>
        <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token punctuation">)</span>
     
</code></pre></div><p>chain方法通过调用上述两个方法来实现依赖关系的设置，目前chain方法支持下面四种用法：</p> <blockquote><p>使用Operators/Sensors：</p></blockquote> <p>例如要表达下面的依赖关系：</p> <div class="language- extra-class"><pre class="language-text"><code>  / -&gt; t2 -&gt; t4 \
t1               -&gt; t6
  \ -&gt; t3 -&gt; t5 /
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>chain<span class="token punctuation">(</span>t1<span class="token punctuation">,</span> <span class="token punctuation">[</span>t2<span class="token punctuation">,</span> t3<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>t4<span class="token punctuation">,</span> t5<span class="token punctuation">]</span><span class="token punctuation">,</span> t6<span class="token punctuation">)</span>

<span class="token comment"># 等价于</span>

t1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t2<span class="token punctuation">)</span>
t1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t3<span class="token punctuation">)</span>
t2<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t4<span class="token punctuation">)</span>
t3<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t5<span class="token punctuation">)</span>
t4<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t6<span class="token punctuation">)</span>
t5<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t6<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>使用任务修饰函数又名 XComArgs</p></blockquote> <p>例如要表达下面的依赖关系：</p> <div class="language- extra-class"><pre class="language-text"><code>  / -&gt; t2 -&gt; t4 \
t1               -&gt; t6
  \ -&gt; t3 -&gt; t5 /
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>chain<span class="token punctuation">(</span>x1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>x2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>x4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x5<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x6<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 等价于：</span>

x1 <span class="token operator">=</span> x1<span class="token punctuation">(</span><span class="token punctuation">)</span>
x2 <span class="token operator">=</span> x2<span class="token punctuation">(</span><span class="token punctuation">)</span>
x3 <span class="token operator">=</span> x3<span class="token punctuation">(</span><span class="token punctuation">)</span>
x4 <span class="token operator">=</span> x4<span class="token punctuation">(</span><span class="token punctuation">)</span>
x5 <span class="token operator">=</span> x5<span class="token punctuation">(</span><span class="token punctuation">)</span>
x6 <span class="token operator">=</span> x6<span class="token punctuation">(</span><span class="token punctuation">)</span>
x1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>
x1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>
x2<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x4<span class="token punctuation">)</span>
x3<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x5<span class="token punctuation">)</span>
x4<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x6<span class="token punctuation">)</span>
x5<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x6<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>使用TaskGroups</p></blockquote> <p>例如要表达下面的依赖关系：</p> <div class="language- extra-class"><pre class="language-text"><code>t1 -&gt; task_group1 -&gt; task_group2 -&gt; t2
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>chain<span class="token punctuation">(</span>t1<span class="token punctuation">,</span> task_group1<span class="token punctuation">,</span> task_group2<span class="token punctuation">,</span> t2<span class="token punctuation">)</span>
<span class="token comment"># 等价于</span>
t1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>task_group1<span class="token punctuation">)</span>
task_group1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>task_group2<span class="token punctuation">)</span>
task_group2<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t2<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>也可以在Operators/Sensors、EdgeModifiers、XComArg 和 TaskGroups 之间进行混合</p></blockquote> <p>例如要表达下面的依赖关系：</p> <div class="language- extra-class"><pre class="language-text"><code>  / &quot;branch one&quot; -&gt; x1 \
t1                      -&gt; task_group1 -&gt; x3
  \ &quot;branch two&quot; -&gt; x2 /
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>chain<span class="token punctuation">(</span>t1<span class="token punctuation">,</span> <span class="token punctuation">[</span>Label<span class="token punctuation">(</span><span class="token string">&quot;branch one&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Label<span class="token punctuation">(</span><span class="token string">&quot;branch two&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>x1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> task_group1<span class="token punctuation">,</span> x3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 等价于</span>

x1 <span class="token operator">=</span> x1<span class="token punctuation">(</span><span class="token punctuation">)</span>
x2 <span class="token operator">=</span> x2<span class="token punctuation">(</span><span class="token punctuation">)</span>
x3 <span class="token operator">=</span> x3<span class="token punctuation">(</span><span class="token punctuation">)</span>
label1 <span class="token operator">=</span> Label<span class="token punctuation">(</span><span class="token string">&quot;branch one&quot;</span><span class="token punctuation">)</span>
label2 <span class="token operator">=</span> Label<span class="token punctuation">(</span><span class="token string">&quot;branch two&quot;</span><span class="token punctuation">)</span>
t1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>label1<span class="token punctuation">)</span>
label1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>
t2<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>label2<span class="token punctuation">)</span>
label2<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>
x1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>task_group1<span class="token punctuation">)</span>
x2<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>task_group1<span class="token punctuation">)</span>
task_group1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>x3<span class="token punctuation">)</span>
</code></pre></div><h4 id="chain源码剖析"><a href="#chain源码剖析" class="header-anchor">#</a> chain源码剖析</h4> <p>该方法用于在给定的多个任务之间建立依赖关系链。它接受一个或多个任务、边缘修饰符、XComArgs 或 TaskGroups 作为参数，并在这些任务之间设置依赖关系。下面是函数的步骤：</p> <ol><li>使用 <code>zip</code> 函数将任务列表与其自身的偏移版本配对，这样我们就可以在循环中同时处理上游任务和下游任务。</li> <li>检查上游任务是否是 <code>DependencyMixin</code> 类型。如果是，则为上游任务设置下游任务。然后继续下一个任务。</li> <li>检查下游任务是否是 <code>DependencyMixin</code> 类型。如果是，则为下游任务设置上游任务。然后继续下一个任务。</li> <li>如果上游任务和下游任务都是 <code>Sequence</code> 类型（如列表），则将它们分别赋值给 <code>up_task_list</code> 和 <code>down_task_list</code>。然后检查这两个列表的长度是否相等。如果上游任务和下游任务列表的长度相等，则使用 <code>zip</code> 函数将它们配对，并在循环中为每对任务设置上游和下游依赖关系。</li></ol> <p>文件路径：airflow/models/baseoperator.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">chain</span><span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">:</span> DependencyMixin <span class="token operator">|</span> Sequence<span class="token punctuation">[</span>DependencyMixin<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">r&quot;&quot;&quot;
    Given a number of tasks, builds a dependency chain.
    
    :param tasks: Individual and/or list of tasks, EdgeModifiers, XComArgs, or TaskGroups to set dependencies
    &quot;&quot;&quot;</span>
    <span class="token keyword">for</span> up_task<span class="token punctuation">,</span> down_task <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>tasks<span class="token punctuation">,</span> tasks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>up_task<span class="token punctuation">,</span> DependencyMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
            up_task<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>down_task<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>down_task<span class="token punctuation">,</span> DependencyMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
            down_task<span class="token punctuation">.</span>set_upstream<span class="token punctuation">(</span>up_task<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>up_task<span class="token punctuation">,</span> Sequence<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>down_task<span class="token punctuation">,</span> Sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Chain not supported between instances of </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">type</span><span class="token punctuation">(</span>up_task<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">type</span><span class="token punctuation">(</span>down_task<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        up_task_list <span class="token operator">=</span> up_task
        down_task_list <span class="token operator">=</span> down_task
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>up_task_list<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>down_task_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AirflowException<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f&quot;Chain not supported for different length Iterable. &quot;</span></span>
                <span class="token string-interpolation"><span class="token string">f&quot;Got </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>up_task_list<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>down_task_list<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.&quot;</span></span>
            <span class="token punctuation">)</span>
        <span class="token keyword">for</span> up_t<span class="token punctuation">,</span> down_t <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>up_task_list<span class="token punctuation">,</span> down_task_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
            up_t<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>down_t<span class="token punctuation">)</span>
</code></pre></div><p>下面我们通过airflow源码的官方example来了解其使用方法：</p> <p>路径：airflow/tests/system/providers/amazon/aws/example_mongo_to_s3.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> annotations

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>baseoperator <span class="token keyword">import</span> chain
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>dag <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>aws<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>s3 <span class="token keyword">import</span> S3CreateBucketOperator<span class="token punctuation">,</span> S3DeleteBucketOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>aws<span class="token punctuation">.</span>transfers<span class="token punctuation">.</span>mongo_to_s3 <span class="token keyword">import</span> MongoToS3Operator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>dates <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>trigger_rule <span class="token keyword">import</span> TriggerRule
<span class="token keyword">from</span> tests<span class="token punctuation">.</span>system<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>aws<span class="token punctuation">.</span>utils <span class="token keyword">import</span> SystemTestContextBuilder

DAG_ID <span class="token operator">=</span> <span class="token string">&quot;example_mongo_to_s3&quot;</span>

<span class="token comment"># Externally fetched variables:</span>
MONGO_DATABASE_KEY <span class="token operator">=</span> <span class="token string">&quot;MONGO_DATABASE&quot;</span>
MONGO_COLLECTION_KEY <span class="token operator">=</span> <span class="token string">&quot;MONGO_COLLECTION&quot;</span>

sys_test_context_task <span class="token operator">=</span> <span class="token punctuation">(</span>
    SystemTestContextBuilder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_variable<span class="token punctuation">(</span>MONGO_DATABASE_KEY<span class="token punctuation">)</span><span class="token punctuation">.</span>add_variable<span class="token punctuation">(</span>MONGO_COLLECTION_KEY<span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    DAG_ID<span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@once&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    test_context <span class="token operator">=</span> sys_test_context_task<span class="token punctuation">(</span><span class="token punctuation">)</span>
    env_id <span class="token operator">=</span> test_context<span class="token punctuation">[</span><span class="token string">&quot;ENV_ID&quot;</span><span class="token punctuation">]</span>
    mongo_database <span class="token operator">=</span> test_context<span class="token punctuation">[</span>MONGO_DATABASE_KEY<span class="token punctuation">]</span>
    mongo_collection <span class="token operator">=</span> test_context<span class="token punctuation">[</span>MONGO_COLLECTION_KEY<span class="token punctuation">]</span>

    s3_bucket <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>env_id<span class="token punctuation">}</span></span><span class="token string">-mongo-to-s3-bucket&quot;</span></span>
    s3_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>env_id<span class="token punctuation">}</span></span><span class="token string">-mongo-to-s3-key&quot;</span></span>

    create_s3_bucket <span class="token operator">=</span> S3CreateBucketOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;create_s3_bucket&quot;</span><span class="token punctuation">,</span> bucket_name<span class="token operator">=</span>s3_bucket<span class="token punctuation">)</span>

    <span class="token comment"># [START howto_transfer_mongo_to_s3]</span>
    mongo_to_s3_job <span class="token operator">=</span> MongoToS3Operator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;mongo_to_s3_job&quot;</span><span class="token punctuation">,</span>
        mongo_collection<span class="token operator">=</span>mongo_collection<span class="token punctuation">,</span>
        <span class="token comment"># Mongo query by matching values</span>
        <span class="token comment"># Here returns all documents which have &quot;OK&quot; as value for the key &quot;status&quot;</span>
        mongo_query<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        s3_bucket<span class="token operator">=</span>s3_bucket<span class="token punctuation">,</span>
        s3_key<span class="token operator">=</span>s3_key<span class="token punctuation">,</span>
        mongo_db<span class="token operator">=</span>mongo_database<span class="token punctuation">,</span>
        replace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># [END howto_transfer_mongo_to_s3]</span>

    delete_s3_bucket <span class="token operator">=</span> S3DeleteBucketOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;delete_s3_bucket&quot;</span><span class="token punctuation">,</span>
        bucket_name<span class="token operator">=</span>s3_bucket<span class="token punctuation">,</span>
        force_delete<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        trigger_rule<span class="token operator">=</span>TriggerRule<span class="token punctuation">.</span>ALL_DONE<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    chain<span class="token punctuation">(</span>
        <span class="token comment"># TEST SETUP</span>
        test_context<span class="token punctuation">,</span>
        create_s3_bucket<span class="token punctuation">,</span>
        <span class="token comment"># TEST BODY</span>
        mongo_to_s3_job<span class="token punctuation">,</span>
        <span class="token comment"># TEST TEARDOWN</span>
        delete_s3_bucket<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">from</span> tests<span class="token punctuation">.</span>system<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>watcher <span class="token keyword">import</span> watcher

    <span class="token comment"># This test needs watcher in order to properly mark success/failure</span>
    <span class="token comment"># when &quot;tearDown&quot; task with trigger rule is part of the DAG</span>
    <span class="token builtin">list</span><span class="token punctuation">(</span>dag<span class="token punctuation">.</span>tasks<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> watcher<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> tests<span class="token punctuation">.</span>system<span class="token punctuation">.</span>utils <span class="token keyword">import</span> get_test_run  <span class="token comment"># noqa: E402</span>

<span class="token comment"># Needed to run the example DAG with pytest (see: tests/system/README.md#run_via_pytest)</span>
test_run <span class="token operator">=</span> get_test_run<span class="token punctuation">(</span>dag<span class="token punctuation">)</span>
</code></pre></div><h3 id="_3、dag解析"><a href="#_3、dag解析" class="header-anchor">#</a> 3、DAG解析</h3> <p>当Airflow启动时，Scheduler会解析DAG文件并将其添加到DAGBag中。这一过程涉及到<code>DAGBag.process_file</code>方法。</p> <p>前面启动通过_execute启动调度器的同时，也通过<code>self.processor_agent.start()</code>方法创建DagFileProcessorAgent对象并调用start方法，start方法最终通过调用<code>DagBag.process_file</code>方法实现DAG解析。</p> <p>下图是函数的调用链：</p> <p>![image-20240321194827615](./img/4.2.2 dag解析函数调用链.png)</p> <p>其中<code>DagBag</code> 类是 Airflow 中的一个核心类，用于从指定的文件系统路径中加载、存储和管理有向无环图（DAG）对象。</p> <h4 id="dagbag-process-file"><a href="#dagbag-process-file" class="header-anchor">#</a> DagBag.process_file</h4> <p>我们接着看 <code>DagBag</code> 类的 <code>process_file</code> 方法。它的作用是处理并加载指定的 DAG 定义文件。以下是该方法的分段解释：</p> <ol><li>首先，检查输入参数 <code>filepath</code> 是否为 <code>None</code> 或者对应的文件是否存在。如果文件不存在，则返回一个空列表。</li> <li>尝试获取文件在磁盘上的最后修改时间。如果 <code>only_if_updated</code> 参数为 <code>True</code>，并且文件已经在 <code>self.file_last_changed</code> 字典中记录了最后修改时间，并且磁盘上的最后修改时间与记录的时间相同，则不需要重新加载此文件，直接返回一个空列表。这是为了避免不必要的重复加载。</li> <li>在加载 DAG 定义文件之前，清除 <code>DagContext.autoregistered_dags</code>，以确保不会意外地捕获不需要的 DAG 对象。</li> <li>根据文件类型（Python 文件或 ZIP 文件）调用不同的方法来加载模块。如果文件是以 <code>.py</code> 结尾的 Python 文件，或者不是一个 ZIP 文件，则调用 <code>_load_modules_from_file</code> 方法加载模块。如果文件是一个 ZIP 文件，则调用 <code>_load_modules_from_zip</code> 方法加载模块。</li> <li>调用 <code>_process_modules</code> 方法处理加载的模块，并获取找到的 DAG 对象列表 <code>found_dags</code>。这个方法会遍历模块中的所有对象，查找类型为 <code>DAG</code> 的对象，并将它们添加到 <code>DagBag</code> 实例中。</li> <li>更新 <code>self.file_last_changed</code> 字典，将文件的最后修改时间记录在其中。</li> <li>返回找到的 DAG 对象列表 <code>found_dags</code>。</li></ol> <p>文件路径：airflow/models/dagbag.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">process_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath<span class="token punctuation">,</span> only_if_updated<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> safe_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Given a path to a python module or zip file, import the module and look for dag objects within.&quot;&quot;&quot;</span>
    <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>dag <span class="token keyword">import</span> DagContext


    <span class="token keyword">if</span> filepath <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        file_last_changed_on_disk <span class="token operator">=</span> datetime<span class="token punctuation">.</span>fromtimestamp<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getmtime<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
            only_if_updated
            <span class="token keyword">and</span> filepath <span class="token keyword">in</span> self<span class="token punctuation">.</span>file_last_changed
            <span class="token keyword">and</span> file_last_changed_on_disk <span class="token operator">==</span> self<span class="token punctuation">.</span>file_last_changed<span class="token punctuation">[</span>filepath<span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    DagContext<span class="token punctuation">.</span>autoregistered_dags<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> filepath<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&quot;.py&quot;</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">not</span> zipfile<span class="token punctuation">.</span>is_zipfile<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mods <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_modules_from_file<span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> safe_mode<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        mods <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_modules_from_zip<span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> safe_mode<span class="token punctuation">)</span>

    found_dags <span class="token operator">=</span> self<span class="token punctuation">.</span>_process_modules<span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> mods<span class="token punctuation">,</span> file_last_changed_on_disk<span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>file_last_changed<span class="token punctuation">[</span>filepath<span class="token punctuation">]</span> <span class="token operator">=</span> file_last_changed_on_disk
    <span class="token keyword">return</span> found_dags
</code></pre></div><p>我们看到，process_file其中调用了_load_modules_from_file方法来从本地文件加载DAG进来的，下面我们分析其加载过程。</p> <h4 id="dagbag-load-modules-from-file"><a href="#dagbag-load-modules-from-file" class="header-anchor">#</a> DagBag._load_modules_from_file</h4> <p>这个函数 <code>_load_modules_from_file</code> 主要用于从给定的 Python 文件路径中加载模块。它首先检查文件是否可能包含 DAG 对象，然后使用 <code>importlib</code> 库来加载文件，并处理可能发生的异常。同时，它还支持设置 DAG 导入超时，以防止加载过程耗时过长。</p> <p>也就是说这部分函数代码是将DAG的定义进行解析的重要环节，解析完以后才可以给调度器进行调度。</p> <p>以下是该方法的代码步骤：</p> <ol><li>导入 <code>DagContext</code> 类。</li> <li>使用 <code>might_contain_dag</code> 函数检查文件是否可能包含 DAG 对象。如果不包含 DAG 对象，那么就不需要解析这个文件，直接返回一个空列表。如果这是首次跳过文件，记录一条跳过的日志信息。</li> <li>使用 <code>get_unique_dag_module_name</code> 函数为文件生成一个唯一的模块名。</li> <li>如果生成的模块名已经在 <code>sys.modules</code> 中，则删除它，以便重新加载。</li> <li>设置 <code>DagContext.current_autoregister_module_name</code> 为生成的模块名。</li> <li>定义一个名为 <code>parse</code> 的内部函数，用于实际加载和解析文件。这个函数使用 <code>importlib</code> 库来加载文件。</li> <li>获取 DAG 定义文件的导入超时设置。如果 <code>dagbag_import_timeout</code> 不是整数或浮点数，抛出 <code>TypeError</code> 异常。</li> <li>如果 <code>dagbag_import_timeout</code> 小于等于 0，表示没有设置导入超时，直接调用 <code>parse</code> 函数加载和解析文件。</li> <li>如果设置了导入超时，使用 <code>timeout</code> 上下文管理器来限制 <code>parse</code> 函数的执行时间。如果超时，将抛出一个包含建议如何优化 DAG 导入时间的异常信息。</li></ol> <p>文件路径：airflow/models/dagbag.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_load_modules_from_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath<span class="token punctuation">,</span> safe_mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>dag <span class="token keyword">import</span> DagContext

    <span class="token keyword">if</span> <span class="token keyword">not</span> might_contain_dag<span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> safe_mode<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>has_logged<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>has_logged <span class="token operator">=</span> <span class="token boolean">True</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;File %s assumed to contain no DAGs. Skipping.&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Importing %s&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>
    mod_name <span class="token operator">=</span> get_unique_dag_module_name<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>

    <span class="token keyword">if</span> mod_name <span class="token keyword">in</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">:</span>
        <span class="token keyword">del</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>mod_name<span class="token punctuation">]</span>

    DagContext<span class="token punctuation">.</span>current_autoregister_module_name <span class="token operator">=</span> mod_name

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>mod_name<span class="token punctuation">,</span> filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            loader <span class="token operator">=</span> importlib<span class="token punctuation">.</span>machinery<span class="token punctuation">.</span>SourceFileLoader<span class="token punctuation">(</span>mod_name<span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>
            spec <span class="token operator">=</span> importlib<span class="token punctuation">.</span>util<span class="token punctuation">.</span>spec_from_loader<span class="token punctuation">(</span>mod_name<span class="token punctuation">,</span> loader<span class="token punctuation">)</span>
            new_module <span class="token operator">=</span> importlib<span class="token punctuation">.</span>util<span class="token punctuation">.</span>module_from_spec<span class="token punctuation">(</span>spec<span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>spec<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> new_module
            loader<span class="token punctuation">.</span>exec_module<span class="token punctuation">(</span>new_module<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span>new_module<span class="token punctuation">]</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            DagContext<span class="token punctuation">.</span>autoregistered_dags<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">&quot;Failed to import: %s&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>dagbag_import_error_tracebacks<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>import_errors<span class="token punctuation">[</span>filepath<span class="token punctuation">]</span> <span class="token operator">=</span> traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span>
                    limit<span class="token operator">=</span><span class="token operator">-</span>self<span class="token punctuation">.</span>dagbag_import_error_traceback_depth
                <span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>import_errors<span class="token punctuation">[</span>filepath<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    dagbag_import_timeout <span class="token operator">=</span> settings<span class="token punctuation">.</span>get_dagbag_import_timeout<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dagbag_import_timeout<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f&quot;Value (</span><span class="token interpolation"><span class="token punctuation">{</span>dagbag_import_timeout<span class="token punctuation">}</span></span><span class="token string">) from get_dagbag_import_timeout must be int or float&quot;</span></span>
        <span class="token punctuation">)</span>

    <span class="token keyword">if</span> dagbag_import_timeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># no parsing timeout</span>
        <span class="token keyword">return</span> parse<span class="token punctuation">(</span>mod_name<span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>

    timeout_msg <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token string-interpolation"><span class="token string">f&quot;DagBag import timeout for </span><span class="token interpolation"><span class="token punctuation">{</span>filepath<span class="token punctuation">}</span></span><span class="token string"> after </span><span class="token interpolation"><span class="token punctuation">{</span>dagbag_import_timeout<span class="token punctuation">}</span></span><span class="token string">s.\n&quot;</span></span>
        <span class="token string">&quot;Please take a look at these docs to improve your DAG import time:\n&quot;</span>
        <span class="token string-interpolation"><span class="token string">f&quot;* </span><span class="token interpolation"><span class="token punctuation">{</span>get_docs_url<span class="token punctuation">(</span><span class="token string">'best-practices.html#top-level-python-code'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span>
        <span class="token string-interpolation"><span class="token string">f&quot;* </span><span class="token interpolation"><span class="token punctuation">{</span>get_docs_url<span class="token punctuation">(</span><span class="token string">'best-practices.html#reducing-dag-complexity'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">)</span>
    <span class="token keyword">with</span> timeout<span class="token punctuation">(</span>dagbag_import_timeout<span class="token punctuation">,</span> error_message<span class="token operator">=</span>timeout_msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> parse<span class="token punctuation">(</span>mod_name<span class="token punctuation">,</span> filepath<span class="token punctuation">)</span>

</code></pre></div><p>_load_modules_from_zip原理跟该方法类似，这里就不重复展开介绍。</p> <h4 id="dagbag-parse"><a href="#dagbag-parse" class="header-anchor">#</a> DagBag.parse</h4> <p>前面<code>parse</code> 函数尝试从给定的文件路径导入 DAG 模块。如果导入成功，它将返回一个包含新导入模块的列表。这个新模块可能包含以下数据：</p> <ol><li>DAG 定义：DAG 模块中定义的 DAG 对象，用于表示工作流的依赖关系。DAG 对象通常使用 <code>airflow.models.DAG</code> 类实例化，并设置相关参数，如 <code>dag_id</code>、<code>schedule_interval</code> 等。</li> <li>任务定义：在 DAG 模块中，任务是使用 <code>airflow.operators</code> 中的各种运算符（如 <code>PythonOperator</code>、<code>BashOperator</code> 等）创建的。任务定义了要在工作流中执行的具体操作，并通过 <code>set_upstream</code> 和 <code>set_downstream</code> 方法指定它们之间的依赖关系。</li> <li>变量和函数：DAG 模块中可能还包含一些辅助变量和函数，用于在任务执行过程中实现特定的逻辑或处理数据。</li> <li>钩子（Hooks）和连接（Connections）：DAG 模块可能还包含钩子和连接的定义，用于与外部系统（如数据库、API 等）进行交互。</li> <li>导入的其他模块和库：DAG 模块可能还需要导入其他 Python 模块或库，以便在任务执行过程中使用。</li></ol> <p>请注意，<code>parse</code> 函数只负责导入 DAG 模块，并不会执行其中的任务。任务的执行由 Airflow 调度器根据 DAG 的调度设置进行。</p> <p>也就是说，在导入Dag文件的同时，里面涉及到的Operator都会被创建对象，即调用BaseOperator的__init__初始化方法创建对象。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># 创建DAG实例</span>
dag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">'my_example_dag'</span><span class="token punctuation">,</span>
    default_args<span class="token operator">=</span>dag_args<span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">'A simple example DAG'</span><span class="token punctuation">,</span>
    schedule_interval<span class="token operator">=</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 定义任务</span>
task_1 <span class="token operator">=</span> DummyOperator<span class="token punctuation">(</span>
    task_id<span class="token operator">=</span><span class="token string">'task_1'</span><span class="token punctuation">,</span>
    dag<span class="token operator">=</span>dag<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>当接下来执行到设置上下游依赖关系是，即：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
task1 <span class="token operator">&gt;&gt;</span> task2
<span class="token comment"># 或</span>
chain<span class="token punctuation">(</span>task1<span class="token punctuation">,</span> task2<span class="token punctuation">)</span>
<span class="token comment"># 或</span>
task1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>task2<span class="token punctuation">)</span>
task2<span class="token punctuation">.</span>set_upstream<span class="token punctuation">(</span>task1<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>就会调用前面我们介绍的set_downstream和set_upstream方法设置DagRun中任务的依赖关系。</p> <p>下面是我们介绍重要的参数，这些参数都是在写DAG Python文件时大部分定义的。</p> <blockquote><p>任务标识和依赖关系：</p></blockquote> <ol><li>task_id：任务的唯一标识符。</li> <li>dag：任务所属的 DAG 对象。</li> <li>task_group：任务所属的任务组。</li> <li>depends_on_past：任务是否取决于其过去的实例。</li> <li>wait_for_downstream：是否等待下游任务完成。</li> <li>trigger_rule：触发任务执行的规则。</li></ol> <blockquote><p>重试设置：</p></blockquote> <ol><li>retries：任务失败时的重试次数。</li> <li>retry_delay：任务重试之间的时间间隔。</li> <li>retry_exponential_backoff：是否在重试时使用指数退避策略。</li> <li>max_retry_delay：重试之间的最大时间间隔。</li></ol> <blockquote><p>回调和钩子：</p></blockquote> <ol><li>on_execute_callback：任务执行时的回调函数。</li> <li>on_failure_callback：任务失败时的回调函数。</li> <li>on_success_callback：任务成功时的回调函数。</li> <li>on_retry_callback：任务重试时的回调函数。</li> <li>on_skipped_callback：任务跳过时的回调函数。</li> <li>pre_execute：任务执行前的钩子函数。</li> <li>post_execute：任务执行后的钩子函数。</li></ol> <blockquote><p>其他任务设置：</p></blockquote> <ol><li>params：传递给任务的参数。</li> <li>default_args：任务的默认参数。</li> <li>priority_weight：任务的优先级权重。</li> <li>weight_rule：任务权重规则。</li> <li>queue：任务所在的队列。</li> <li>pool：任务所在的资源池。</li> <li>pool_slots：任务在资源池中占用的插槽数。</li> <li>sla：任务的服务级别协议（Service Level Agreement）。</li> <li>resources：任务所需的资源。</li> <li>run_as_user：运行任务的用户。</li> <li>task_concurrency：任务的并发限制。</li> <li>map_index_template：任务的映射索引模板。</li> <li>max_active_tis_per_dag：每个 DAG 中允许的最大活动任务实例数。</li> <li>max_active_tis_per_dagrun：每个 DAG 运行中允许的最大活动任务实例数。</li> <li>executor_config：任务的执行器配置。</li> <li>do_xcom_push：是否将任务的返回值推送到 XCom。</li> <li>multiple_outputs：是否允许任务具有多个输出。</li> <li>inlets：任务的上游数据源。</li> <li>outlets：任务的下游数据目标。</li></ol> <p>文件路径：airflow/airflow/models/baseoperator.py</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        task_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        owner<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> DEFAULT_OWNER<span class="token punctuation">,</span>
        email<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> Iterable<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        email_on_retry<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> conf<span class="token punctuation">.</span>getboolean<span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default_email_on_retry&quot;</span><span class="token punctuation">,</span> fallback<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        email_on_failure<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> conf<span class="token punctuation">.</span>getboolean<span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default_email_on_failure&quot;</span><span class="token punctuation">,</span> fallback<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        retries<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> DEFAULT_RETRIES<span class="token punctuation">,</span>
        retry_delay<span class="token punctuation">:</span> timedelta <span class="token operator">|</span> <span class="token builtin">float</span> <span class="token operator">=</span> DEFAULT_RETRY_DELAY<span class="token punctuation">,</span>
        retry_exponential_backoff<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        max_retry_delay<span class="token punctuation">:</span> timedelta <span class="token operator">|</span> <span class="token builtin">float</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        start_date<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        end_date<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        depends_on_past<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        ignore_first_depends_on_past<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> DEFAULT_IGNORE_FIRST_DEPENDS_ON_PAST<span class="token punctuation">,</span>
        wait_for_past_depends_before_skipping<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> DEFAULT_WAIT_FOR_PAST_DEPENDS_BEFORE_SKIPPING<span class="token punctuation">,</span>
        wait_for_downstream<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        dag<span class="token punctuation">:</span> DAG <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        params<span class="token punctuation">:</span> collections<span class="token punctuation">.</span>abc<span class="token punctuation">.</span>MutableMapping <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        default_args<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        priority_weight<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> DEFAULT_PRIORITY_WEIGHT<span class="token punctuation">,</span>
        weight_rule<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> PriorityWeightStrategy <span class="token operator">=</span> DEFAULT_WEIGHT_RULE<span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> DEFAULT_QUEUE<span class="token punctuation">,</span>
        pool<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        pool_slots<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> DEFAULT_POOL_SLOTS<span class="token punctuation">,</span>
        sla<span class="token punctuation">:</span> timedelta <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        execution_timeout<span class="token punctuation">:</span> timedelta <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> DEFAULT_TASK_EXECUTION_TIMEOUT<span class="token punctuation">,</span>
        on_execute_callback<span class="token punctuation">:</span> <span class="token boolean">None</span> <span class="token operator">|</span> TaskStateChangeCallback <span class="token operator">|</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TaskStateChangeCallback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        on_failure_callback<span class="token punctuation">:</span> <span class="token boolean">None</span> <span class="token operator">|</span> TaskStateChangeCallback <span class="token operator">|</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TaskStateChangeCallback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        on_success_callback<span class="token punctuation">:</span> <span class="token boolean">None</span> <span class="token operator">|</span> TaskStateChangeCallback <span class="token operator">|</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TaskStateChangeCallback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        on_retry_callback<span class="token punctuation">:</span> <span class="token boolean">None</span> <span class="token operator">|</span> TaskStateChangeCallback <span class="token operator">|</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TaskStateChangeCallback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        on_skipped_callback<span class="token punctuation">:</span> <span class="token boolean">None</span> <span class="token operator">|</span> TaskStateChangeCallback <span class="token operator">|</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TaskStateChangeCallback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        pre_execute<span class="token punctuation">:</span> TaskPreExecuteHook <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        post_execute<span class="token punctuation">:</span> TaskPostExecuteHook <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        trigger_rule<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> DEFAULT_TRIGGER_RULE<span class="token punctuation">,</span>
        resources<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        run_as_user<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        task_concurrency<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        map_index_template<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        max_active_tis_per_dag<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        max_active_tis_per_dagrun<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        executor_config<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        do_xcom_push<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        multiple_outputs<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        inlets<span class="token punctuation">:</span> Any <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        outlets<span class="token punctuation">:</span> Any <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        task_group<span class="token punctuation">:</span> TaskGroup <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        doc<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        doc_md<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        doc_json<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        doc_yaml<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        doc_rst<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        logger_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        allow_nested_operators<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token operator">**</span>kwargs<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><h4 id="dagbag-process-modules"><a href="#dagbag-process-modules" class="header-anchor">#</a> DagBag._process_modules</h4> <p>从本地加载完DAG文件导入模块后，接下来调用 <code>_process_modules</code> 方法处理加载的模块，并获取找到的 DAG 对象列表 <code>found_dags</code>。这个方法会遍历模块中的所有对象，查找类型为 <code>DAG</code> 的对象，并将它们添加到 <code>DagBag</code> 实例中。</p> <p>以下是该方法的功能解释：</p> <ol><li>从 <code>airflow.models.dag</code> 模块导入 <code>DAG</code> 和 <code>DagContext</code> 类，避免循环导入。</li> <li>使用列表推导式遍历模块中的所有对象，找到类型为 <code>DAG</code> 的对象，并将它们存储在 <code>top_level_dags</code> 集合中。同时，将 <code>DagContext.autoregistered_dags</code> 中的 DAG 也添加到 <code>top_level_dags</code> 集合中。</li> <li>重置 <code>DagContext.current_autoregister_module_name</code> 为 <code>None</code>，并清空 <code>DagContext.autoregistered_dags</code>。</li> <li>创建一个空列表 <code>found_dags</code>，用于存储找到的 DAG 对象。</li> <li>遍历 <code>top_level_dags</code> 集合中的 DAG 对象。为每个 DAG 对象设置 <code>fileloc</code> 属性，该属性指向其所在的模块文件。</li> <li>尝试验证 DAG 对象，并使用 <code>bag_dag</code> 方法将其添加到 <code>DagBag</code> 实例中。如果在这个过程中遇到 <code>AirflowClusterPolicySkipDag</code> 异常，则跳过这个 DAG。如果遇到其他异常，记录异常信息，并将错误信息添加到 <code>self.import_errors</code> 字典中，同时更新 <code>self.file_last_changed</code> 字典。</li> <li>如果没有发生异常，将 DAG 对象添加到 <code>found_dags</code> 列表中，并将 DAG 的子 DAG 也添加到 <code>found_dags</code> 列表中。</li> <li>返回找到的 DAG 对象列表 <code>found_dags</code>。</li></ol> <p>文件路径：airflow/models/dagbag.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_process_modules</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filepath<span class="token punctuation">,</span> mods<span class="token punctuation">,</span> file_last_changed_on_disk<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>dag <span class="token keyword">import</span> DAG<span class="token punctuation">,</span> DagContext 

      top_level_dags <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> m<span class="token punctuation">)</span> <span class="token keyword">for</span> m <span class="token keyword">in</span> mods <span class="token keyword">for</span> o <span class="token keyword">in</span> m<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> DAG<span class="token punctuation">)</span><span class="token punctuation">}</span>

      top_level_dags<span class="token punctuation">.</span>update<span class="token punctuation">(</span>DagContext<span class="token punctuation">.</span>autoregistered_dags<span class="token punctuation">)</span>

      DagContext<span class="token punctuation">.</span>current_autoregister_module_name <span class="token operator">=</span> <span class="token boolean">None</span>
      DagContext<span class="token punctuation">.</span>autoregistered_dags<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

      found_dags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

      <span class="token keyword">for</span> dag<span class="token punctuation">,</span> mod <span class="token keyword">in</span> top_level_dags<span class="token punctuation">:</span>
          dag<span class="token punctuation">.</span>fileloc <span class="token operator">=</span> mod<span class="token punctuation">.</span>__file__
          <span class="token keyword">try</span><span class="token punctuation">:</span>
              dag<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span>
              self<span class="token punctuation">.</span>bag_dag<span class="token punctuation">(</span>dag<span class="token operator">=</span>dag<span class="token punctuation">,</span> root_dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>
          <span class="token keyword">except</span> AirflowClusterPolicySkipDag<span class="token punctuation">:</span>
              <span class="token keyword">pass</span>
          <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
              self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">&quot;Failed to bag_dag: %s&quot;</span><span class="token punctuation">,</span> dag<span class="token punctuation">.</span>fileloc<span class="token punctuation">)</span>
              self<span class="token punctuation">.</span>import_errors<span class="token punctuation">[</span>dag<span class="token punctuation">.</span>fileloc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">type</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
              self<span class="token punctuation">.</span>file_last_changed<span class="token punctuation">[</span>dag<span class="token punctuation">.</span>fileloc<span class="token punctuation">]</span> <span class="token operator">=</span> file_last_changed_on_disk
          <span class="token keyword">else</span><span class="token punctuation">:</span>
              found_dags<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dag<span class="token punctuation">)</span>
              found_dags <span class="token operator">+=</span> dag<span class="token punctuation">.</span>subdags
      <span class="token keyword">return</span> found_dags
</code></pre></div><h3 id="_5、dag调度"><a href="#_5、dag调度" class="header-anchor">#</a> 5、DAG调度</h3> <h4 id="schedulerjobrunner-run-scheduler-loop"><a href="#schedulerjobrunner-run-scheduler-loop" class="header-anchor">#</a> SchedulerJobRunner._run_scheduler_loop</h4> <p>![image-20240321202848216](./img/4.2.2 DAG运行实例创建函数链.png)</p> <p>该函数它实现了调度器的主要循环逻辑。调度器的主要任务是解析 DAG 文件、找到可执行的任务、将任务加入队列以及与执行器进行心跳。以下是该方法的步骤：</p> <ol><li><p>检查 <code>processor_agent</code> 是否已经启动。如果没有启动，则抛出 <code>ValueError</code> 异常。</p></li> <li><p>初始化一个 <code>EventScheduler</code> 对象，用于管理定时事件。</p></li> <li><p>添加一系列定时事件，包括检查孤儿任务、检查触发器超时、发送池指标、检查僵尸任务、更新暂停 DAG 的状态、处理长时间处于队列中的任务等。</p></li> <li><p>使用 <code>itertools.count</code> 创建一个无限循环。在每次循环中执行以下操作：</p> <p>a. 如果使用的是 SQLite 数据库，并且 <code>processor_agent</code> 已启动，则运行单次解析循环，并等待解析器完成，以避免同时访问数据库。</p> <p>b. 创建一个新的数据库会话，并调用 <code>_do_scheduling</code> 方法执行调度任务。这个方法会找到可执行的任务实例，并将它们加入执行器的队列。</p> <p>c. 调用执行器的 <code>heartbeat</code> 方法，执行队列中的任务并同步运行中任务的状态。</p> <p>d. 如果 <code>processor_agent</code> 已启动，调用它的 <code>heartbeat</code> 方法。</p> <p>e. 定期执行调度器的心跳，以更新其状态。</p> <p>f. 运行所有挂起的定时事件。</p></li> <li><p>如果调度器处于空闲状态（即没有新的任务实例加入队列，也没有任务完成），则让调度器线程休眠一段时间，以减少 CPU 使用率。</p></li> <li><p>如果达到了指定的调度循环次数或解析次数，退出循环。</p></li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_run_scheduler_loop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>processor_agent <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_standalone_dag_processor<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;Processor agent is not started.&quot;</span><span class="token punctuation">)</span>
    is_unit_test<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> conf<span class="token punctuation">.</span>getboolean<span class="token punctuation">(</span><span class="token string">&quot;core&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unit_test_mode&quot;</span><span class="token punctuation">)</span>

    timers <span class="token operator">=</span> EventScheduler<span class="token punctuation">(</span><span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>adopt_or_reset_orphaned_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span>

    timers<span class="token punctuation">.</span>call_regular_interval<span class="token punctuation">(</span>
        conf<span class="token punctuation">.</span>getfloat<span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orphaned_tasks_check_interval&quot;</span><span class="token punctuation">,</span> fallback<span class="token operator">=</span><span class="token number">300.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>adopt_or_reset_orphaned_tasks<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    timers<span class="token punctuation">.</span>call_regular_interval<span class="token punctuation">(</span>
        conf<span class="token punctuation">.</span>getfloat<span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;trigger_timeout_check_interval&quot;</span><span class="token punctuation">,</span> fallback<span class="token operator">=</span><span class="token number">15.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>check_trigger_timeouts<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    timers<span class="token punctuation">.</span>call_regular_interval<span class="token punctuation">(</span>
        conf<span class="token punctuation">.</span>getfloat<span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pool_metrics_interval&quot;</span><span class="token punctuation">,</span> fallback<span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>_emit_pool_metrics<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    timers<span class="token punctuation">.</span>call_regular_interval<span class="token punctuation">(</span>
        conf<span class="token punctuation">.</span>getfloat<span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zombie_detection_interval&quot;</span><span class="token punctuation">,</span> fallback<span class="token operator">=</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>_find_zombies<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    timers<span class="token punctuation">.</span>call_regular_interval<span class="token punctuation">(</span><span class="token number">60.0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_update_dag_run_state_for_paused_dags<span class="token punctuation">)</span>

    timers<span class="token punctuation">.</span>call_regular_interval<span class="token punctuation">(</span>
        conf<span class="token punctuation">.</span>getfloat<span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;task_queued_timeout_check_interval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>_fail_tasks_stuck_in_queued<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    timers<span class="token punctuation">.</span>call_regular_interval<span class="token punctuation">(</span>
        conf<span class="token punctuation">.</span>getfloat<span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;parsing_cleanup_interval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>_orphan_unreferenced_datasets<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_standalone_dag_processor<span class="token punctuation">:</span>
        timers<span class="token punctuation">.</span>call_regular_interval<span class="token punctuation">(</span>
            conf<span class="token punctuation">.</span>getfloat<span class="token punctuation">(</span><span class="token string">&quot;scheduler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;parsing_cleanup_interval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_cleanup_stale_dags<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">for</span> loop_count <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>count<span class="token punctuation">(</span>start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> Stats<span class="token punctuation">.</span>timer<span class="token punctuation">(</span><span class="token string">&quot;scheduler.scheduler_loop_duration&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> timer<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>using_sqlite <span class="token keyword">and</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>run_single_parsing_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Waiting for processors to finish since we're using sqlite&quot;</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>wait_until_finished<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">with</span> create_session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
                num_queued_tis <span class="token operator">=</span> self<span class="token punctuation">.</span>_do_scheduling<span class="token punctuation">(</span>session<span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>heartbeat<span class="token punctuation">(</span><span class="token punctuation">)</span>
                session<span class="token punctuation">.</span>expunge_all<span class="token punctuation">(</span><span class="token punctuation">)</span>
                num_finished_events <span class="token operator">=</span> self<span class="token punctuation">.</span>_process_executor_events<span class="token punctuation">(</span>session<span class="token operator">=</span>session<span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>heartbeat<span class="token punctuation">(</span><span class="token punctuation">)</span>

            perform_heartbeat<span class="token punctuation">(</span>
                job<span class="token operator">=</span>self<span class="token punctuation">.</span>job<span class="token punctuation">,</span> heartbeat_callback<span class="token operator">=</span>self<span class="token punctuation">.</span>heartbeat_callback<span class="token punctuation">,</span> only_if_necessary<span class="token operator">=</span><span class="token boolean">True</span>
            <span class="token punctuation">)</span>

            next_event <span class="token operator">=</span> timers<span class="token punctuation">.</span>run<span class="token punctuation">(</span>blocking<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Next timed event is in %f&quot;</span><span class="token punctuation">,</span> next_event<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Ran scheduling loop in %.2f seconds&quot;</span><span class="token punctuation">,</span> timer<span class="token punctuation">.</span>duration<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> is_unit_test <span class="token keyword">and</span> <span class="token keyword">not</span> num_queued_tis <span class="token keyword">and</span> <span class="token keyword">not</span> num_finished_events<span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_scheduler_idle_sleep_time<span class="token punctuation">,</span> next_event <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> loop_count <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>num_runs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                <span class="token string">&quot;Exiting scheduler loop as requested number of runs (%d - got to %d) has been reached&quot;</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>num_runs<span class="token punctuation">,</span>
                loop_count<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>processor_agent <span class="token keyword">and</span> self<span class="token punctuation">.</span>processor_agent<span class="token punctuation">.</span>done<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                <span class="token string">&quot;Exiting scheduler loop as requested DAG parse count (%d) has been reached after %d&quot;</span>
                <span class="token string">&quot; scheduler loops&quot;</span><span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>num_times_parse_dags<span class="token punctuation">,</span>
                loop_count<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">break</span>

</code></pre></div><h3 id="_6、dagrun实例创建"><a href="#_6、dagrun实例创建" class="header-anchor">#</a> 6、DAGRun实例创建</h3> <h4 id="schedulerjobrunner-create-dag-runs"><a href="#schedulerjobrunner-create-dag-runs" class="header-anchor">#</a> SchedulerJobRunner._create_dag_runs</h4> <p>在调度循环中，Scheduler会根据DAG的调度间隔和触发规则创建DAG运行实例。这一过程涉及到``SchedulerJobRunner._create_dagruns_for_dags<code>和</code>SchedulerJobRunner._create_dag_runs`方法。</p> <p>这两个方法的主要作用是为需要运行的 DAG 创建 DagRun 实例。</p> <ul><li><p><code>_create_dagruns_for_dags</code> 方法首先调用 <code>DagModel.dags_needing_dagruns</code> 方法找到需要创建 DagRun 的 DAG，然后将这些 DAG 分为两类：dataset 触发的 DAG 和非 dataset 触发的 DAG。然后，分别调用 <code>_create_dag_runs</code> 和 <code>_create_dag_runs_dataset_triggered</code> 方法为这两类 DAG 创建 DagRun。最后，提交数据库会话，释放对 <code>DagModel</code> 表的写锁。</p></li> <li><p><code>_create_dag_runs</code> 方法为给定的 DAG 模型创建 DagRun 实例，并更新 DAG 模型的 <code>next_dagrun</code> 和 <code>next_dagrun_create_after</code> 字段以控制下一个 DagRun 的创建时间。首先，从数据库中获取已存在的 DagRun 实例，以避免创建重复的 DagRun。然后，获取每个 DAG 当前的活动运行数。接着，遍历每个 DAG 模型，获取对应的 DAG 实例，并为其创建一个新的 DagRun 实例。如果 DagRun 已存在或创建成功，更新 DAG 模型的 <code>next_dagrun</code> 和 <code>next_dagrun_create_after</code> 字段。如果在创建过程中发生异常，记录异常信息并继续处理下一个 DAG。</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@retry_db_transaction</span>
<span class="token keyword">def</span> <span class="token function">_create_dagruns_for_dags</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> guard<span class="token punctuation">:</span> CommitProhibitorGuard<span class="token punctuation">,</span> session<span class="token punctuation">:</span> Session<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Find Dag Models needing DagRuns and Create Dag Runs with retries in case of OperationalError.&quot;&quot;&quot;</span>
    query<span class="token punctuation">,</span> dataset_triggered_dag_info <span class="token operator">=</span> DagModel<span class="token punctuation">.</span>dags_needing_dagruns<span class="token punctuation">(</span>session<span class="token punctuation">)</span>
    all_dags_needing_dag_runs <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    dataset_triggered_dags <span class="token operator">=</span> <span class="token punctuation">[</span>
        dag <span class="token keyword">for</span> dag <span class="token keyword">in</span> all_dags_needing_dag_runs <span class="token keyword">if</span> dag<span class="token punctuation">.</span>dag_id <span class="token keyword">in</span> dataset_triggered_dag_info
    <span class="token punctuation">]</span>
    non_dataset_dags <span class="token operator">=</span> all_dags_needing_dag_runs<span class="token punctuation">.</span>difference<span class="token punctuation">(</span>dataset_triggered_dags<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>_create_dag_runs<span class="token punctuation">(</span>non_dataset_dags<span class="token punctuation">,</span> session<span class="token punctuation">)</span>
    <span class="token keyword">if</span> dataset_triggered_dags<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_create_dag_runs_dataset_triggered<span class="token punctuation">(</span>
            dataset_triggered_dags<span class="token punctuation">,</span> dataset_triggered_dag_info<span class="token punctuation">,</span> session
        <span class="token punctuation">)</span>

    guard<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">_create_dag_runs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dag_models<span class="token punctuation">:</span> Collection<span class="token punctuation">[</span>DagModel<span class="token punctuation">]</span><span class="token punctuation">,</span> session<span class="token punctuation">:</span> Session<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Create a DAG run and update the dag_model to control if/when the next DAGRun should be created.&quot;&quot;&quot;</span>
    existing_dagruns <span class="token operator">=</span> <span class="token punctuation">(</span>
        session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
            select<span class="token punctuation">(</span>DagRun<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> DagRun<span class="token punctuation">.</span>execution_date<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>
                tuple_in_condition<span class="token punctuation">(</span>
                    <span class="token punctuation">(</span>DagRun<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> DagRun<span class="token punctuation">.</span>execution_date<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>dm<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> dm<span class="token punctuation">.</span>next_dagrun<span class="token punctuation">)</span> <span class="token keyword">for</span> dm <span class="token keyword">in</span> dag_models<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    active_runs_of_dags <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
        DagRun<span class="token punctuation">.</span>active_runs_of_dags<span class="token punctuation">(</span>dag_ids<span class="token operator">=</span><span class="token punctuation">(</span>dm<span class="token punctuation">.</span>dag_id <span class="token keyword">for</span> dm <span class="token keyword">in</span> dag_models<span class="token punctuation">)</span><span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">for</span> dag_model <span class="token keyword">in</span> dag_models<span class="token punctuation">:</span>
        dag <span class="token operator">=</span> self<span class="token punctuation">.</span>dagbag<span class="token punctuation">.</span>get_dag<span class="token punctuation">(</span>dag_model<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> dag<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;DAG '%s' not found in serialized_dag table&quot;</span><span class="token punctuation">,</span> dag_model<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        dag_hash <span class="token operator">=</span> self<span class="token punctuation">.</span>dagbag<span class="token punctuation">.</span>dags_hash<span class="token punctuation">.</span>get<span class="token punctuation">(</span>dag<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>

        data_interval <span class="token operator">=</span> dag<span class="token punctuation">.</span>get_next_data_interval<span class="token punctuation">(</span>dag_model<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>dag<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> dag_model<span class="token punctuation">.</span>next_dagrun<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> existing_dagruns<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                dag<span class="token punctuation">.</span>create_dagrun<span class="token punctuation">(</span>
                    run_type<span class="token operator">=</span>DagRunType<span class="token punctuation">.</span>SCHEDULED<span class="token punctuation">,</span>
                    execution_date<span class="token operator">=</span>dag_model<span class="token punctuation">.</span>next_dagrun<span class="token punctuation">,</span>
                    state<span class="token operator">=</span>DagRunState<span class="token punctuation">.</span>QUEUED<span class="token punctuation">,</span>
                    data_interval<span class="token operator">=</span>data_interval<span class="token punctuation">,</span>
                    external_trigger<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                    session<span class="token operator">=</span>session<span class="token punctuation">,</span>
                    dag_hash<span class="token operator">=</span>dag_hash<span class="token punctuation">,</span>
                    creating_job_id<span class="token operator">=</span>self<span class="token punctuation">.</span>job<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                active_runs_of_dags<span class="token punctuation">[</span>dag<span class="token punctuation">.</span>dag_id<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>

            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">&quot;Failed creating DagRun for %s&quot;</span><span class="token punctuation">,</span> dag<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_should_update_dag_next_dagruns<span class="token punctuation">(</span>
            dag<span class="token punctuation">,</span>
            dag_model<span class="token punctuation">,</span>
            last_dag_run<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
            total_active_runs<span class="token operator">=</span>active_runs_of_dags<span class="token punctuation">[</span>dag<span class="token punctuation">.</span>dag_id<span class="token punctuation">]</span><span class="token punctuation">,</span>
            session<span class="token operator">=</span>session<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            dag_model<span class="token punctuation">.</span>calculate_dagrun_date_fields<span class="token punctuation">(</span>dag<span class="token punctuation">,</span> data_interval<span class="token punctuation">)</span>
</code></pre></div><p><strong>最终是通过调用DAG类的create_dagrun方法来创建DagRun实例和添加到数据库。</strong></p> <h4 id="dag-create-dagrun"><a href="#dag-create-dagrun" class="header-anchor">#</a> DAG.create_dagrun</h4> <p>路径：airflow/models/dag.py</p> <p><code>create_dagrun</code> 函数是 Airflow 中 <code>DAG</code> 类的一个方法，用于为 DAG 创建一个新的 DagRun 实例。以下是该方法的关键代码，可以看到create_dagrun方法会创建一个DagRun实例并添加到数据库中，然后返回该实例。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@provide_session</span>
<span class="token keyword">def</span> <span class="token function">create_dagrun</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    state<span class="token punctuation">:</span> DagRunState<span class="token punctuation">,</span>
    execution_date<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    run_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    start_date<span class="token punctuation">:</span> datetime <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    external_trigger<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    conf<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    run_type<span class="token punctuation">:</span> DagRunType <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    session<span class="token punctuation">:</span> Session <span class="token operator">=</span> NEW_SESSION<span class="token punctuation">,</span>
    dag_hash<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    creating_job_id<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    data_interval<span class="token punctuation">:</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span>datetime<span class="token punctuation">,</span> datetime<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 其他代码....</span>

    run <span class="token operator">=</span> DagRun<span class="token punctuation">(</span>
        dag_id<span class="token operator">=</span>self<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span>
        run_id<span class="token operator">=</span>run_id<span class="token punctuation">,</span>
        execution_date<span class="token operator">=</span>logical_date<span class="token punctuation">,</span>
        start_date<span class="token operator">=</span>start_date<span class="token punctuation">,</span>
        external_trigger<span class="token operator">=</span>external_trigger<span class="token punctuation">,</span>
        conf<span class="token operator">=</span>conf<span class="token punctuation">,</span>
        state<span class="token operator">=</span>state<span class="token punctuation">,</span>
        run_type<span class="token operator">=</span>run_type<span class="token punctuation">,</span>
        dag_hash<span class="token operator">=</span>dag_hash<span class="token punctuation">,</span>
        creating_job_id<span class="token operator">=</span>creating_job_id<span class="token punctuation">,</span>
        data_interval<span class="token operator">=</span>data_interval<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>run<span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>

    run<span class="token punctuation">.</span>dag <span class="token operator">=</span> self

    run<span class="token punctuation">.</span>verify_integrity<span class="token punctuation">(</span>session<span class="token operator">=</span>session<span class="token punctuation">)</span>

    <span class="token keyword">return</span> run
</code></pre></div><h3 id="_7、dagrun任务实例调度"><a href="#_7、dagrun任务实例调度" class="header-anchor">#</a> 7、DagRun任务实例调度</h3> <p>对于每个DAG运行实例，Scheduler会根据任务之间的依赖关系安排任务。这一过程涉及到<code>SchedulerJob._schedule_dag_run</code>方法。</p> <p>它会根据DAG中任务之间的依赖关系确定哪些任务应该被执行，并为这些任务创建相应的任务实例。</p> <h4 id="schedulerjobrunner-do-scheduling"><a href="#schedulerjobrunner-do-scheduling" class="header-anchor">#</a> SchedulerJobRunner._do_scheduling</h4> <p>这个方法的主要目的是在 Airflow 调度器中执行调度任务，包括创建和启动 DagRuns、安排任务实例、将回调发送给处理器等。</p> <p>以下是方法的详细解释：</p> <ol><li>使用 <code>prohibit_commit</code> 上下文管理器确保在此代码块中不会意外地提交 session。</li> <li>如果 <code>settings.USE_JOB_SCHEDULE</code> 为 True，则调用 <code>_create_dagruns_for_dags</code> 方法为所有 DAGs 创建 DagRuns。</li> <li>调用 <code>_start_queued_dagruns</code> 方法启动排队的 DagRuns。</li> <li>使用 <code>_get_next_dagruns_to_examine</code> 方法获取要检查的 DagRuns（状态为 RUNNING）。</li> <li>使用 <code>_schedule_all_dag_runs</code> 方法为所有 DagRuns 安排任务实例。</li> <li>创建一个名为 <code>cached_get_dag</code> 的函数，该函数使用 LRU 缓存从 DagBag 中获取 DAG。</li> <li>遍历所有的 DagRuns 和回调函数，从缓存中获取 DAG 并将回调发送给处理器。</li> <li>使用 <code>prohibit_commit</code> 上下文管理器确保在此代码块中不会意外地提交 session。</li> <li>清除 session 中的所有对象。</li> <li>检查执行器是否有可用的插槽数。如果没有，跳过关键部分，将 <code>num_queued_tis</code> 设为 0。</li> <li>如果有可用的插槽数，尝试进入关键部分，并使用计时器记录执行时间。调用 <code>_critical_section_enqueue_task_instances</code> 方法将任务实例添加到队列中。如果发生操作错误（如锁不可用），则捕获异常并根据错误类型进行处理。如果是锁不可用的错误，记录调试日志并将 <code>num_queued_tis</code> 设为 0。否则，抛出异常。</li> <li>提交 session 更改。</li> <li>返回排队的任务实例数量（<code>num_queued_tis</code>）。</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_do_scheduling</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session<span class="token punctuation">:</span> Session<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> prohibit_commit<span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token keyword">as</span> guard<span class="token punctuation">:</span>
        <span class="token keyword">if</span> settings<span class="token punctuation">.</span>USE_JOB_SCHEDULE<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_create_dagruns_for_dags<span class="token punctuation">(</span>guard<span class="token punctuation">,</span> session<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_start_queued_dagruns<span class="token punctuation">(</span>session<span class="token punctuation">)</span>
        guard<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        dag_runs <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_next_dagruns_to_examine<span class="token punctuation">(</span>DagRunState<span class="token punctuation">.</span>RUNNING<span class="token punctuation">,</span> session<span class="token punctuation">)</span>

        callback_tuples <span class="token operator">=</span> self<span class="token punctuation">.</span>_schedule_all_dag_runs<span class="token punctuation">(</span>guard<span class="token punctuation">,</span> dag_runs<span class="token punctuation">,</span> session<span class="token punctuation">)</span>

    cached_get_dag<span class="token punctuation">:</span> Callable<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> DAG <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> lru_cache<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
        partial<span class="token punctuation">(</span>self<span class="token punctuation">.</span>dagbag<span class="token punctuation">.</span>get_dag<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">for</span> dag_run<span class="token punctuation">,</span> callback_to_run <span class="token keyword">in</span> callback_tuples<span class="token punctuation">:</span>
        dag <span class="token operator">=</span> cached_get_dag<span class="token punctuation">(</span>dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> dag<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_send_dag_callbacks_to_processor<span class="token punctuation">(</span>dag<span class="token punctuation">,</span> callback_to_run<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;DAG '%s' not found in serialized_dag table&quot;</span><span class="token punctuation">,</span> dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>

    <span class="token keyword">with</span> prohibit_commit<span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token keyword">as</span> guard<span class="token punctuation">:</span>
        session<span class="token punctuation">.</span>expunge_all<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>slots_available <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Executor full, skipping critical section&quot;</span><span class="token punctuation">)</span>
            num_queued_tis <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                timer <span class="token operator">=</span> Stats<span class="token punctuation">.</span>timer<span class="token punctuation">(</span><span class="token string">&quot;scheduler.critical_section_duration&quot;</span><span class="token punctuation">)</span>
                timer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

                num_queued_tis <span class="token operator">=</span> self<span class="token punctuation">.</span>_critical_section_enqueue_task_instances<span class="token punctuation">(</span>session<span class="token operator">=</span>session<span class="token punctuation">)</span>

                timer<span class="token punctuation">.</span>stop<span class="token punctuation">(</span>send<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> OperationalError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                timer<span class="token punctuation">.</span>stop<span class="token punctuation">(</span>send<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> is_lock_not_available_error<span class="token punctuation">(</span>error<span class="token operator">=</span>e<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Critical section lock held by another Scheduler&quot;</span><span class="token punctuation">)</span>
                    Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">&quot;scheduler.critical_section_busy&quot;</span><span class="token punctuation">)</span>
                    session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token number">0</span>
                <span class="token keyword">raise</span>

        guard<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> num_queued_tis
</code></pre></div><h4 id="schedulerjobrunner-schedule-all-dag-runs"><a href="#schedulerjobrunner-schedule-all-dag-runs" class="header-anchor">#</a> SchedulerJobRunner._schedule_all_dag_runs</h4> <p>这段代码定义了一个名为 <code>_schedule_all_dag_runs</code> 的方法，它对一组 DAG 运行实例（DagRun）进行调度决策。这个方法接收三个参数：一个是 <code>guard</code>，代表一个禁止提交的保护器（CommitProhibitorGuard）；一个是 <code>dag_runs</code>，代表一个可迭代的 DAG 运行实例集合；另一个是 <code>session</code>，代表数据库会话。</p> <p>下图是，在该函数中，任务实例状态发生的变迁。</p> <img src="/assets/img/4.2.2 任务实例状态变迁-0.4ed77f2d.png" alt="image-20240326195129120" style="zoom:50%;"> <p>以下是具体的步骤：</p> <ol><li>使用列表推导式遍历 <code>dag_runs</code>，对每个 DAG 运行实例调用 <code>_schedule_dag_run</code> 方法进行调度决策。将每个 DAG 运行实例及其对应的回调函数（如果有的话）组成一个元组，添加到列表 <code>callback_tuples</code> 中。</li> <li>提交 <code>guard</code> 保护的事务。</li> <li>返回 <code>callback_tuples</code> 列表。</li></ol> <p>这个方法的返回值是一个列表，其中的每个元素都是一个包含两个元素的元组。第一个元素是一个 DAG 运行实例，第二个元素是一个 <code>DagCallbackRequest</code> 对象（表示需要执行的回调函数）或者是 <code>None</code>（表示没有需要执行的回调函数）。</p> <p>注意，这个方法使用了一个名为 <code>retry_db_transaction</code> 的装饰器。这个装饰器的作用是在数据库事务失败时自动重试该方法。这样可以确保在遇到数据库事务问题时，调度器仍然可以正常工作。</p> <p>文件路径：airflow/jobs/scheduler_job_runner.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@retry_db_transaction</span>
<span class="token keyword">def</span> <span class="token function">_schedule_all_dag_runs</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    guard<span class="token punctuation">:</span> CommitProhibitorGuard<span class="token punctuation">,</span>
    dag_runs<span class="token punctuation">:</span> Iterable<span class="token punctuation">[</span>DagRun<span class="token punctuation">]</span><span class="token punctuation">,</span>
    session<span class="token punctuation">:</span> Session<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span>DagRun<span class="token punctuation">,</span> DagCallbackRequest <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Make scheduling decisions for all `dag_runs`.&quot;&quot;&quot;</span>
    callback_tuples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>run<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_schedule_dag_run<span class="token punctuation">(</span>run<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> run <span class="token keyword">in</span> dag_runs<span class="token punctuation">]</span>
    guard<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> callback_tuples
</code></pre></div><h4 id="schedulerjobrunner-schedule-dag-run"><a href="#schedulerjobrunner-schedule-dag-run" class="header-anchor">#</a> SchedulerJobRunner._schedule_dag_run</h4> <p>这段代码定义了一个名为 <code>_schedule_dag_run</code> 的方法，这个方法对单个的 DAG 运行实例（DagRun）进行调度决策。这个方法接收两个参数：一个是 <code>dag_run</code>，代表需要调度的 DAG 运行实例；另一个是 <code>session</code>，代表数据库会话。</p> <p>以下是具体的步骤：</p> <ol><li><p>从 DAG 包（DagBag）和数据库中获取对应的 DAG 和 DAG 模型（DagModel）。如果找不到，就记录错误日志并返回。</p></li> <li><p>检查 DAG 运行实例是否超时。如果 DAG 运行实例已经开始，并且设置了超时时间，且开始时间早于当前时间减去超时时间，那么就将 DAG 运行实例的状态设置为失败（FAILED）。然后，将所有未完成的任务实例（TaskInstance）的状态设置为跳过（SKIPPED），并将这些更改保存到数据库。最后，记录日志，表示 DAG 运行实例已经超时。</p></li> <li><p>如果 DAG 运行实例的执行日期晚于当前时间，并且 DAG 不允许未来的执行日期，那么就记录错误日志并返回。</p></li> <li><p>如果 DAG 发生了变化，那么就验证 DAG 的完整性。如果在验证过程中 DAG 消失了，那么就记录警告日志并返回。</p></li> <li><p>调用<code>dag_run.update_state</code>方法，更新 DAG 运行实例的状态，并获取可以调度的任务实例和需要运行的回调函数。</p> <p>该方法根据其任务实例（TaskInstances）的状态进行判断。这个方法会检查所有任务实例的状态，如果所有任务实例都成功，那么 DagRun 就标记为成功；如果有任何一个任务实例失败，那么 DagRun 就标记为失败；如果所有任务实例都处于死锁状态，那么 DagRun 就标记为失败；否则， DagRun 的状态就被标记为运行中。</p></li> <li><p>如果需要更新 DAG 的下一个运行日期，那么就计算下一个运行日期。</p></li> <li><p>调用<code>dag_run.schedule_tis</code>方法，调度可以调度的任务实例。</p></li> <li><p>返回需要运行的回调函数。</p></li></ol> <p>这个方法的返回值是一个 <code>DagCallbackRequest</code> 对象，表示需要执行的回调函数，或者是 <code>None</code>，表示没有需要执行的回调函数。</p> <p>文件路径：airflow/jobs/scheduler_job_runner.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_schedule_dag_run</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    dag_run<span class="token punctuation">:</span> DagRun<span class="token punctuation">,</span>
    session<span class="token punctuation">:</span> Session<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> DagCallbackRequest <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    callback<span class="token punctuation">:</span> DagCallbackRequest <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    dag <span class="token operator">=</span> dag_run<span class="token punctuation">.</span>dag <span class="token operator">=</span> self<span class="token punctuation">.</span>dagbag<span class="token punctuation">.</span>get_dag<span class="token punctuation">(</span>dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
    dag_model <span class="token operator">=</span> DM<span class="token punctuation">.</span>get_dagmodel<span class="token punctuation">(</span>dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> session<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> dag <span class="token keyword">or</span> <span class="token keyword">not</span> dag_model<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;Couldn't find DAG %s in DAG bag or database!&quot;</span><span class="token punctuation">,</span> dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> callback

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        dag_run<span class="token punctuation">.</span>start_date
        <span class="token keyword">and</span> dag<span class="token punctuation">.</span>dagrun_timeout
        <span class="token keyword">and</span> dag_run<span class="token punctuation">.</span>start_date <span class="token operator">&lt;</span> timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dag<span class="token punctuation">.</span>dagrun_timeout
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        dag_run<span class="token punctuation">.</span>set_state<span class="token punctuation">(</span>DagRunState<span class="token punctuation">.</span>FAILED<span class="token punctuation">)</span>
        unfinished_task_instances <span class="token operator">=</span> session<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span>
            select<span class="token punctuation">(</span>TI<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>dag_id <span class="token operator">==</span> dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>run_id <span class="token operator">==</span> dag_run<span class="token punctuation">.</span>run_id<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>state<span class="token punctuation">.</span>in_<span class="token punctuation">(</span>State<span class="token punctuation">.</span>unfinished<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">for</span> task_instance <span class="token keyword">in</span> unfinished_task_instances<span class="token punctuation">:</span>
            task_instance<span class="token punctuation">.</span>state <span class="token operator">=</span> TaskInstanceState<span class="token punctuation">.</span>SKIPPED
            session<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>task_instance<span class="token punctuation">)</span>
        session<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Run %s of %s has timed-out&quot;</span><span class="token punctuation">,</span> dag_run<span class="token punctuation">.</span>run_id<span class="token punctuation">,</span> dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_should_update_dag_next_dagruns<span class="token punctuation">(</span>dag<span class="token punctuation">,</span> dag_model<span class="token punctuation">,</span> last_dag_run<span class="token operator">=</span>dag_run<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
            dag_model<span class="token punctuation">.</span>calculate_dagrun_date_fields<span class="token punctuation">(</span>dag<span class="token punctuation">,</span> dag<span class="token punctuation">.</span>get_run_data_interval<span class="token punctuation">(</span>dag_run<span class="token punctuation">)</span><span class="token punctuation">)</span>

        callback_to_execute <span class="token operator">=</span> DagCallbackRequest<span class="token punctuation">(</span>
            full_filepath<span class="token operator">=</span>dag<span class="token punctuation">.</span>fileloc<span class="token punctuation">,</span>
            dag_id<span class="token operator">=</span>dag<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span>
            run_id<span class="token operator">=</span>dag_run<span class="token punctuation">.</span>run_id<span class="token punctuation">,</span>
            is_failure_callback<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            processor_subdir<span class="token operator">=</span>dag_model<span class="token punctuation">.</span>processor_subdir<span class="token punctuation">,</span>
            msg<span class="token operator">=</span><span class="token string">&quot;timed_out&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        dag_run<span class="token punctuation">.</span>notify_dagrun_state_changed<span class="token punctuation">(</span><span class="token punctuation">)</span>
        duration <span class="token operator">=</span> dag_run<span class="token punctuation">.</span>end_date <span class="token operator">-</span> dag_run<span class="token punctuation">.</span>start_date
        Stats<span class="token punctuation">.</span>timing<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;dagrun.duration.failed.</span><span class="token interpolation"><span class="token punctuation">{</span>dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
        Stats<span class="token punctuation">.</span>timing<span class="token punctuation">(</span><span class="token string">&quot;dagrun.duration.failed&quot;</span><span class="token punctuation">,</span> duration<span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;dag_id&quot;</span><span class="token punctuation">:</span> dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> callback_to_execute

    <span class="token keyword">if</span> dag_run<span class="token punctuation">.</span>execution_date <span class="token operator">&gt;</span> timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> dag<span class="token punctuation">.</span>allow_future_exec_dates<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;Execution date is in future: %s&quot;</span><span class="token punctuation">,</span> dag_run<span class="token punctuation">.</span>execution_date<span class="token punctuation">)</span>
        <span class="token keyword">return</span> callback

    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_verify_integrity_if_dag_changed<span class="token punctuation">(</span>dag_run<span class="token operator">=</span>dag_run<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">&quot;The DAG disappeared before verifying integrity: %s. Skipping.&quot;</span><span class="token punctuation">,</span> dag_run<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> callback

    schedulable_tis<span class="token punctuation">,</span> callback_to_run <span class="token operator">=</span> dag_run<span class="token punctuation">.</span>update_state<span class="token punctuation">(</span>session<span class="token operator">=</span>session<span class="token punctuation">,</span> execute_callbacks<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_should_update_dag_next_dagruns<span class="token punctuation">(</span>dag<span class="token punctuation">,</span> dag_model<span class="token punctuation">,</span> last_dag_run<span class="token operator">=</span>dag_run<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dag_model<span class="token punctuation">.</span>calculate_dagrun_date_fields<span class="token punctuation">(</span>dag<span class="token punctuation">,</span> dag<span class="token punctuation">.</span>get_run_data_interval<span class="token punctuation">(</span>dag_run<span class="token punctuation">)</span><span class="token punctuation">)</span>

    dag_run<span class="token punctuation">.</span>schedule_tis<span class="token punctuation">(</span>schedulable_tis<span class="token punctuation">,</span> session<span class="token punctuation">,</span> max_tis_per_query<span class="token operator">=</span>self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>max_tis_per_query<span class="token punctuation">)</span>

    <span class="token keyword">return</span> callback_to_run
</code></pre></div><p>在<code>dag_run.update_state</code>方法中我们看到它返回了可调度的任务实例，也就是这里会决定当前DagRun任务实例（TaskInstances）的调度决策信息。该方法里主要通过调用<code>task_instance_scheduling_decisions</code>实现。</p> <h4 id="dagrun-task-instance-scheduling-decisions"><a href="#dagrun-task-instance-scheduling-decisions" class="header-anchor">#</a> DagRun.task_instance_scheduling_decisions</h4> <p><code>task_instance_scheduling_decisions</code> 方法用于获取 DAG 运行实例（DagRun）的任务实例（TaskInstances）的调度决策信息。它首先获取所有任务实例，然后排除在 DAG 中找不到的任务实例。接着，将任务实例分为未完成的和已完成的两组。对于未完成的任务实例，选择状态为可调度（scheduled）的任务实例，并获取准备好的任务实例。最后，返回一个包含所有任务实例、可调度的任务实例、已更改的任务实例、未完成的任务实例和已完成的任务实例的 <code>TISchedulingDecision</code> 对象。</p> <p>下面是每个代码的分段解释：</p> <ol><li>调用 <code>get_task_instances</code> 方法获取所有状态为 <code>State.task_states</code> 的任务实例。</li> <li>定义一个名为 <code>_filter_tis_and_exclude_removed</code> 的函数，用于获取任务实例对应的任务，并排除那些在 DAG 中找不到的任务实例。如果任务实例的状态不是已移除（REMOVED），那么就将其状态设置为已移除，并保存到数据库。</li> <li>调用 <code>_filter_tis_and_exclude_removed</code> 函数处理任务实例。</li> <li>将任务实例分为未完成的和已完成的两组。</li> <li>如果有未完成的任务实例，那么就从中选择状态为可调度的任务实例，并调用 <code>_get_ready_tis</code> 方法获取准备好的任务实例。如果在这个过程中发生了扩展，那么就重新计算未完成的和已完成的任务实例。</li> <li>如果没有未完成的任务实例，那么就将可调度的任务实例和已更改的任务实例设置为空。</li> <li>返回一个 <code>TISchedulingDecision</code> 对象，包含所有任务实例、可调度的任务实例、已更改的任务实例、未完成的任务实例和已完成的任务实例。</li></ol> <p>这个方法的返回值是一个 <code>TISchedulingDecision</code> 对象，表示任务实例的调度决策信息。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@provide_session</span>
<span class="token keyword">def</span> <span class="token function">task_instance_scheduling_decisions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session<span class="token punctuation">:</span> Session <span class="token operator">=</span> NEW_SESSION<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TISchedulingDecision<span class="token punctuation">:</span>
    tis <span class="token operator">=</span> self<span class="token punctuation">.</span>get_task_instances<span class="token punctuation">(</span>session<span class="token operator">=</span>session<span class="token punctuation">,</span> state<span class="token operator">=</span>State<span class="token punctuation">.</span>task_states<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;number of tis tasks for %s: %s task(s)&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tis<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_filter_tis_and_exclude_removed</span><span class="token punctuation">(</span>dag<span class="token punctuation">:</span> DAG<span class="token punctuation">,</span> tis<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TI<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Iterable<span class="token punctuation">[</span>TI<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Populate ``ti.task`` while excluding those missing one, marking them as REMOVED.&quot;&quot;&quot;</span>
        <span class="token keyword">for</span> ti <span class="token keyword">in</span> tis<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                ti<span class="token punctuation">.</span>task <span class="token operator">=</span> dag<span class="token punctuation">.</span>get_task<span class="token punctuation">(</span>ti<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span>
            <span class="token keyword">except</span> TaskNotFound<span class="token punctuation">:</span>
                <span class="token keyword">if</span> ti<span class="token punctuation">.</span>state <span class="token operator">!=</span> TaskInstanceState<span class="token punctuation">.</span>REMOVED<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;Failed to get task for ti %s. Marking it as removed.&quot;</span><span class="token punctuation">,</span> ti<span class="token punctuation">)</span>
                    ti<span class="token punctuation">.</span>state <span class="token operator">=</span> TaskInstanceState<span class="token punctuation">.</span>REMOVED
                    session<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">yield</span> ti

    tis <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>_filter_tis_and_exclude_removed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_dag<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tis<span class="token punctuation">)</span><span class="token punctuation">)</span>

    unfinished_tis <span class="token operator">=</span> <span class="token punctuation">[</span>t <span class="token keyword">for</span> t <span class="token keyword">in</span> tis <span class="token keyword">if</span> t<span class="token punctuation">.</span>state <span class="token keyword">in</span> State<span class="token punctuation">.</span>unfinished<span class="token punctuation">]</span>
    finished_tis <span class="token operator">=</span> <span class="token punctuation">[</span>t <span class="token keyword">for</span> t <span class="token keyword">in</span> tis <span class="token keyword">if</span> t<span class="token punctuation">.</span>state <span class="token keyword">in</span> State<span class="token punctuation">.</span>finished<span class="token punctuation">]</span>
    <span class="token keyword">if</span> unfinished_tis<span class="token punctuation">:</span>
        schedulable_tis <span class="token operator">=</span> <span class="token punctuation">[</span>ut <span class="token keyword">for</span> ut <span class="token keyword">in</span> unfinished_tis <span class="token keyword">if</span> ut<span class="token punctuation">.</span>state <span class="token keyword">in</span> SCHEDULEABLE_STATES<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;number of scheduleable tasks for %s: %s task(s)&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>schedulable_tis<span class="token punctuation">)</span><span class="token punctuation">)</span>
        schedulable_tis<span class="token punctuation">,</span> changed_tis<span class="token punctuation">,</span> expansion_happened <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_ready_tis<span class="token punctuation">(</span>
            schedulable_tis<span class="token punctuation">,</span>
            finished_tis<span class="token punctuation">,</span>
            session<span class="token operator">=</span>session<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> expansion_happened<span class="token punctuation">:</span>
            changed_tis <span class="token operator">=</span> <span class="token boolean">True</span>
            new_unfinished_tis <span class="token operator">=</span> <span class="token punctuation">[</span>t <span class="token keyword">for</span> t <span class="token keyword">in</span> unfinished_tis <span class="token keyword">if</span> t<span class="token punctuation">.</span>state <span class="token keyword">in</span> State<span class="token punctuation">.</span>unfinished<span class="token punctuation">]</span>
            finished_tis<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>t <span class="token keyword">for</span> t <span class="token keyword">in</span> unfinished_tis <span class="token keyword">if</span> t<span class="token punctuation">.</span>state <span class="token keyword">in</span> State<span class="token punctuation">.</span>finished<span class="token punctuation">)</span>
            unfinished_tis <span class="token operator">=</span> new_unfinished_tis
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        schedulable_tis <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        changed_tis <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword">return</span> TISchedulingDecision<span class="token punctuation">(</span>
        tis<span class="token operator">=</span>tis<span class="token punctuation">,</span>
        schedulable_tis<span class="token operator">=</span>schedulable_tis<span class="token punctuation">,</span>
        changed_tis<span class="token operator">=</span>changed_tis<span class="token punctuation">,</span>
        unfinished_tis<span class="token operator">=</span>unfinished_tis<span class="token punctuation">,</span>
        finished_tis<span class="token operator">=</span>finished_tis<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre></div><h4 id="dagrun-schedule-tis"><a href="#dagrun-schedule-tis" class="header-anchor">#</a> DagRun.schedule_tis</h4> <p>这段代码定义了一个名为 <code>schedule_tis</code> 的方法，它负责将给定的任务实例（TaskInstances，简称 TIs）设置为调度状态（SCHEDULED）。这个方法接收三个参数：一个是 <code>schedulable_tis</code>，代表可调度的任务实例集合；一个是 <code>session</code>，代表数据库会话；另一个是 <code>max_tis_per_query</code>，代表每个查询中最多处理的任务实例数量。</p> <p>以下是具体的步骤：</p> <ol><li>遍历 <code>schedulable_tis</code>，将不需要执行的任务实例（如使用 EmptyOperator 且没有回调函数或出口的任务实例）添加到 <code>dummy_ti_ids</code> 列表中，将需要执行的任务实例添加到 <code>schedulable_ti_ids</code> 列表中。</li> <li>初始化计数器 <code>count</code> 为 0。</li> <li>如果有需要执行的任务实例，那么将 <code>schedulable_ti_ids</code> 列表分割成多个块（每个块的大小由 <code>max_tis_per_query</code> 决定），然后遍历这些块，对每个块执行更新操作，将任务实例的状态设置为调度状态（SCHEDULED），并累加影响的行数到计数器 <code>count</code>。</li> <li>如果有不需要执行的任务实例（如使用 EmptyOperator 的任务实例），那么将 <code>dummy_ti_ids</code> 列表分割成多个块（每个块的大小由 <code>max_tis_per_query</code> 决定），然后遍历这些块，对每个块执行更新操作，将任务实例的状态设置为成功状态（SUCCESS），并设置开始时间、结束时间和持续时间为 0，同时累加影响的行数到计数器 <code>count</code>。</li> <li>返回计数器 <code>count</code> 的值，表示本次调度的任务实例数量。</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@provide_session</span>
<span class="token keyword">def</span> <span class="token function">schedule_tis</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    schedulable_tis<span class="token punctuation">:</span> Iterable<span class="token punctuation">[</span>TI<span class="token punctuation">]</span><span class="token punctuation">,</span>
    session<span class="token punctuation">:</span> Session <span class="token operator">=</span> NEW_SESSION<span class="token punctuation">,</span>
    max_tis_per_query<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    dummy_ti_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    schedulable_ti_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> ti <span class="token keyword">in</span> schedulable_tis<span class="token punctuation">:</span>
        <span class="token keyword">if</span> TYPE_CHECKING<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> ti<span class="token punctuation">.</span>task
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
            ti<span class="token punctuation">.</span>task<span class="token punctuation">.</span>inherits_from_empty_operator
            <span class="token keyword">and</span> <span class="token keyword">not</span> ti<span class="token punctuation">.</span>task<span class="token punctuation">.</span>on_execute_callback
            <span class="token keyword">and</span> <span class="token keyword">not</span> ti<span class="token punctuation">.</span>task<span class="token punctuation">.</span>on_success_callback
            <span class="token keyword">and</span> <span class="token keyword">not</span> ti<span class="token punctuation">.</span>task<span class="token punctuation">.</span>outlets
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            dummy_ti_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>ti<span class="token punctuation">.</span>task_id<span class="token punctuation">,</span> ti<span class="token punctuation">.</span>map_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            schedulable_ti_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>ti<span class="token punctuation">.</span>task_id<span class="token punctuation">,</span> ti<span class="token punctuation">.</span>map_index<span class="token punctuation">)</span><span class="token punctuation">)</span>

    count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">if</span> schedulable_ti_ids<span class="token punctuation">:</span>
        schedulable_ti_ids_chunks <span class="token operator">=</span> chunks<span class="token punctuation">(</span>
            schedulable_ti_ids<span class="token punctuation">,</span> max_tis_per_query <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>schedulable_ti_ids<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">for</span> schedulable_ti_ids_chunk <span class="token keyword">in</span> schedulable_ti_ids_chunks<span class="token punctuation">:</span>
            count <span class="token operator">+=</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
                update<span class="token punctuation">(</span>TI<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>where<span class="token punctuation">(</span>
                    TI<span class="token punctuation">.</span>dag_id <span class="token operator">==</span> self<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span>
                    TI<span class="token punctuation">.</span>run_id <span class="token operator">==</span> self<span class="token punctuation">.</span>run_id<span class="token punctuation">,</span>
                    tuple_in_condition<span class="token punctuation">(</span><span class="token punctuation">(</span>TI<span class="token punctuation">.</span>task_id<span class="token punctuation">,</span> TI<span class="token punctuation">.</span>map_index<span class="token punctuation">)</span><span class="token punctuation">,</span> schedulable_ti_ids_chunk<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>values<span class="token punctuation">(</span>state<span class="token operator">=</span>TaskInstanceState<span class="token punctuation">.</span>SCHEDULED<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>execution_options<span class="token punctuation">(</span>synchronize_session<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span>rowcount

    <span class="token keyword">if</span> dummy_ti_ids<span class="token punctuation">:</span>
        dummy_ti_ids_chunks <span class="token operator">=</span> chunks<span class="token punctuation">(</span>dummy_ti_ids<span class="token punctuation">,</span> max_tis_per_query <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dummy_ti_ids<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> dummy_ti_ids_chunk <span class="token keyword">in</span> dummy_ti_ids_chunks<span class="token punctuation">:</span>
            count <span class="token operator">+=</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
                update<span class="token punctuation">(</span>TI<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>where<span class="token punctuation">(</span>
                    TI<span class="token punctuation">.</span>dag_id <span class="token operator">==</span> self<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span>
                    TI<span class="token punctuation">.</span>run_id <span class="token operator">==</span> self<span class="token punctuation">.</span>run_id<span class="token punctuation">,</span>
                    tuple_in_condition<span class="token punctuation">(</span><span class="token punctuation">(</span>TI<span class="token punctuation">.</span>task_id<span class="token punctuation">,</span> TI<span class="token punctuation">.</span>map_index<span class="token punctuation">)</span><span class="token punctuation">,</span> dummy_ti_ids_chunk<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>values<span class="token punctuation">(</span>
                    state<span class="token operator">=</span>TaskInstanceState<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span>
                    start_date<span class="token operator">=</span>timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    end_date<span class="token operator">=</span>timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    duration<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>execution_options<span class="token punctuation">(</span>
                    synchronize_session<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span>rowcount

    <span class="token keyword">return</span> count
</code></pre></div><h3 id="_8、dagrun任务实例入队列"><a href="#_8、dagrun任务实例入队列" class="header-anchor">#</a> 8、DagRun任务实例入队列</h3> <p>在Airflow中，任务实例的处理主要在<code>SchedulerJob._do_scheduling</code>方法中进行，它会根据DAG中任务之间的依赖关系以及任务实例的状态来决定哪些任务实例应该被执行。</p> <p>在<code>_do_scheduling</code>方法中，会调用<code>_executable_task_instances_to_queued</code>方法来获取可执行的任务实例，并将它们放入队列中等待执行。然后，调用<code>_enqueue_task_instances_with_queued_state</code>方法将这些任务实例发送到执行器（如LocalExecutor、CeleryExecutor等）进行执行。</p> <p>对于每个任务实例，其执行过程是在<code>BaseOperator.execute</code>方法中进行的。这个方法会调用具体的操作符类（如PythonOperator、BashOperator等）的<code>execute</code>方法来执行任务。</p> <h4 id="schedulerjobrunner-critical-section-enqueue-task-instances"><a href="#schedulerjobrunner-critical-section-enqueue-task-instances" class="header-anchor">#</a> SchedulerJobRunner._critical_section_enqueue_task_instances</h4> <p>它负责将任务实例（TaskInstances，简称 TIs）排入执行队列。下图是任务实例在该函数的转变。</p> <img src="/assets/img/4.2.2 任务实例状态变迁.e5fdeec4.png" alt="image-20240326194806393" style="zoom:50%;"> <p>以下是具体的步骤：</p> <ol><li>根据 <code>max_tis_per_query</code> 和执行器的可用插槽数确定本次可以处理的最大任务实例数量。</li> <li>调用 <code>_executable_task_instances_to_queued</code> 方法获取需要排入队列的任务实例。</li> <li>调用 <code>_enqueue_task_instances_with_queued_state</code> 方法将任务实例排入执行队列。</li></ol> <p>这个方法的返回值是一个整数，表示本次排入队列的任务实例数量。</p> <p>注意，这个方法是一个关键部分，也就是说，在同一时间只能有一个执行器executor进程执行这个方法。这是通过执行 <code>SELECT ... from pool FOR UPDATE</code> 实现的。对于支持 NOWAIT 的数据库，如果一个调度器被阻塞，那么它会跳过这个关键部分，继续执行其他任务（如创建新的 DAG 运行实例，将任务实例的状态从 None 进行到 SCHEDULED 等）；对于不支持这个特性的数据库（如 MariaDB 或 MySQL 5.x），其他的调度器会等待锁释放后才能继续执行。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_critical_section_enqueue_task_instances</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session<span class="token punctuation">:</span> Session<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>max_tis_per_query <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        max_tis <span class="token operator">=</span> self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>slots_available
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        max_tis <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>max_tis_per_query<span class="token punctuation">,</span> self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>slots_available<span class="token punctuation">)</span>
    queued_tis <span class="token operator">=</span> self<span class="token punctuation">.</span>_executable_task_instances_to_queued<span class="token punctuation">(</span>max_tis<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>_enqueue_task_instances_with_queued_state<span class="token punctuation">(</span>queued_tis<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>queued_tis<span class="token punctuation">)</span>
</code></pre></div><h4 id="schedulerjobrunner-executable-task-instances-to-queued"><a href="#schedulerjobrunner-executable-task-instances-to-queued" class="header-anchor">#</a> SchedulerJobRunner._executable_task_instances_to_queued</h4> <p>它负责根据各种条件找到准备好执行的任务实例（TaskInstances，简称 TIs），并将它们设置为排队状态（QUEUED）。</p> <p>以下是具体的步骤：</p> <ol><li>从 <code>Pool</code> 表中获取所有的资源池信息。</li> <li>计算所有资源池的可用插槽数，并检查是否有空闲插槽。如果没有空闲插槽，直接返回空列表。</li> <li>根据 <code>max_tis</code> 参数限制最大处理任务实例数量。</li> <li>初始化各种集合，用于存储无法排队的任务实例（如资源池饱和、DAG 最大活动任务限制、执行器状态、优先级、每个 DAG 最大活动任务实例数、每个 DAG 运行实例最大活动任务实例数等）。</li> <li>使用循环查询数据库，获取符合条件的任务实例。条件包括：任务实例状态为 SCHEDULED，DAG 运行实例状态为 RUNNING，DAG 没有暂停，以及排除上述集合中无法排队的任务实例。查询结果按优先级、执行日期和映射索引排序。</li> <li>遍历查询到的任务实例，检查它们是否满足资源池限制、DAG 最大活动任务限制、任务并发限制等条件。如果满足条件，将任务实例添加到 <code>executable_tis</code> 列表中，并更新资源池的可用插槽数、DAG 活动任务数、任务并发数等信息。</li> <li>如果在一次循环中没有找到可执行的任务实例，或者任务实例的数量小于 <code>max_tis</code>，那么就结束循环。否则，继续下一轮循环，查询更多符合条件的任务实例。</li> <li>遍历 <code>executable_tis</code> 列表，将任务实例的状态设置为排队状态（QUEUED），并更新排队时间和排队作业 ID。同时，发送任务实例状态更改的度量信息。</li> <li>返回 <code>executable_tis</code> 列表，即准备好执行的任务实例。</li></ol> <p>这个方法的返回值是一个任务实例列表，表示准备好执行的任务实例。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_executable_task_instances_to_queued</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_tis<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> session<span class="token punctuation">:</span> Session<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TI<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>pool <span class="token keyword">import</span> Pool
    <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>db <span class="token keyword">import</span> DBLocks

    executable_tis<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TI<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> session<span class="token punctuation">.</span>get_bind<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dialect<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;postgresql&quot;</span><span class="token punctuation">:</span>
        lock_acquired <span class="token operator">=</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
            text<span class="token punctuation">(</span><span class="token string">&quot;SELECT pg_try_advisory_xact_lock(:id)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bindparams<span class="token punctuation">(</span>
                <span class="token builtin">id</span><span class="token operator">=</span>DBLocks<span class="token punctuation">.</span>SCHEDULER_CRITICAL_SECTION<span class="token punctuation">.</span>value
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> lock_acquired<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> OperationalError<span class="token punctuation">(</span>
                <span class="token string">&quot;Failed to acquire advisory lock&quot;</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> orig<span class="token operator">=</span>RuntimeError<span class="token punctuation">(</span><span class="token string">&quot;55P03&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

    pools <span class="token operator">=</span> Pool<span class="token punctuation">.</span>slots_stats<span class="token punctuation">(</span>lock_rows<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>

    pool_slots_free <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pool<span class="token punctuation">[</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> pool <span class="token keyword">in</span> pools<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> pool_slots_free <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;All pools are full!&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    max_tis <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>max_tis<span class="token punctuation">,</span> pool_slots_free<span class="token punctuation">)</span>

    starved_pools <span class="token operator">=</span> <span class="token punctuation">{</span>pool_name <span class="token keyword">for</span> pool_name<span class="token punctuation">,</span> stats <span class="token keyword">in</span> pools<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> stats<span class="token punctuation">[</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">}</span>

    concurrency_map <span class="token operator">=</span> self<span class="token punctuation">.</span>__get_concurrency_maps<span class="token punctuation">(</span>states<span class="token operator">=</span>EXECUTION_STATES<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>

    num_starving_tasks_total <span class="token operator">=</span> <span class="token number">0</span>

    starved_dags<span class="token punctuation">:</span> <span class="token builtin">set</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    starved_tasks<span class="token punctuation">:</span> <span class="token builtin">set</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    starved_tasks_task_dagrun_concurrency<span class="token punctuation">:</span> <span class="token builtin">set</span><span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    pool_num_starving_tasks<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> loop_count <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>count<span class="token punctuation">(</span>start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        num_starved_pools <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>starved_pools<span class="token punctuation">)</span>
        num_starved_dags <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>starved_dags<span class="token punctuation">)</span>
        num_starved_tasks <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>starved_tasks<span class="token punctuation">)</span>
        num_starved_tasks_task_dagrun_concurrency <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>starved_tasks_task_dagrun_concurrency<span class="token punctuation">)</span>

        query <span class="token operator">=</span> <span class="token punctuation">(</span>
            select<span class="token punctuation">(</span>TI<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>with_hint<span class="token punctuation">(</span>TI<span class="token punctuation">,</span> <span class="token string">&quot;USE INDEX (ti_state)&quot;</span><span class="token punctuation">,</span> dialect_name<span class="token operator">=</span><span class="token string">&quot;mysql&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>join<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>dag_run<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>DR<span class="token punctuation">.</span>run_type <span class="token operator">!=</span> DagRunType<span class="token punctuation">.</span>BACKFILL_JOB<span class="token punctuation">,</span> DR<span class="token punctuation">.</span>state <span class="token operator">==</span> DagRunState<span class="token punctuation">.</span>RUNNING<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>join<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>dag_model<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>not_<span class="token punctuation">(</span>DM<span class="token punctuation">.</span>is_paused<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>state <span class="token operator">==</span> TaskInstanceState<span class="token punctuation">.</span>SCHEDULED<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>options<span class="token punctuation">(</span>selectinload<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>dag_model<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token operator">-</span>TI<span class="token punctuation">.</span>priority_weight<span class="token punctuation">,</span> DR<span class="token punctuation">.</span>execution_date<span class="token punctuation">,</span> TI<span class="token punctuation">.</span>map_index<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> starved_pools<span class="token punctuation">:</span>
            query <span class="token operator">=</span> query<span class="token punctuation">.</span>where<span class="token punctuation">(</span>not_<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>in_<span class="token punctuation">(</span>starved_pools<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> starved_dags<span class="token punctuation">:</span>
            query <span class="token operator">=</span> query<span class="token punctuation">.</span>where<span class="token punctuation">(</span>not_<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>dag_id<span class="token punctuation">.</span>in_<span class="token punctuation">(</span>starved_dags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> starved_tasks<span class="token punctuation">:</span>
            task_filter <span class="token operator">=</span> tuple_in_condition<span class="token punctuation">(</span><span class="token punctuation">(</span>TI<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> TI<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span><span class="token punctuation">,</span> starved_tasks<span class="token punctuation">)</span>
            query <span class="token operator">=</span> query<span class="token punctuation">.</span>where<span class="token punctuation">(</span>not_<span class="token punctuation">(</span>task_filter<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> starved_tasks_task_dagrun_concurrency<span class="token punctuation">:</span>
            task_filter <span class="token operator">=</span> tuple_in_condition<span class="token punctuation">(</span>
                <span class="token punctuation">(</span>TI<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> TI<span class="token punctuation">.</span>run_id<span class="token punctuation">,</span> TI<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
                starved_tasks_task_dagrun_concurrency<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            query <span class="token operator">=</span> query<span class="token punctuation">.</span>where<span class="token punctuation">(</span>not_<span class="token punctuation">(</span>task_filter<span class="token punctuation">)</span><span class="token punctuation">)</span>

        query <span class="token operator">=</span> query<span class="token punctuation">.</span>limit<span class="token punctuation">(</span>max_tis<span class="token punctuation">)</span>

        timer <span class="token operator">=</span> Stats<span class="token punctuation">.</span>timer<span class="token punctuation">(</span><span class="token string">&quot;scheduler.critical_section_query_duration&quot;</span><span class="token punctuation">)</span>
        timer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            query <span class="token operator">=</span> with_row_locks<span class="token punctuation">(</span>query<span class="token punctuation">,</span> of<span class="token operator">=</span>TI<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">,</span> skip_locked<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            task_instances_to_examine<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TI<span class="token punctuation">]</span> <span class="token operator">=</span> session<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            timer<span class="token punctuation">.</span>stop<span class="token punctuation">(</span>send<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> OperationalError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            timer<span class="token punctuation">.</span>stop<span class="token punctuation">(</span>send<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> e


        <span class="token keyword">if</span> <span class="token keyword">not</span> task_instances_to_examine<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;No tasks to consider for execution.&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>

        task_instance_str <span class="token operator">=</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;\t</span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> task_instances_to_examine<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;%s tasks up for execution:\n%s&quot;</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>task_instances_to_examine<span class="token punctuation">)</span><span class="token punctuation">,</span> task_instance_str<span class="token punctuation">)</span>

        <span class="token keyword">for</span> task_instance <span class="token keyword">in</span> task_instances_to_examine<span class="token punctuation">:</span>
            pool_name <span class="token operator">=</span> task_instance<span class="token punctuation">.</span>pool

            pool_stats <span class="token operator">=</span> pools<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pool_name<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> pool_stats<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">&quot;Tasks using non-existent pool '%s' will not be scheduled&quot;</span><span class="token punctuation">,</span> pool_name<span class="token punctuation">)</span>
                starved_pools<span class="token punctuation">.</span>add<span class="token punctuation">(</span>pool_name<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

            pool_num_starving_tasks<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>pool_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

            pool_total <span class="token operator">=</span> pool_stats<span class="token punctuation">[</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">]</span>
            open_slots <span class="token operator">=</span> pool_stats<span class="token punctuation">[</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">]</span>

            <span class="token keyword">if</span> open_slots <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                    <span class="token string">&quot;Not scheduling since there are %s open slots in pool %s&quot;</span><span class="token punctuation">,</span> open_slots<span class="token punctuation">,</span> pool_name
                <span class="token punctuation">)</span>
                pool_num_starving_tasks<span class="token punctuation">[</span>pool_name<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
                num_starving_tasks_total <span class="token operator">+=</span> <span class="token number">1</span>
                starved_pools<span class="token punctuation">.</span>add<span class="token punctuation">(</span>pool_name<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

            <span class="token keyword">if</span> task_instance<span class="token punctuation">.</span>pool_slots <span class="token operator">&gt;</span> pool_total<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>
                    <span class="token string">&quot;Not executing %s. Requested pool slots (%s) are greater than &quot;</span>
                    <span class="token string">&quot;total pool slots: '%s' for pool: %s.&quot;</span><span class="token punctuation">,</span>
                    task_instance<span class="token punctuation">,</span>
                    task_instance<span class="token punctuation">.</span>pool_slots<span class="token punctuation">,</span>
                    pool_total<span class="token punctuation">,</span>
                    pool_name<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>

                pool_num_starving_tasks<span class="token punctuation">[</span>pool_name<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
                num_starving_tasks_total <span class="token operator">+=</span> <span class="token number">1</span>
                starved_tasks<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

            <span class="token keyword">if</span> task_instance<span class="token punctuation">.</span>pool_slots <span class="token operator">&gt;</span> open_slots<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                    <span class="token string">&quot;Not executing %s since it requires %s slots &quot;</span>
                    <span class="token string">&quot;but there are %s open slots in the pool %s.&quot;</span><span class="token punctuation">,</span>
                    task_instance<span class="token punctuation">,</span>
                    task_instance<span class="token punctuation">.</span>pool_slots<span class="token punctuation">,</span>
                    open_slots<span class="token punctuation">,</span>
                    pool_name<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                pool_num_starving_tasks<span class="token punctuation">[</span>pool_name<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
                num_starving_tasks_total <span class="token operator">+=</span> <span class="token number">1</span>
                starved_tasks<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

            dag_id <span class="token operator">=</span> task_instance<span class="token punctuation">.</span>dag_id

            current_active_tasks_per_dag <span class="token operator">=</span> concurrency_map<span class="token punctuation">.</span>dag_active_tasks_map<span class="token punctuation">[</span>dag_id<span class="token punctuation">]</span>
            max_active_tasks_per_dag_limit <span class="token operator">=</span> task_instance<span class="token punctuation">.</span>dag_model<span class="token punctuation">.</span>max_active_tasks
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                <span class="token string">&quot;DAG %s has %s/%s running and queued tasks&quot;</span><span class="token punctuation">,</span>
                dag_id<span class="token punctuation">,</span>
                current_active_tasks_per_dag<span class="token punctuation">,</span>
                max_active_tasks_per_dag_limit<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">if</span> current_active_tasks_per_dag <span class="token operator">&gt;=</span> max_active_tasks_per_dag_limit<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                    <span class="token string">&quot;Not executing %s since the number of tasks running or queued &quot;</span>
                    <span class="token string">&quot;from DAG %s is &gt;= to the DAG's max_active_tasks limit of %s&quot;</span><span class="token punctuation">,</span>
                    task_instance<span class="token punctuation">,</span>
                    dag_id<span class="token punctuation">,</span>
                    max_active_tasks_per_dag_limit<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                starved_dags<span class="token punctuation">.</span>add<span class="token punctuation">(</span>dag_id<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>

            <span class="token keyword">if</span> task_instance<span class="token punctuation">.</span>dag_model<span class="token punctuation">.</span>has_task_concurrency_limits<span class="token punctuation">:</span>
                serialized_dag <span class="token operator">=</span> self<span class="token punctuation">.</span>dagbag<span class="token punctuation">.</span>get_dag<span class="token punctuation">(</span>dag_id<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> serialized_dag<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span>
                        <span class="token string">&quot;DAG '%s' for task instance %s not found in serialized_dag table&quot;</span><span class="token punctuation">,</span>
                        dag_id<span class="token punctuation">,</span>
                        task_instance<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span>
                    session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
                        update<span class="token punctuation">(</span>TI<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span>where<span class="token punctuation">(</span>TI<span class="token punctuation">.</span>dag_id <span class="token operator">==</span> dag_id<span class="token punctuation">,</span> TI<span class="token punctuation">.</span>state <span class="token operator">==</span> TaskInstanceState<span class="token punctuation">.</span>SCHEDULED<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span>values<span class="token punctuation">(</span>state<span class="token operator">=</span>TaskInstanceState<span class="token punctuation">.</span>FAILED<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span>execution_options<span class="token punctuation">(</span>synchronize_session<span class="token operator">=</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span>
                    <span class="token keyword">continue</span>

                task_concurrency_limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span>
                <span class="token keyword">if</span> serialized_dag<span class="token punctuation">.</span>has_task<span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    task_concurrency_limit <span class="token operator">=</span> serialized_dag<span class="token punctuation">.</span>get_task<span class="token punctuation">(</span>
                        task_instance<span class="token punctuation">.</span>task_id
                    <span class="token punctuation">)</span><span class="token punctuation">.</span>max_active_tis_per_dag

                <span class="token keyword">if</span> task_concurrency_limit <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    current_task_concurrency <span class="token operator">=</span> concurrency_map<span class="token punctuation">.</span>task_concurrency_map<span class="token punctuation">[</span>
                        <span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span>
                    <span class="token punctuation">]</span>

                    <span class="token keyword">if</span> current_task_concurrency <span class="token operator">&gt;=</span> task_concurrency_limit<span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                            <span class="token string">&quot;Not executing %s since the task concurrency for&quot;</span>
                            <span class="token string">&quot; this task has been reached.&quot;</span><span class="token punctuation">,</span>
                            task_instance<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                        starved_tasks<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">continue</span>

                task_dagrun_concurrency_limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span>
                <span class="token keyword">if</span> serialized_dag<span class="token punctuation">.</span>has_task<span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    task_dagrun_concurrency_limit <span class="token operator">=</span> serialized_dag<span class="token punctuation">.</span>get_task<span class="token punctuation">(</span>
                        task_instance<span class="token punctuation">.</span>task_id
                    <span class="token punctuation">)</span><span class="token punctuation">.</span>max_active_tis_per_dagrun

                <span class="token keyword">if</span> task_dagrun_concurrency_limit <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    current_task_dagrun_concurrency <span class="token operator">=</span> concurrency_map<span class="token punctuation">.</span>task_dagrun_concurrency_map<span class="token punctuation">[</span>
                        <span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>run_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span>
                    <span class="token punctuation">]</span>

                    <span class="token keyword">if</span> current_task_dagrun_concurrency <span class="token operator">&gt;=</span> task_dagrun_concurrency_limit<span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                            <span class="token string">&quot;Not executing %s since the task concurrency per DAG run for&quot;</span>
                            <span class="token string">&quot; this task has been reached.&quot;</span><span class="token punctuation">,</span>
                            task_instance<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                        starved_tasks_task_dagrun_concurrency<span class="token punctuation">.</span>add<span class="token punctuation">(</span>
                            <span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>run_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
                        <span class="token keyword">continue</span>

            executable_tis<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task_instance<span class="token punctuation">)</span>
            open_slots <span class="token operator">-=</span> task_instance<span class="token punctuation">.</span>pool_slots
            concurrency_map<span class="token punctuation">.</span>dag_active_tasks_map<span class="token punctuation">[</span>dag_id<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
            concurrency_map<span class="token punctuation">.</span>task_concurrency_map<span class="token punctuation">[</span><span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
            concurrency_map<span class="token punctuation">.</span>task_dagrun_concurrency_map<span class="token punctuation">[</span>
                <span class="token punctuation">(</span>task_instance<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>run_id<span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span>
            <span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>

            pool_stats<span class="token punctuation">[</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> open_slots

        is_done <span class="token operator">=</span> executable_tis <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>task_instances_to_examine<span class="token punctuation">)</span> <span class="token operator">&lt;</span> max_tis
        found_new_filters <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token builtin">len</span><span class="token punctuation">(</span>starved_pools<span class="token punctuation">)</span> <span class="token operator">&gt;</span> num_starved_pools
            <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>starved_dags<span class="token punctuation">)</span> <span class="token operator">&gt;</span> num_starved_dags
            <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>starved_tasks<span class="token punctuation">)</span> <span class="token operator">&gt;</span> num_starved_tasks
            <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>starved_tasks_task_dagrun_concurrency<span class="token punctuation">)</span> <span class="token operator">&gt;</span> num_starved_tasks_task_dagrun_concurrency
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> is_done <span class="token keyword">or</span> <span class="token keyword">not</span> found_new_filters<span class="token punctuation">:</span>
            <span class="token keyword">break</span>

        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
            <span class="token string">&quot;Found no task instances to queue on query iteration %s &quot;</span>
            <span class="token string">&quot;but there could be more candidate task instances to check.&quot;</span><span class="token punctuation">,</span>
            loop_count<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">for</span> pool_name<span class="token punctuation">,</span> num_starving_tasks <span class="token keyword">in</span> pool_num_starving_tasks<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        Stats<span class="token punctuation">.</span>gauge<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;pool.starving_tasks.</span><span class="token interpolation"><span class="token punctuation">{</span>pool_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> num_starving_tasks<span class="token punctuation">)</span>
        Stats<span class="token punctuation">.</span>gauge<span class="token punctuation">(</span><span class="token string">&quot;pool.starving_tasks&quot;</span><span class="token punctuation">,</span> num_starving_tasks<span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;pool_name&quot;</span><span class="token punctuation">:</span> pool_name<span class="token punctuation">}</span><span class="token punctuation">)</span>

    Stats<span class="token punctuation">.</span>gauge<span class="token punctuation">(</span><span class="token string">&quot;scheduler.tasks.starving&quot;</span><span class="token punctuation">,</span> num_starving_tasks_total<span class="token punctuation">)</span>
    Stats<span class="token punctuation">.</span>gauge<span class="token punctuation">(</span><span class="token string">&quot;scheduler.tasks.executable&quot;</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>executable_tis<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> executable_tis<span class="token punctuation">:</span>
        task_instance_str <span class="token operator">=</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;\t</span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> executable_tis<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Setting the following tasks to queued state:\n%s&quot;</span><span class="token punctuation">,</span> task_instance_str<span class="token punctuation">)</span>

        filter_for_tis <span class="token operator">=</span> TI<span class="token punctuation">.</span>filter_for_tis<span class="token punctuation">(</span>executable_tis<span class="token punctuation">)</span>
        session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
            update<span class="token punctuation">(</span>TI<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>filter_for_tis<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>values<span class="token punctuation">(</span>
                state<span class="token operator">=</span>TaskInstanceState<span class="token punctuation">.</span>QUEUED<span class="token punctuation">,</span>
                queued_dttm<span class="token operator">=</span>timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                queued_by_job_id<span class="token operator">=</span>self<span class="token punctuation">.</span>job<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span>execution_options<span class="token punctuation">(</span>synchronize_session<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">for</span> ti <span class="token keyword">in</span> executable_tis<span class="token punctuation">:</span>
            ti<span class="token punctuation">.</span>emit_state_change_metric<span class="token punctuation">(</span>TaskInstanceState<span class="token punctuation">.</span>QUEUED<span class="token punctuation">)</span>

    <span class="token keyword">for</span> ti <span class="token keyword">in</span> executable_tis<span class="token punctuation">:</span>
        make_transient<span class="token punctuation">(</span>ti<span class="token punctuation">)</span>
    <span class="token keyword">return</span> executable_tis
</code></pre></div><h4 id="schedulerjobrunner-enqueue-task-instances-with-queued-state"><a href="#schedulerjobrunner-enqueue-task-instances-with-queued-state" class="header-anchor">#</a> SchedulerJobRunner._enqueue_task_instances_with_queued_state</h4> <p>它负责将已经设置为排队状态（QUEUED）的任务实例（TaskInstances，简称 TIs）实际添加到执行器的队列中。</p> <p>以下是具体的步骤：</p> <ol><li>遍历 <code>task_instances</code> 列表。</li> <li>如果任务实例对应的 DAG 运行实例状态已经结束，那么就将任务实例的状态设置为 None，并跳过当前循环。</li> <li>获取任务实例的执行命令、优先级和队列。</li> <li>记录日志，表示正在将任务实例发送到执行器。</li> <li>调用执行器的 <code>queue_command</code> 方法，将任务实例的执行命令添加到队列中。</li></ol> <p>这个方法没有返回值。注意，这个方法需要一个有效的数据库会话，以便更新任务实例的状态。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_enqueue_task_instances_with_queued_state</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task_instances<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TI<span class="token punctuation">]</span><span class="token punctuation">,</span> session<span class="token punctuation">:</span> Session<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> ti <span class="token keyword">in</span> task_instances<span class="token punctuation">:</span>
        <span class="token keyword">if</span> ti<span class="token punctuation">.</span>dag_run<span class="token punctuation">.</span>state <span class="token keyword">in</span> State<span class="token punctuation">.</span>finished_dr_states<span class="token punctuation">:</span>
            ti<span class="token punctuation">.</span>set_state<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        command <span class="token operator">=</span> ti<span class="token punctuation">.</span>command_as_list<span class="token punctuation">(</span>
            local<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            pickle_id<span class="token operator">=</span>ti<span class="token punctuation">.</span>dag_model<span class="token punctuation">.</span>pickle_id<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        priority <span class="token operator">=</span> ti<span class="token punctuation">.</span>priority_weight
        queue <span class="token operator">=</span> ti<span class="token punctuation">.</span>queue
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Sending %s to executor with priority %s and queue %s&quot;</span><span class="token punctuation">,</span> ti<span class="token punctuation">.</span>key<span class="token punctuation">,</span> priority<span class="token punctuation">,</span> queue<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>queue_command<span class="token punctuation">(</span>
            ti<span class="token punctuation">,</span>
            command<span class="token punctuation">,</span>
            priority<span class="token operator">=</span>priority<span class="token punctuation">,</span>
            queue<span class="token operator">=</span>queue<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
</code></pre></div><h4 id="baseexecutor-queue-command"><a href="#baseexecutor-queue-command" class="header-anchor">#</a> BaseExecutor-&gt;queue_command</h4> <p>文件路径：airflow/airflow/executors/base_executor.py</p> <p>在上一步<code>_enqueue_task_instances_with_queued_state</code>函数中，最后调用了Executor的<code>queue_command</code>方法添加到队列中给Executor执行。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">queue_command</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    task_instance<span class="token punctuation">:</span> TaskInstance<span class="token punctuation">,</span>
    command<span class="token punctuation">:</span> CommandType<span class="token punctuation">,</span>
    priority<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    queue<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Queues command to task.&quot;&quot;&quot;</span>
    <span class="token keyword">if</span> task_instance<span class="token punctuation">.</span>key <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>queued_tasks<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Adding to queue: %s&quot;</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>queued_tasks<span class="token punctuation">[</span>task_instance<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>command<span class="token punctuation">,</span> priority<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> task_instance<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;could not queue task %s&quot;</span><span class="token punctuation">,</span> task_instance<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
</code></pre></div><h3 id="_9、dagrun任务实例执行"><a href="#_9、dagrun任务实例执行" class="header-anchor">#</a> 9、DagRun任务实例执行</h3> <p>在前面调用了<code>_do_scheduling</code>调度函数以后，接下来就开始调用Executor执行任务实例。</p> <p>![image-20240325093130562](./img/4.2.2.2 dagrun执行.png)</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_run_scheduler_loop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">with</span> create_session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        num_queued_tis <span class="token operator">=</span> self<span class="token punctuation">.</span>_do_scheduling<span class="token punctuation">(</span>session<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>heartbeat<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>如下图所示，是Airflow源代码中Executor涉及到的关键步骤，下面我们会对这些关键的函数源码展开剖析。</p> <p>我们知道Airflow启动时，默认使用的executor是SequentialExecutor，</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">BaseExecutor</span><span class="token punctuation">(</span>LoggingMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Base class to inherit for concrete executors such as Celery, Kubernetes, Local, Sequential, etc.
    &quot;&quot;&quot;</span>
    <span class="token keyword">def</span> heart_beat
    <span class="token keyword">def</span> trigger_tasks
    <span class="token keyword">def</span> _process_tasks
    <span class="token keyword">def</span> queue_command
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> execute_async
    <span class="token keyword">def</span> sync
    <span class="token keyword">def</span> end
    <span class="token keyword">def</span> terminate
    <span class="token comment"># 其他方法省略...</span>
    
</code></pre></div><p>所以，后面在调用execute_async和sync方法时，就是调用的SequentialExecutor类里的方法。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SequentialExecutor</span><span class="token punctuation">(</span>BaseExecutor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> execute_async
    <span class="token keyword">def</span> sync
    <span class="token keyword">def</span> end
    <span class="token keyword">def</span> terminate
</code></pre></div><img src="/assets/img/4 SenquantialExecutor.5a7eda5b.png" alt="image-20240325090458283" style="zoom:50%;"> <h4 id="baseexecutor-heartbeat"><a href="#baseexecutor-heartbeat" class="header-anchor">#</a> BaseExecutor.heartbeat</h4> <p>它负责发送心跳以触发新的任务。</p> <ol><li><p>通过调用 <code>trigger_tasks</code> 方法，根据可用的插槽数触发新的任务。</p></li> <li><p>调用子类的 <code>sync</code> 方法，用于同步执行器的状态。</p></li></ol> <p>注意，这个方法需要在子类中实现 <code>sync</code> 方法，以便同步执行器的状态。</p> <p>文件路径：airflow/airflow/executors/base_executor.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">BaseExecutor</span><span class="token punctuation">(</span>LoggingMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">heartbeat</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        self<span class="token punctuation">.</span>trigger_tasks<span class="token punctuation">(</span>open_slots<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        self<span class="token punctuation">.</span>sync<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="baseexecutor-trigger-tasks"><a href="#baseexecutor-trigger-tasks" class="header-anchor">#</a> BaseExecutor.trigger_tasks</h4> <p>它负责根据可用的插槽数启动排队任务的异步执行。</p> <p>以下是具体的步骤：</p> <ol><li>按优先级对排队的任务进行排序。</li> <li>遍历排队任务，最多处理 <code>open_slots</code> 个任务。</li> <li>如果任务已经在执行器的 <code>running</code> 集合中，说明任务可能已经被外部终止但尚未标记为失败，或者由于延迟任务的竞争条件，任务可能在触发处理期间再次被调度。在这种情况下，我们会尝试多次检查任务是否已从 <code>running</code> 集合中移除。如果尝试次数超过限制，我们放弃并从队列中移除该任务。</li> <li>如果任务不在执行器的 <code>running</code> 集合中，将任务添加到 <code>task_tuples</code> 列表中。</li> <li>如果 <code>task_tuples</code> 列表不为空，调用 <code>_process_tasks</code> 方法处理任务。</li></ol> <p>这个方法没有返回值。注意，这个方法需要在子类中实现 <code>_process_tasks</code> 方法，以便处理任务。</p> <p>文件路径：airflow/airflow/executors/base_executor.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">BaseExecutor</span><span class="token punctuation">(</span>LoggingMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">trigger_tasks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> open_slots<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
          sorted_queue <span class="token operator">=</span> self<span class="token punctuation">.</span>order_queued_tasks_by_priority<span class="token punctuation">(</span><span class="token punctuation">)</span>
          task_tuples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

          <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>open_slots<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>queued_tasks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
              key<span class="token punctuation">,</span> <span class="token punctuation">(</span>command<span class="token punctuation">,</span> _<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> ti<span class="token punctuation">)</span> <span class="token operator">=</span> sorted_queue<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

              <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>running<span class="token punctuation">:</span>
                  attempt <span class="token operator">=</span> self<span class="token punctuation">.</span>attempts<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                  <span class="token keyword">if</span> attempt<span class="token punctuation">.</span>can_try_again<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                      self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;queued but still running; attempt=%s task=%s&quot;</span><span class="token punctuation">,</span> attempt<span class="token punctuation">.</span>total_tries<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
                      <span class="token keyword">continue</span>
                  self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span>
                      <span class="token string">&quot;could not queue task %s (still running after %d attempts)&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> attempt<span class="token punctuation">.</span>total_tries
                  <span class="token punctuation">)</span>
                  <span class="token keyword">del</span> self<span class="token punctuation">.</span>attempts<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                  <span class="token keyword">del</span> self<span class="token punctuation">.</span>queued_tasks<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
              <span class="token keyword">else</span><span class="token punctuation">:</span>
                  <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>attempts<span class="token punctuation">:</span>
                      <span class="token keyword">del</span> self<span class="token punctuation">.</span>attempts<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                  task_tuples<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> command<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> ti<span class="token punctuation">.</span>executor_config<span class="token punctuation">)</span><span class="token punctuation">)</span>

          <span class="token keyword">if</span> task_tuples<span class="token punctuation">:</span>
              self<span class="token punctuation">.</span>_process_tasks<span class="token punctuation">(</span>task_tuples<span class="token punctuation">)</span>
</code></pre></div><h4 id="baseexecutor-process-tasks"><a href="#baseexecutor-process-tasks" class="header-anchor">#</a> BaseExecutor-&gt;_process_tasks</h4> <p>文件路径：airflow/airflow/executors/base_executor.py</p> <p><code>_process_tasks</code> 方法负责处理任务。</p> <p>以下是具体的步骤：</p> <ol><li>遍历 <code>task_tuples</code> 列表，每个元素包含任务的键、命令、队列和执行器配置。</li> <li>从 <code>queued_tasks</code> 字典中删除任务。</li> <li>调用 <code>execute_async</code> 方法异步执行任务。</li> <li>将任务的键添加到 <code>running</code> 集合中，表示任务正在运行。</li></ol> <p>注意，这个方法需要在子类中实现 <code>execute_async</code> 方法，以便异步执行任务。</p> <p>文件路径：airflow/airflow/executors/base_executor.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">BaseExecutor</span><span class="token punctuation">(</span>LoggingMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">_process_tasks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task_tuples<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>TaskTuple<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> key<span class="token punctuation">,</span> command<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> executor_config <span class="token keyword">in</span> task_tuples<span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>queued_tasks<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>execute_async<span class="token punctuation">(</span>key<span class="token operator">=</span>key<span class="token punctuation">,</span> command<span class="token operator">=</span>command<span class="token punctuation">,</span> queue<span class="token operator">=</span>queue<span class="token punctuation">,</span> executor_config<span class="token operator">=</span>executor_config<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>running<span class="token punctuation">.</span>add<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
</code></pre></div><h4 id="sequentialexecutor-execute-async"><a href="#sequentialexecutor-execute-async" class="header-anchor">#</a> SequentialExecutor.execute_async</h4> <p>由于execute_async方法是在BaseExecutor的子类中调用执行，所以我们需要分析其子类里的execute_async方法。继承BaseExecutor的子类有LocalExecutor、SequentialExecutor，其中<code>SequentialExecutor</code>是 Airflow 默认的执行器。它会按照顺序一个接一个地执行任务，也就是说，在一个任务完成之前，不会启动下一个任务。</p> <p>下面，我们分析SequentialExecutor中的execute_async方法：</p> <p>以下是具体的步骤：</p> <ol><li>定义方法参数，包括任务实例键 <code>key</code>、执行命令 <code>command</code>、队列名称 <code>queue</code> 和执行器配置 <code>executor_config</code>。</li> <li>调用 <code>validate_airflow_tasks_run_command</code> 方法验证执行命令。这个方法确保传入的命令以 &quot;airflow tasks run&quot; 开头，以防止执行意外的命令。</li> <li>将任务实例键和执行命令作为元组添加到 <code>commands_to_run</code> 列表中。这个列表用于存储等待执行的任务命令。</li></ol> <p>这个方法没有返回值。注意，虽然方法名为 <code>execute_async</code>，但实际上它并不异步执行任务。任务的实际执行是在 <code>SequentialExecutor</code> 的 <code>sync</code> 方法中进行的，该方法会顺序执行 <code>commands_to_run</code> 列表中的任务。</p> <p>文件路径：airflow/airflow/executors/sequential_executor.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SequentialExecutor</span><span class="token punctuation">(</span>BaseExecutor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">execute_async</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        key<span class="token punctuation">:</span> TaskInstanceKey<span class="token punctuation">,</span>
        command<span class="token punctuation">:</span> CommandType<span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        executor_config<span class="token punctuation">:</span> Any <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>validate_airflow_tasks_run_command<span class="token punctuation">(</span>command<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>commands_to_run<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="sequentialexecutor-sync"><a href="#sequentialexecutor-sync" class="header-anchor">#</a> SequentialExecutor.sync</h4> <p>它负责顺序执行 <code>commands_to_run</code> 列表中的任务。</p> <p>以下是具体的步骤：</p> <ol><li>遍历 <code>commands_to_run</code> 列表，获取任务实例键 <code>key</code> 和执行命令 <code>command</code>。</li> <li>记录日志，表示正在执行命令。</li> <li>使用 <code>subprocess.check_call</code> 函数执行命令。<code>close_fds=True</code> 参数表示在执行子进程前关闭所有文件描述符，这有助于防止文件描述符泄漏。</li> <li>如果命令执行成功，调用 <code>success</code> 方法更新任务实例键的状态。</li> <li>如果命令执行失败（抛出 <code>subprocess.CalledProcessError</code> 异常），调用 <code>fail</code> 方法更新任务实例键的状态，并记录错误日志。</li> <li>清空 <code>commands_to_run</code> 列表，表示所有任务已经执行完成。</li></ol> <p>注意，这个方法是顺序执行任务的，即在一个任务完成之前，不会启动下一个任务。</p> <p>文件路径：airflow/airflow/executors/sequential_executor.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SequentialExecutor</span><span class="token punctuation">(</span>BaseExecutor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">sync</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> key<span class="token punctuation">,</span> command <span class="token keyword">in</span> self<span class="token punctuation">.</span>commands_to_run<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Executing command: %s&quot;</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span>

            <span class="token keyword">try</span><span class="token punctuation">:</span>
                subprocess<span class="token punctuation">.</span>check_call<span class="token punctuation">(</span>command<span class="token punctuation">,</span> close_fds<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>success<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>CalledProcessError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>fail<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;Failed to execute task %s.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>commands_to_run <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><p>这里command的格式通过Airflow的日志打印如下，就是一个本地python文件的执行。</p> <div class="language- extra-class"><pre class="language-text"><code>Executing command: ['airflow', 'tasks', 'run', 'tutorial_dag', 'extract', 'manual__2023-11-07T12:16:02.851026+00:00', '--local', '--subdir', '/airflow/example_dags/tutorial_dag.py']
</code></pre></div><p>这里使用的命令是airflow的<code>airflow tasks run</code>命令，参数如下。</p> <div class="language- extra-class"><pre class="language-text"><code>airflow tasks run -h
Usage: airflow tasks run [-h] [--cfg-path CFG_PATH] [-d {wait,check,ignore}] [-f] [-A] [-i] [-I] [-N] [-l] [--map-index MAP_INDEX] [-m] [-p PICKLE] [--pool POOL]
                         [--read-from-db] [--ship-dag] [-S SUBDIR] [-v]
                         dag_id task_id execution_date_or_run_id

Run a single task instance

Positional Arguments:
  dag_id                The id of the dag
  task_id               The id of the task
  execution_date_or_run_id
                        The execution_date of the DAG or run_id of the DAGRun

Options:
  -h, --help            show this help message and exit
  --cfg-path CFG_PATH   Path to config file to use instead of airflow.cfg
  -d, --depends-on-past {wait,check,ignore}
                        Determine how Airflow should deal with past dependencies. The default action is `check`, Airflow will check if the past dependencies are met for the tasks having `depends_on_past=True` before run them, if `ignore` is provided, the past dependencies will be ignored, if `wait` is provided and `depends_on_past=True`, Airflow will wait the past dependencies until they are met before running or skipping the task
  -f, --force           Ignore previous task instance state, rerun regardless if task already succeeded/failed
  -A, --ignore-all-dependencies
                        Ignores all non-critical dependencies, including ignore_ti_state and ignore_task_deps
  -i, --ignore-dependencies
                        Ignore task-specific dependencies, e.g. upstream, depends_on_past, and retry delay dependencies
  -I, --ignore-depends-on-past
                        Deprecated -- use `--depends-on-past ignore` instead. Ignore depends_on_past dependencies (but respect upstream dependencies)
  -N, --interactive     Do not capture standard output and error streams (useful for interactive debugging)
  -l, --local           Run the task using the LocalExecutor
  --map-index MAP_INDEX
                        Mapped task index
  -m, --mark-success    Mark jobs as succeeded without running them
  -p, --pickle PICKLE   Serialized pickle object of the entire dag (used internally)
  --pool POOL           Resource pool to use
  --read-from-db        Read dag from DB instead of dag file
  --ship-dag            Pickles (serializes) the DAG and ships it to the worker
  -S, --subdir SUBDIR   File location or directory from which to look for the dag. Defaults to '[AIRFLOW_HOME]/dags' where [AIRFLOW_HOME] is the value you set for 'AIRFLOW_HOME' config you set in 'airflow.cfg'
  -v, --verbose         Make logging output more verbose
</code></pre></div><p>该命令调用的函数如下。</p> <h4 id="task-run"><a href="#task-run" class="header-anchor">#</a> task_run</h4> <p>这段代码定义了一个名为<code>task_run</code>的函数，它用于运行一个单独的任务实例。这个函数接受两个参数：<code>args</code>和<code>dag</code>。<code>args</code>是一个包含命令行参数的对象，<code>dag</code>是一个可选的DAG对象，默认值为<code>None</code>。</p> <p>函数的主要目的是根据提供的参数执行一个Airflow任务，并返回任务的执行结果。在执行任务之前，它会进行一些参数检查和设置，例如检查<code>--local</code>和<code>--raw</code>选项是否同时使用，加载自定义Airflow配置等。</p> <p>在函数内部，首先根据提供的参数获取DAG对象。然后，根据DAG对象和任务ID获取任务实例。接下来，根据任务实例和其他参数获取任务实例（TaskInstance）。接着，初始化任务实例的运行上下文。</p> <p>在运行任务之前，会重新配置ORM（Object-Relational Mapping，对象关系映射）以使用NullPool，以避免在处理大量并发任务时出现数据库连接限制问题。</p> <p>最后，根据<code>args.interactive</code>参数的值，以交互式或非交互式方式运行任务（调用_run_task_by_selected_method方法），并返回任务的执行结果。在运行任务之后，会触发监听器管理器的<code>before_stopping</code>钩子。</p> <p>文件路径：airflow/airflow/cli/commands/task_command.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@cli_utils<span class="token punctuation">.</span>action_cli</span><span class="token punctuation">(</span>check_db<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">task_run</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> dag<span class="token punctuation">:</span> DAG <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TaskReturnCode <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> args<span class="token punctuation">.</span>local <span class="token keyword">and</span> args<span class="token punctuation">.</span>raw<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> AirflowException<span class="token punctuation">(</span>
            <span class="token string">&quot;Option --raw and --local are mutually exclusive. &quot;</span>
            <span class="token string">&quot;Please remove one option to execute the command.&quot;</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">if</span> args<span class="token punctuation">.</span>raw<span class="token punctuation">:</span>
        unsupported_options <span class="token operator">=</span> <span class="token punctuation">[</span>o <span class="token keyword">for</span> o <span class="token keyword">in</span> RAW_TASK_UNSUPPORTED_OPTION <span class="token keyword">if</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> unsupported_options<span class="token punctuation">:</span>
            unsupported_raw_task_flags <span class="token operator">=</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;--</span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">for</span> o <span class="token keyword">in</span> RAW_TASK_UNSUPPORTED_OPTION<span class="token punctuation">)</span>
            unsupported_flags <span class="token operator">=</span> <span class="token string">&quot;, &quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;--</span><span class="token interpolation"><span class="token punctuation">{</span>o<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">for</span> o <span class="token keyword">in</span> unsupported_options<span class="token punctuation">)</span>
            <span class="token keyword">raise</span> AirflowException<span class="token punctuation">(</span>
                <span class="token string">&quot;Option --raw does not work with some of the other options on this command. &quot;</span>
                <span class="token string">&quot;You can't use --raw option and the following options: &quot;</span>
                <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>unsupported_raw_task_flags<span class="token punctuation">}</span></span><span class="token string">. &quot;</span></span>
                <span class="token string-interpolation"><span class="token string">f&quot;You provided the option </span><span class="token interpolation"><span class="token punctuation">{</span>unsupported_flags<span class="token punctuation">}</span></span><span class="token string">. &quot;</span></span>
                <span class="token string">&quot;Delete it to execute the command.&quot;</span>
            <span class="token punctuation">)</span>
    <span class="token keyword">if</span> dag <span class="token keyword">and</span> args<span class="token punctuation">.</span>pickle<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> AirflowException<span class="token punctuation">(</span><span class="token string">&quot;You cannot use the --pickle option when using DAG.cli() method.&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>cfg_path<span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>cfg_path<span class="token punctuation">)</span> <span class="token keyword">as</span> conf_file<span class="token punctuation">:</span>
            conf_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>conf_file<span class="token punctuation">)</span>

        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>args<span class="token punctuation">.</span>cfg_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>args<span class="token punctuation">.</span>cfg_path<span class="token punctuation">)</span>

        conf<span class="token punctuation">.</span>read_dict<span class="token punctuation">(</span>conf_dict<span class="token punctuation">,</span> source<span class="token operator">=</span>args<span class="token punctuation">.</span>cfg_path<span class="token punctuation">)</span>
        settings<span class="token punctuation">.</span>configure_vars<span class="token punctuation">(</span><span class="token punctuation">)</span>

    settings<span class="token punctuation">.</span>MASK_SECRETS_IN_LOGS <span class="token operator">=</span> <span class="token boolean">True</span>

    get_listener_manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hook<span class="token punctuation">.</span>on_starting<span class="token punctuation">(</span>component<span class="token operator">=</span>TaskCommandMarker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> args<span class="token punctuation">.</span>pickle<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Loading pickle id: </span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token punctuation">.</span>pickle<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        _dag <span class="token operator">=</span> get_dag_by_pickle<span class="token punctuation">(</span>args<span class="token punctuation">.</span>pickle<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token keyword">not</span> dag<span class="token punctuation">:</span>
        _dag <span class="token operator">=</span> get_dag<span class="token punctuation">(</span>args<span class="token punctuation">.</span>subdir<span class="token punctuation">,</span> args<span class="token punctuation">.</span>dag_id<span class="token punctuation">,</span> args<span class="token punctuation">.</span>read_from_db<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        _dag <span class="token operator">=</span> dag
    task <span class="token operator">=</span> _dag<span class="token punctuation">.</span>get_task<span class="token punctuation">(</span>task_id<span class="token operator">=</span>args<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span>
    ti<span class="token punctuation">,</span> _ <span class="token operator">=</span> _get_ti<span class="token punctuation">(</span>task<span class="token punctuation">,</span> args<span class="token punctuation">.</span>map_index<span class="token punctuation">,</span> exec_date_or_run_id<span class="token operator">=</span>args<span class="token punctuation">.</span>execution_date_or_run_id<span class="token punctuation">,</span> pool<span class="token operator">=</span>args<span class="token punctuation">.</span>pool<span class="token punctuation">)</span>
    ti<span class="token punctuation">.</span>init_run_context<span class="token punctuation">(</span>raw<span class="token operator">=</span>args<span class="token punctuation">.</span>raw<span class="token punctuation">)</span>

    hostname <span class="token operator">=</span> get_hostname<span class="token punctuation">(</span><span class="token punctuation">)</span>

    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Running %s on host %s&quot;</span><span class="token punctuation">,</span> ti<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span>

    settings<span class="token punctuation">.</span>reconfigure_orm<span class="token punctuation">(</span>disable_connection_pool<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    task_return_code <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> args<span class="token punctuation">.</span>interactive<span class="token punctuation">:</span>
            task_return_code <span class="token operator">=</span> _run_task_by_selected_method<span class="token punctuation">(</span>args<span class="token punctuation">,</span> _dag<span class="token punctuation">,</span> ti<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> _move_task_handlers_to_root<span class="token punctuation">(</span>ti<span class="token punctuation">)</span><span class="token punctuation">,</span> _redirect_stdout_to_ti_log<span class="token punctuation">(</span>ti<span class="token punctuation">)</span><span class="token punctuation">:</span>
                task_return_code <span class="token operator">=</span> _run_task_by_selected_method<span class="token punctuation">(</span>args<span class="token punctuation">,</span> _dag<span class="token punctuation">,</span> ti<span class="token punctuation">)</span>
                <span class="token keyword">if</span> task_return_code <span class="token operator">==</span> TaskReturnCode<span class="token punctuation">.</span>DEFERRED<span class="token punctuation">:</span>
                    _set_task_deferred_context_var<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            get_listener_manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hook<span class="token punctuation">.</span>before_stopping<span class="token punctuation">(</span>component<span class="token operator">=</span>TaskCommandMarker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
    <span class="token keyword">return</span> task_return_code
</code></pre></div><p>这里调用了_run_task_by_selected_method关键方法。</p> <h4 id="run-task-by-selected-method"><a href="#run-task-by-selected-method" class="header-anchor">#</a> _run_task_by_selected_method</h4> <p>这个函数<code>_run_task_by_selected_method</code>用于根据所选的模式运行Airflow任务。它接受3个参数：<code>args</code>，<code>dag</code>和<code>ti</code>。<code>args</code>是一个包含命令行参数的对象，<code>dag</code>是一个DAG对象，<code>ti</code>是一个任务实例（TaskInstance）或TaskInstancePydantic对象。</p> <p>函数的主要目的是根据提供的参数选择合适的方式执行Airflow任务。目前支持3种模式：</p> <ol><li>使用LocalTaskJob运行任务。</li> <li>作为原始任务（raw task）运行。</li> <li>通过执行器（executor）运行任务。</li></ol> <p>根据<code>args.local</code>和<code>args.raw</code>参数的值，函数会分别调用<code>_run_task_by_local_task_job</code>、<code>_run_raw_task</code>或<code>_run_task_by_executor</code>函数来执行任务。最后，函数返回执行结果，如果没有返回值，则返回<code>None</code>。</p> <p>文件路径：airflow/airflow/cli/commands/task_command.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_run_task_by_selected_method</span><span class="token punctuation">(</span>
    args<span class="token punctuation">,</span> dag<span class="token punctuation">:</span> DAG<span class="token punctuation">,</span> ti<span class="token punctuation">:</span> TaskInstance <span class="token operator">|</span> TaskInstancePydantic
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span> <span class="token operator">|</span> TaskReturnCode<span class="token punctuation">:</span>
    <span class="token keyword">if</span> TYPE_CHECKING<span class="token punctuation">:</span>
        <span class="token keyword">assert</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ti<span class="token punctuation">,</span> TaskInstancePydantic<span class="token punctuation">)</span>  <span class="token comment"># Wait for AIP-44 implementation to complete</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>local<span class="token punctuation">:</span>
        <span class="token keyword">return</span> _run_task_by_local_task_job<span class="token punctuation">(</span>args<span class="token punctuation">,</span> ti<span class="token punctuation">)</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>raw<span class="token punctuation">:</span>
        <span class="token keyword">return</span> _run_raw_task<span class="token punctuation">(</span>args<span class="token punctuation">,</span> ti<span class="token punctuation">)</span>
    _run_task_by_executor<span class="token punctuation">(</span>args<span class="token punctuation">,</span> dag<span class="token punctuation">,</span> ti<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">None</span>
  
<span class="token keyword">def</span> <span class="token function">_run_raw_task</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> ti<span class="token punctuation">:</span> TaskInstance<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span> <span class="token operator">|</span> TaskReturnCode<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Run the main task handling code.&quot;&quot;&quot;</span>
    <span class="token keyword">return</span> ti<span class="token punctuation">.</span>_run_raw_task<span class="token punctuation">(</span>
        mark_success<span class="token operator">=</span>args<span class="token punctuation">.</span>mark_success<span class="token punctuation">,</span>
        job_id<span class="token operator">=</span>args<span class="token punctuation">.</span>job_id<span class="token punctuation">,</span>
        pool<span class="token operator">=</span>args<span class="token punctuation">.</span>pool<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>我们分析其中的_run_raw_task方法，其最终是通过TaskInstance的_run_raw_task方法实现</p> <p>函数的主要目的是在原始模式下执行Airflow任务，并在任务完成后更新任务状态并运行适当的回调。</p> <p>在<code>_run_raw_task</code>函数中，任务的实际执行是通过调用<code>self._execute_task_with_callbacks(context, test_mode, session=session)</code>来完成的。这个方法将任务的上下文、测试模式和数据库会话作为参数，并执行任务。在执行任务时，它还会处理任务执行过程中的回调函数。</p> <p>文件路径：airflow/airflow/models/taskinstance.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@provide_session</span>
<span class="token decorator annotation punctuation">@Sentry<span class="token punctuation">.</span>enrich_errors</span>
<span class="token keyword">def</span> <span class="token function">_run_raw_task</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    mark_success<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    test_mode<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    job_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    pool<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    raise_on_defer<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    session<span class="token punctuation">:</span> Session <span class="token operator">=</span> NEW_SESSION<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TaskReturnCode <span class="token operator">|</span> <span class="token boolean">None</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> TYPE_CHECKING<span class="token punctuation">:</span>
        <span class="token keyword">assert</span> self<span class="token punctuation">.</span>task

    self<span class="token punctuation">.</span>test_mode <span class="token operator">=</span> test_mode
    self<span class="token punctuation">.</span>refresh_from_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>task<span class="token punctuation">,</span> pool_override<span class="token operator">=</span>pool<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>refresh_from_db<span class="token punctuation">(</span>session<span class="token operator">=</span>session<span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>job_id <span class="token operator">=</span> job_id
    self<span class="token punctuation">.</span>hostname <span class="token operator">=</span> get_hostname<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>pid <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> test_mode<span class="token punctuation">:</span>
        session<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    actual_start_date <span class="token operator">=</span> timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
    Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;ti.start.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>dag_id<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>task_id<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> tags<span class="token operator">=</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">)</span>
    <span class="token comment"># Same metric with tagging</span>
    Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">&quot;ti.start&quot;</span><span class="token punctuation">,</span> tags<span class="token operator">=</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">)</span>
    <span class="token comment"># Initialize final state counters at zero</span>
    <span class="token keyword">for</span> state <span class="token keyword">in</span> State<span class="token punctuation">.</span>task_states<span class="token punctuation">:</span>
        Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f&quot;ti.finish.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>dag_id<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>task_id<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>state<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
            count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
            tags<span class="token operator">=</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token comment"># Same metric with tagging</span>
        Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span>
            <span class="token string">&quot;ti.finish&quot;</span><span class="token punctuation">,</span>
            count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
            tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">,</span> <span class="token string">&quot;state&quot;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">with</span> set_current_task_instance_session<span class="token punctuation">(</span>session<span class="token operator">=</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>task <span class="token operator">=</span> self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>prepare_for_execution<span class="token punctuation">(</span><span class="token punctuation">)</span>
        context <span class="token operator">=</span> self<span class="token punctuation">.</span>get_template_context<span class="token punctuation">(</span>ignore_param_exceptions<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> mark_success<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_execute_task_with_callbacks<span class="token punctuation">(</span>context<span class="token punctuation">,</span> test_mode<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> test_mode<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>refresh_from_db<span class="token punctuation">(</span>lock_for_update<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>state <span class="token operator">=</span> TaskInstanceState<span class="token punctuation">.</span>SUCCESS
        <span class="token keyword">except</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment"># 各种异常处理代码...</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;ti.finish.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>dag_id<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>task_id<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>state<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> tags<span class="token operator">=</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">)</span>
            <span class="token comment"># Same metric with tagging</span>
            Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">&quot;ti.finish&quot;</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">,</span> <span class="token string">&quot;state&quot;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># Recording SKIPPED or SUCCESS</span>
        self<span class="token punctuation">.</span>clear_next_method_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_date <span class="token operator">=</span> timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _log_state<span class="token punctuation">(</span>task_instance<span class="token operator">=</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>set_duration<span class="token punctuation">(</span><span class="token punctuation">)</span>

        _run_finished_callback<span class="token punctuation">(</span>callbacks<span class="token operator">=</span>self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>on_success_callback<span class="token punctuation">,</span> context<span class="token operator">=</span>context<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> test_mode<span class="token punctuation">:</span>
            session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">)</span>
            session<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>task <span class="token operator">=</span> self<span class="token punctuation">.</span>task
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>state <span class="token operator">==</span> TaskInstanceState<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_register_dataset_changes<span class="token punctuation">(</span>session<span class="token operator">=</span>session<span class="token punctuation">)</span>

            session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>state <span class="token operator">==</span> TaskInstanceState<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">:</span>
                get_listener_manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hook<span class="token punctuation">.</span>on_task_instance_success<span class="token punctuation">(</span>
                    previous_state<span class="token operator">=</span>TaskInstanceState<span class="token punctuation">.</span>RUNNING<span class="token punctuation">,</span> task_instance<span class="token operator">=</span>self<span class="token punctuation">,</span> session<span class="token operator">=</span>session
                <span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre></div><p>这里调用了关键方法：_execute_task_with_callbacks</p> <h4 id="taskinstance-execute-task-with-callbacks"><a href="#taskinstance-execute-task-with-callbacks" class="header-anchor">#</a> TaskInstance._execute_task_with_callbacks</h4> <p><code>_execute_task_with_callbacks</code>函数用于准备任务实例并执行任务。它接受以下参数：</p> <ul><li><code>context</code>：任务上下文（Context）对象，包含任务执行所需的信息。</li> <li><code>test_mode</code>：布尔值，表示是否在测试模式下运行任务，默认值为<code>False</code>。</li> <li><code>session</code>：SQLAlchemy ORM Session对象。</li></ul> <p>函数的主要步骤如下：</p> <ol><li>定义一个信号处理器<code>signal_handler</code>，用于处理任务在执行过程中收到的SIGTERM信号。当接收到信号时，它会调用任务的<code>on_kill</code>方法，并引发一个<code>AirflowTaskTerminated</code>异常。</li> <li>为任务实例清除XCom数据（如果没有下一个要执行的方法）。</li> <li>使用<code>Stats.timer</code>记录任务执行的时间。</li> <li>设置任务对象的参数。</li> <li>渲染任务的模板，并在非测试模式下，将渲染后的任务实例字段保存到数据库中。</li> <li>将上下文导出到环境变量，以便操作符使用。</li> <li>调用任务的<code>pre_execute</code>回调函数。</li> <li>调用<code>_run_execute_callback</code>方法执行<code>on_execute</code>回调。</li> <li>调用<code>get_listener_manager().hook.on_task_instance_running</code>方法触发任务实例运行事件。</li> <li>使用<code>set_current_context</code>上下文管理器执行任务，并获取任务执行结果。</li> <li>调用任务的<code>post_execute</code>回调函数。</li> <li>如果任务上下文中包含<code>map_index_template</code>，则使用Jinja环境渲染它，并将渲染结果保存到<code>self.rendered_map_index</code>属性中。</li> <li>更新任务执行成功的统计信息。</li></ol> <p>在整个过程中，函数会处理任务执行过程中的各种回调函数，以及在任务执行前后更新任务实例的状态。</p> <p>文件路径：airflow/airflow/cli/commands/task_command.py</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_execute_task_with_callbacks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Context<span class="token punctuation">,</span> test_mode<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> session<span class="token punctuation">:</span> Session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Prepare Task for Execution.&quot;&quot;&quot;</span>
    <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>renderedtifields <span class="token keyword">import</span> RenderedTaskInstanceFields

    <span class="token keyword">if</span> TYPE_CHECKING<span class="token punctuation">:</span>
        <span class="token keyword">assert</span> self<span class="token punctuation">.</span>task

    parent_pid <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">signal_handler</span><span class="token punctuation">(</span>signum<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pid <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> pid <span class="token operator">!=</span> parent_pid<span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>_exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;Received SIGTERM. Terminating subprocesses.&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>on_kill<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span> AirflowTaskTerminated<span class="token punctuation">(</span><span class="token string">&quot;Task received SIGTERM signal&quot;</span><span class="token punctuation">)</span>

    signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">,</span> signal_handler<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>next_method<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>clear_xcom_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> Stats<span class="token punctuation">.</span>timer<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;dag.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>dag_id<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>task_id<span class="token punctuation">}</span></span><span class="token string">.duration&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> Stats<span class="token punctuation">.</span>timer<span class="token punctuation">(</span>
        <span class="token string">&quot;task.duration&quot;</span><span class="token punctuation">,</span> tags<span class="token operator">=</span>self<span class="token punctuation">.</span>stats_tags
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>params <span class="token operator">=</span> context<span class="token punctuation">[</span><span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span>

        <span class="token keyword">with</span> set_current_context<span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>
            dag <span class="token operator">=</span> self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>get_dag<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> dag <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                jinja_env <span class="token operator">=</span> dag<span class="token punctuation">.</span>get_template_env<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                jinja_env <span class="token operator">=</span> <span class="token boolean">None</span>
            task_orig <span class="token operator">=</span> self<span class="token punctuation">.</span>render_templates<span class="token punctuation">(</span>context<span class="token operator">=</span>context<span class="token punctuation">,</span> jinja_env<span class="token operator">=</span>jinja_env<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> test_mode<span class="token punctuation">:</span>
            rtif <span class="token operator">=</span> RenderedTaskInstanceFields<span class="token punctuation">(</span>ti<span class="token operator">=</span>self<span class="token punctuation">,</span> render_templates<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            RenderedTaskInstanceFields<span class="token punctuation">.</span>write<span class="token punctuation">(</span>rtif<span class="token punctuation">)</span>
            RenderedTaskInstanceFields<span class="token punctuation">.</span>delete_old_records<span class="token punctuation">(</span>self<span class="token punctuation">.</span>task_id<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dag_id<span class="token punctuation">)</span>

        airflow_context_vars <span class="token operator">=</span> context_to_airflow_vars<span class="token punctuation">(</span>context<span class="token punctuation">,</span> in_env_var_format<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>update<span class="token punctuation">(</span>airflow_context_vars<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>next_method<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
                <span class="token string">&quot;Exporting env vars: %s&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot; &quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>k<span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{</span>v<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> airflow_context_vars<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>pre_execute<span class="token punctuation">(</span>context<span class="token operator">=</span>context<span class="token punctuation">)</span>  <span class="token comment"># type: ignore[union-attr]</span>

        self<span class="token punctuation">.</span>_run_execute_callback<span class="token punctuation">(</span>context<span class="token punctuation">,</span> self<span class="token punctuation">.</span>task<span class="token punctuation">)</span>

        get_listener_manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hook<span class="token punctuation">.</span>on_task_instance_running<span class="token punctuation">(</span>
            previous_state<span class="token operator">=</span>TaskInstanceState<span class="token punctuation">.</span>QUEUED<span class="token punctuation">,</span> task_instance<span class="token operator">=</span>self<span class="token punctuation">,</span> session<span class="token operator">=</span>session
        <span class="token punctuation">)</span>

        <span class="token keyword">with</span> set_current_context<span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> self<span class="token punctuation">.</span>_execute_task<span class="token punctuation">(</span>context<span class="token punctuation">,</span> task_orig<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>post_execute<span class="token punctuation">(</span>context<span class="token operator">=</span>context<span class="token punctuation">,</span> result<span class="token operator">=</span>result<span class="token punctuation">)</span>  <span class="token comment"># type: ignore[union-attr]</span>

        <span class="token keyword">if</span> jinja_env <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>template <span class="token operator">:=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;map_index_template&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            rendered_map_index <span class="token operator">=</span> self<span class="token punctuation">.</span>rendered_map_index <span class="token operator">=</span> jinja_env<span class="token punctuation">.</span>from_string<span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">.</span>render<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Map index rendered as %s&quot;</span><span class="token punctuation">,</span> rendered_map_index<span class="token punctuation">)</span>

    Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;operator_successes_</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>task_type<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> tags<span class="token operator">=</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">)</span>

    Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">&quot;operator_successes&quot;</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">**</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">,</span> <span class="token string">&quot;task_type&quot;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>task<span class="token punctuation">.</span>task_type<span class="token punctuation">}</span><span class="token punctuation">)</span>
    Stats<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">&quot;ti_successes&quot;</span><span class="token punctuation">,</span> tags<span class="token operator">=</span>self<span class="token punctuation">.</span>stats_tags<span class="token punctuation">)</span>
</code></pre></div><p>这里调用了关键方法：_execute_task。</p> <h4 id="taskinstance-execute-task"><a href="#taskinstance-execute-task" class="header-anchor">#</a> TaskInstance._execute_task</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_execute_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> task_orig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Execute Task (optionally with a Timeout) and push Xcom results.

    :param context: Jinja2 context
    :param task_orig: origin task
    &quot;&quot;&quot;</span>
    <span class="token keyword">return</span> _execute_task<span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">,</span> task_orig<span class="token punctuation">)</span>
</code></pre></div><p><code>_execute_task</code>函数用于执行任务并在任务完成后推送XCom结果。它接受以下参数：</p> <ul><li><code>task_instance</code>：任务实例（TaskInstance）或TaskInstancePydantic对象。</li> <li><code>context</code>：任务上下文（Context）对象，包含任务执行所需的信息。</li> <li><code>task_orig</code>：原始任务（Operator）对象。</li></ul> <p>函数的主要步骤如下：</p> <ol><li>获取要执行的任务对象 <code>task_to_execute</code>。</li> <li>检查任务是否为MappedOperator类型，如果是，则抛出异常。</li> <li>根据任务实例的<code>next_method</code>属性，选择要执行的任务方法（<code>execute</code>或<code>resume_execution</code>）以及相应的参数。</li> <li>定义一个内部函数<code>_execute_callable</code>，用于实际执行任务方法，并处理任务执行过程中的SystemExit异常。</li> <li>如果任务具有执行超时限制，使用<code>timeout</code>上下文管理器确保任务在超时后被终止。在处理超时时，调用任务的<code>on_kill</code>方法并引发<code>AirflowTaskTimeout</code>异常。</li> <li>如果任务没有执行超时限制，直接调用<code>_execute_callable</code>函数执行任务方法。</li> <li>根据任务的<code>do_xcom_push</code>属性，决定是否将任务执行结果推送到XCom。如果任务返回结果并且<code>do_xcom_push</code>为True，则将结果推送到XCom。如果任务具有<code>multiple_outputs</code>属性，则需要对结果进行额外的检查和处理。</li> <li>调用<code>_record_task_map_for_downstreams</code>函数记录任务映射，以便在下游任务中使用。</li> <li>返回任务执行结果。</li></ol> <p>在整个过程中，函数会处理任务执行过程中的各种异常情况，并确保任务在超时后被终止。同时，它还会根据任务的属性决定是否将任务执行结果推送到XCom。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">_execute_task</span><span class="token punctuation">(</span>task_instance<span class="token punctuation">:</span> TaskInstance <span class="token operator">|</span> TaskInstancePydantic<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Context<span class="token punctuation">,</span> task_orig<span class="token punctuation">:</span> Operator<span class="token punctuation">)</span><span class="token punctuation">:</span>

    task_to_execute <span class="token operator">=</span> task_instance<span class="token punctuation">.</span>task

    <span class="token keyword">if</span> TYPE_CHECKING<span class="token punctuation">:</span>
        <span class="token keyword">assert</span> task_to_execute

    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>task_to_execute<span class="token punctuation">,</span> MappedOperator<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> AirflowException<span class="token punctuation">(</span><span class="token string">&quot;MappedOperator cannot be executed.&quot;</span><span class="token punctuation">)</span>

    execute_callable_kwargs<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    execute_callable<span class="token punctuation">:</span> Callable
    <span class="token keyword">if</span> task_instance<span class="token punctuation">.</span>next_method<span class="token punctuation">:</span>
        <span class="token keyword">if</span> task_instance<span class="token punctuation">.</span>next_method <span class="token operator">==</span> <span class="token string">&quot;execute&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> task_instance<span class="token punctuation">.</span>next_kwargs<span class="token punctuation">:</span>
                task_instance<span class="token punctuation">.</span>next_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            task_instance<span class="token punctuation">.</span>next_kwargs<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>task_to_execute<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">__sentinel&quot;</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> _sentinel
        execute_callable <span class="token operator">=</span> task_to_execute<span class="token punctuation">.</span>resume_execution
        execute_callable_kwargs<span class="token punctuation">[</span><span class="token string">&quot;next_method&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> task_instance<span class="token punctuation">.</span>next_method
        execute_callable_kwargs<span class="token punctuation">[</span><span class="token string">&quot;next_kwargs&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> task_instance<span class="token punctuation">.</span>next_kwargs
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        execute_callable <span class="token operator">=</span> task_to_execute<span class="token punctuation">.</span>execute
        <span class="token keyword">if</span> execute_callable<span class="token punctuation">.</span>__name__ <span class="token operator">==</span> <span class="token string">&quot;execute&quot;</span><span class="token punctuation">:</span>
            execute_callable_kwargs<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>task_to_execute<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">__sentinel&quot;</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> _sentinel

    <span class="token keyword">def</span> <span class="token function">_execute_callable</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token operator">**</span>execute_callable_kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;::endgroup::&quot;</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> execute_callable<span class="token punctuation">(</span>context<span class="token operator">=</span>context<span class="token punctuation">,</span> <span class="token operator">**</span>execute_callable_kwargs<span class="token punctuation">)</span>
        <span class="token keyword">except</span> SystemExit <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">if</span> e<span class="token punctuation">.</span>code <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> e<span class="token punctuation">.</span>code <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># Print a marker post execution for internals of post task processing</span>
            log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;::group::Post task execution logs&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> task_to_execute<span class="token punctuation">.</span>execution_timeout<span class="token punctuation">:</span>
        <span class="token keyword">if</span> task_instance<span class="token punctuation">.</span>next_method <span class="token keyword">and</span> task_instance<span class="token punctuation">.</span>start_date<span class="token punctuation">:</span>
            timeout_seconds <span class="token operator">=</span> <span class="token punctuation">(</span>
                task_to_execute<span class="token punctuation">.</span>execution_timeout <span class="token operator">-</span> <span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> task_instance<span class="token punctuation">.</span>start_date<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            timeout_seconds <span class="token operator">=</span> task_to_execute<span class="token punctuation">.</span>execution_timeout<span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>

            <span class="token keyword">if</span> timeout_seconds <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> AirflowTaskTimeout<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">with</span> timeout<span class="token punctuation">(</span>timeout_seconds<span class="token punctuation">)</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> _execute_callable<span class="token punctuation">(</span>context<span class="token operator">=</span>context<span class="token punctuation">,</span> <span class="token operator">**</span>execute_callable_kwargs<span class="token punctuation">)</span>
        <span class="token keyword">except</span> AirflowTaskTimeout<span class="token punctuation">:</span>
            task_to_execute<span class="token punctuation">.</span>on_kill<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> _execute_callable<span class="token punctuation">(</span>context<span class="token operator">=</span>context<span class="token punctuation">,</span> <span class="token operator">**</span>execute_callable_kwargs<span class="token punctuation">)</span>
    <span class="token keyword">with</span> create_session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">if</span> task_to_execute<span class="token punctuation">.</span>do_xcom_push<span class="token punctuation">:</span>
            xcom_value <span class="token operator">=</span> result
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            xcom_value <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> xcom_value <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># If the task returns a result, push an XCom containing it.</span>
            <span class="token keyword">if</span> task_to_execute<span class="token punctuation">.</span>multiple_outputs<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>xcom_value<span class="token punctuation">,</span> Mapping<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">raise</span> AirflowException<span class="token punctuation">(</span>
                        <span class="token string-interpolation"><span class="token string">f&quot;Returned output was type </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">type</span><span class="token punctuation">(</span>xcom_value<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> &quot;</span></span>
                        <span class="token string">&quot;expected dictionary for multiple_outputs&quot;</span>
                    <span class="token punctuation">)</span>
                <span class="token keyword">for</span> key <span class="token keyword">in</span> xcom_value<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">raise</span> AirflowException<span class="token punctuation">(</span>
                            <span class="token string">&quot;Returned dictionary keys must be strings when using &quot;</span>
                            <span class="token string-interpolation"><span class="token string">f&quot;multiple_outputs, found </span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">type</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">) instead&quot;</span></span>
                        <span class="token punctuation">)</span>
                <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> xcom_value<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    task_instance<span class="token punctuation">.</span>xcom_push<span class="token punctuation">(</span>key<span class="token operator">=</span>key<span class="token punctuation">,</span> value<span class="token operator">=</span>value<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
            task_instance<span class="token punctuation">.</span>xcom_push<span class="token punctuation">(</span>key<span class="token operator">=</span>XCOM_RETURN_KEY<span class="token punctuation">,</span> value<span class="token operator">=</span>xcom_value<span class="token punctuation">,</span> session<span class="token operator">=</span>session<span class="token punctuation">)</span>
        _record_task_map_for_downstreams<span class="token punctuation">(</span>
            task_instance<span class="token operator">=</span>task_instance<span class="token punctuation">,</span> task<span class="token operator">=</span>task_orig<span class="token punctuation">,</span> value<span class="token operator">=</span>xcom_value<span class="token punctuation">,</span> session<span class="token operator">=</span>session
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
</code></pre></div><p>这里默认调用的是execute方法执行任务实例。<code>execute</code>方法是<code>BaseOperator</code>类及其子类的方法。<code>BaseOperator</code>是所有Airflow操作符的基类。每个Airflow操作符都必须实现<code>execute</code>方法，该方法定义了当操作符被调度执行时应该执行的具体任务。</p> <p>例如，<code>PythonOperator</code>是<code>BaseOperator</code>的一个子类，它的<code>execute</code>方法执行传入的Python函数；<code>BashOperator</code>的<code>execute</code>方法执行Bash命令；<code>BranchPythonOperator</code>的<code>execute</code>方法执行Python函数并返回要跳转到的任务等。</p> <p><img src="/assets/img/4.2.2 airflow-python-execute.86221042.png" alt="image-20240326094340078" style="zoom:50%;"><img src="/assets/img/4.2.2 airflow-bash-execute.e20ea300.png" alt="image-20240326094429613" style="zoom:50%;"></p> <p>至此，我们完整地分析了Airflow的流程引擎，从它的流程定义、解析和运行等方面进行源码分析。</p> <img src="/assets/img/wechat.50adb4d4.png" style="zoom:15%;"></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">9/12/2024, 11:20:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/4.2.1-DAG调度算法原理与实践.html" class="prev">
        4.2.1 DAG调度算法原理与实践
      </a></span> <span class="next"><a href="/4.2.3-FSM调度算法原理与实践.html">
        4.2.3 FSM调度算法原理与实践
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b8820ad2.js" defer></script><script src="/assets/js/2.a6c4a04f.js" defer></script><script src="/assets/js/1.04b49174.js" defer></script><script src="/assets/js/20.2fd50ddb.js" defer></script>
  </body>
</html>
