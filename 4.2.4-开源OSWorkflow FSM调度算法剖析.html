<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OSWorkflow核心概念 | 流程引擎原理与实践</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?925c3dadc75643902ba1d4bef48fa406";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
        </script></script>
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="国内首本从工程角度系统性介绍流程引擎的技术体系">
    <meta name="baidu-site-verification" content="codeva-c7FETTq8fo">
    <meta name="keywords" content="开源电子书，工作流技术体系，流程引擎技术体系，工作流，流程引擎，事件驱动机制，权限系统设计，云原生工作流，Crontab工作流，工作流系统架构，流程建模，DAG，FSM，WFMC，BPMN，BPM，Airflow，OsWorkflow，Petri">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.b8820ad2.js" as="script"><link rel="preload" href="/assets/js/2.a6c4a04f.js" as="script"><link rel="preload" href="/assets/js/1.04b49174.js" as="script"><link rel="preload" href="/assets/js/52.3b23c6f4.js" as="script"><link rel="prefetch" href="/assets/js/10.01c85a43.js"><link rel="prefetch" href="/assets/js/11.36ba8367.js"><link rel="prefetch" href="/assets/js/12.49270403.js"><link rel="prefetch" href="/assets/js/13.9964bf6f.js"><link rel="prefetch" href="/assets/js/14.1ffdb2cc.js"><link rel="prefetch" href="/assets/js/15.3ec6e020.js"><link rel="prefetch" href="/assets/js/16.223f06e4.js"><link rel="prefetch" href="/assets/js/17.49a0611a.js"><link rel="prefetch" href="/assets/js/18.5e539e58.js"><link rel="prefetch" href="/assets/js/19.08beb14f.js"><link rel="prefetch" href="/assets/js/20.2fd50ddb.js"><link rel="prefetch" href="/assets/js/21.94815126.js"><link rel="prefetch" href="/assets/js/22.7335372f.js"><link rel="prefetch" href="/assets/js/23.efd43c2e.js"><link rel="prefetch" href="/assets/js/24.33511251.js"><link rel="prefetch" href="/assets/js/25.9103752e.js"><link rel="prefetch" href="/assets/js/26.be3c6fce.js"><link rel="prefetch" href="/assets/js/27.a66d9ab9.js"><link rel="prefetch" href="/assets/js/28.db24d1a7.js"><link rel="prefetch" href="/assets/js/29.e639cc41.js"><link rel="prefetch" href="/assets/js/3.8ee85a39.js"><link rel="prefetch" href="/assets/js/30.9f96cad1.js"><link rel="prefetch" href="/assets/js/31.76245b5d.js"><link rel="prefetch" href="/assets/js/32.01a0bbd7.js"><link rel="prefetch" href="/assets/js/33.6cb05ad6.js"><link rel="prefetch" href="/assets/js/34.370a24a6.js"><link rel="prefetch" href="/assets/js/35.83692dfe.js"><link rel="prefetch" href="/assets/js/36.c783d15a.js"><link rel="prefetch" href="/assets/js/37.ac210fe0.js"><link rel="prefetch" href="/assets/js/38.07dc64eb.js"><link rel="prefetch" href="/assets/js/39.4ef28dca.js"><link rel="prefetch" href="/assets/js/4.9d17ba4d.js"><link rel="prefetch" href="/assets/js/40.a8fcb556.js"><link rel="prefetch" href="/assets/js/41.98d7d1f0.js"><link rel="prefetch" href="/assets/js/42.e31dd182.js"><link rel="prefetch" href="/assets/js/43.822702b0.js"><link rel="prefetch" href="/assets/js/44.50c68594.js"><link rel="prefetch" href="/assets/js/45.4e32699e.js"><link rel="prefetch" href="/assets/js/46.09f04e77.js"><link rel="prefetch" href="/assets/js/47.35c13096.js"><link rel="prefetch" href="/assets/js/48.99dfb60f.js"><link rel="prefetch" href="/assets/js/49.e1984c48.js"><link rel="prefetch" href="/assets/js/5.5682b71e.js"><link rel="prefetch" href="/assets/js/50.4242e15e.js"><link rel="prefetch" href="/assets/js/51.bdee7514.js"><link rel="prefetch" href="/assets/js/53.b6798440.js"><link rel="prefetch" href="/assets/js/54.ac356f09.js"><link rel="prefetch" href="/assets/js/55.79840f1c.js"><link rel="prefetch" href="/assets/js/56.343306c2.js"><link rel="prefetch" href="/assets/js/57.90f7511a.js"><link rel="prefetch" href="/assets/js/58.59457ff7.js"><link rel="prefetch" href="/assets/js/59.a05e2b0c.js"><link rel="prefetch" href="/assets/js/6.6aa986f5.js"><link rel="prefetch" href="/assets/js/60.7d6e698d.js"><link rel="prefetch" href="/assets/js/61.d1952570.js"><link rel="prefetch" href="/assets/js/62.a15b1cb5.js"><link rel="prefetch" href="/assets/js/63.69030ee5.js"><link rel="prefetch" href="/assets/js/64.a60b63a8.js"><link rel="prefetch" href="/assets/js/65.c1986cb9.js"><link rel="prefetch" href="/assets/js/66.e5747c76.js"><link rel="prefetch" href="/assets/js/67.c7de5e6a.js"><link rel="prefetch" href="/assets/js/68.96f4e3c6.js"><link rel="prefetch" href="/assets/js/69.db66370e.js"><link rel="prefetch" href="/assets/js/7.1fb8aaeb.js"><link rel="prefetch" href="/assets/js/70.8962d544.js"><link rel="prefetch" href="/assets/js/71.695bacdf.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.7bd035a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.png" alt="流程引擎原理与实践" class="logo"> <span class="site-name can-hide">流程引擎原理与实践</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/1-引言.html" class="nav-link">
  1 引言
</a></li><li class="dropdown-item"><!----> <a href="/2-概念.html" class="nav-link">
  2 概念
</a></li><li class="dropdown-item"><!----> <a href="/3-流程建模和解析.html" class="nav-link">
  3 流程建模和解析
</a></li><li class="dropdown-item"><!----> <a href="/4-流程引擎的核心组件.html" class="nav-link">
  4 流程引擎的核心组件
</a></li><li class="dropdown-item"><!----> <a href="/5-事件驱动机制.html" class="nav-link">
  5 事件驱动机制
</a></li><li class="dropdown-item"><!----> <a href="/6-核心表结构与接口设计.html" class="nav-link">
  6 核心表结构与接口设计
</a></li><li class="dropdown-item"><!----> <a href="/7-权限系统设计.html" class="nav-link">
  7 权限系统设计
</a></li><li class="dropdown-item"><!----> <a href="/8-分布式Crontab任务调度.html" class="nav-link">
  8 分布式Crontab任务调度
</a></li><li class="dropdown-item"><!----> <a href="/9-流程分析.html" class="nav-link">
  9 流程分析
</a></li><li class="dropdown-item"><!----> <a href="/10-云原生工作流.html" class="nav-link">
  10 云原生工作流
</a></li><li class="dropdown-item"><!----> <a href="/11-多引擎分布式系统实现.html" class="nav-link">
  11 多引擎分布式系统实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="帮助" class="dropdown-title"><span class="title">帮助</span> <span class="arrow down"></span></button> <button type="button" aria-label="帮助" class="mobile-dropdown-title"><span class="title">帮助</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about.html" class="nav-link">
  关于
</a></li><li class="dropdown-item"><!----> <a href="/sponsor.html" class="nav-link">
  打赏赞助
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/guanchao/workflow-engine-book" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/1-引言.html" class="nav-link">
  1 引言
</a></li><li class="dropdown-item"><!----> <a href="/2-概念.html" class="nav-link">
  2 概念
</a></li><li class="dropdown-item"><!----> <a href="/3-流程建模和解析.html" class="nav-link">
  3 流程建模和解析
</a></li><li class="dropdown-item"><!----> <a href="/4-流程引擎的核心组件.html" class="nav-link">
  4 流程引擎的核心组件
</a></li><li class="dropdown-item"><!----> <a href="/5-事件驱动机制.html" class="nav-link">
  5 事件驱动机制
</a></li><li class="dropdown-item"><!----> <a href="/6-核心表结构与接口设计.html" class="nav-link">
  6 核心表结构与接口设计
</a></li><li class="dropdown-item"><!----> <a href="/7-权限系统设计.html" class="nav-link">
  7 权限系统设计
</a></li><li class="dropdown-item"><!----> <a href="/8-分布式Crontab任务调度.html" class="nav-link">
  8 分布式Crontab任务调度
</a></li><li class="dropdown-item"><!----> <a href="/9-流程分析.html" class="nav-link">
  9 流程分析
</a></li><li class="dropdown-item"><!----> <a href="/10-云原生工作流.html" class="nav-link">
  10 云原生工作流
</a></li><li class="dropdown-item"><!----> <a href="/11-多引擎分布式系统实现.html" class="nav-link">
  11 多引擎分布式系统实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="帮助" class="dropdown-title"><span class="title">帮助</span> <span class="arrow down"></span></button> <button type="button" aria-label="帮助" class="mobile-dropdown-title"><span class="title">帮助</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about.html" class="nav-link">
  关于
</a></li><li class="dropdown-item"><!----> <a href="/sponsor.html" class="nav-link">
  打赏赞助
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/guanchao/workflow-engine-book" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第一部份：流程引擎基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>第二部份：流程引擎实现</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>4 流程引擎的核心组件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/4.1-WFMC工作流参考模型.html" class="sidebar-link">4.1 WFMC工作流参考模型</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>4.2 任务调度机制</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/4.2.1-DAG调度算法原理与实践.html" class="sidebar-link">4.2.1 DAG调度算法原理与实践</a></li><li><a href="/4.2.2-开源Airflow DAG调度算法剖析.html" class="sidebar-link">4.2.2 开源Airflow DAG调度算法剖析</a></li><li><a href="/4.2.3-FSM调度算法原理与实践.html" class="sidebar-link">4.2.3 FSM调度算法原理与实践</a></li><li><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html" class="active sidebar-link">4.2.4 开源OSWorkflow FSM调度算法剖析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#osworkflow核心概念" class="sidebar-link">OSWorkflow核心概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#step-步骤" class="sidebar-link">step（步骤）</a></li><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#action-动作" class="sidebar-link">action（动作）</a></li><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#condition-条件" class="sidebar-link">condition（条件）</a></li><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#pre-function、post-function-前置函数、后置函数" class="sidebar-link">pre-function、post-function（前置函数、后置函数）</a></li><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#result-结果" class="sidebar-link">result（结果）</a></li></ul></li><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#osworkflow-fsm核心方法剖析" class="sidebar-link">OSWorkflow FSM核心方法剖析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#工作流案例" class="sidebar-link">工作流案例</a></li><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#工作流测试" class="sidebar-link">工作流测试</a></li><li class="sidebar-sub-header"><a href="/4.2.4-开源OSWorkflow FSM调度算法剖析.html#核心方法分析" class="sidebar-link">核心方法分析</a></li></ul></li></ul></li><li><a href="/4.2.5-Petri网调度算法原理与实践.html" class="sidebar-link">4.2.5 Petri网调度算法原理与实践</a></li><li><a href="/4.2.6-开源YAWL Petri网调度算法剖析.html" class="sidebar-link">4.2.6 开源YAWL Petri网调度算法剖析</a></li></ul></section></li><li><a href="/4.3-工作流模式-控制流模式.html" class="sidebar-link">4.3 工作流模式-控制流模式</a></li><li><a href="/4.4-资源调度机制-资源模式.html" class="sidebar-link">4.4 资源调度机制-资源模式</a></li><li><a href="/4.5-数据管理机制-数据模式.html" class="sidebar-link">4.5 数据管理机制-数据模式</a></li><li><a href="/4.6-异常处理机制-异常处理模式.html" class="sidebar-link">4.6 异常处理机制-异常处理模式</a></li><li><a href="/4.7-引擎执行模式.html" class="sidebar-link">4.7 引擎执行模式</a></li></ul></section></li><li><a href="/5-事件驱动机制.html" class="sidebar-link">5 事件驱动机制</a></li><li><a href="/6-核心表结构与接口设计.html" class="sidebar-link">6 核心表结构与接口设计</a></li><li><a href="/7-权限系统设计.html" class="sidebar-link">7 权限系统设计</a></li><li><a href="/8-分布式Crontab任务调度.html" class="sidebar-link">8 分布式Crontab任务调度</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第三部份：流程引擎进阶</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="osworkflow核心概念"><a href="#osworkflow核心概念" class="header-anchor">#</a> OSWorkflow核心概念</h2> <img src="/assets/img/4.2.4-osworkflow.d31f927d.png" alt="image-20240905124136968" style="zoom:33%;"> <ul><li>项目地址：https://github.com/ailohq/osworkflow</li></ul> <p>OSWorkflow（Open Symphony Workflow）是一个灵活的、可扩展的、基于Java的工作流引擎。它的工作流引擎是基于有限状态机（Finite State Machine，简称FSM）概念实现的。有限状态机是一种抽象的计算模型，用来表示和控制执行流程。在OSWorkflow中，有限状态机用于描述工作流的执行过程和状态转换。</p> <p>在OSWorkflow中，每个工作流都被定义为一个有限状态机。每个状态机包含一系列的状态（State，即步骤step+状态status）、转换（Transition）和动作（Action）。状态表示工作流的当前位置，转换表示状态之间的流转，动作则是引导从一个状态到另一个状态的行为。</p> <p>以下是OSWorkflow基于有限状态机的实现的基本步骤：</p> <ol><li>定义工作流：在OSWorkflow中，工作流是通过XML文件进行定义的。这个XML文件描述了工作流的所有状态、转换和动作。</li> <li>创建工作流实例：当需要启动一个新的工作流时，OSWorkflow引擎会根据工作流定义创建一个新的工作流实例。</li> <li>执行动作：当工作流实例在某个状态时，可以执行一个或多个动作。这些动作可能会改变工作流实例的状态，引导工作流实例向前流转。</li> <li>状态转换：当执行动作后，工作流实例的状态可能会发生改变。这个改变就是一个状态转换。状态转换是由动作触发的。</li> <li>条件判断：在执行动作和状态转换时，OSWorkflow引擎会进行条件判断。只有当满足特定条件时，动作才会被执行，状态才会发生转换。</li> <li>结束工作流：当工作流实例达到终止状态时，工作流就结束了。</li></ol> <p>通过以上步骤，OSWorkflow引擎实现了基于有限状态机的工作流管理。这种方式使得工作流的流程和规则变得清晰明了，便于理解和管理。下面我们将进一步了解它的实现原理。</p> <p>正常一个OSWorkflow工作流包含多个步骤。每一个步骤都有一个当前状态(例如,：Queued,、Underway,或 Finished)。每一个步骤中都有一个或者多个动作可以被执行。每一个动作都可以设置执行条件(condition)，也可以设置执行函数(pre-function 或 post-function)。动作产生的结果(result)会导致工作流的状态和当前步骤发生改变。</p> <blockquote><p>工作流的xml定义</p></blockquote> <p>如下是一个OSWorkflow工作流定义的组成部份。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">workflow</span> <span class="token name">PUBLIC</span> <span class="token string">&quot;-//Open Source Workflow//DTD OSWf 3.0//EN&quot;</span> 
          <span class="token string">&quot;http://oswf.sourceforge.net/OSWf-3.0.dtd&quot;</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workflow</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>initial-actions</span><span class="token punctuation">&gt;</span></span>
        .
        .
        .
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>initial-actions</span><span class="token punctuation">&gt;</span></span>


  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>steps</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span><span class="token punctuation">&gt;</span></span> 
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>actions</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span><span class="token punctuation">&gt;</span></span> 
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span> 
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>zz<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditional-result</span> <span class="token attr-name">...</span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span> 
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span> 
        ...
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>actions</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>step</span><span class="token punctuation">&gt;</span></span> 
     .
     .
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>steps</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workflow</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>首先是标准的XML头部，要注意的是OSWorkflow将会通过这些指定的DTD来验证XML内容的合法性。你可以使用绝大多数的XML编辑工具来编辑它。</p> <ul><li><p>workflow表示一个工作流</p></li> <li><p>initial-actions定义初始化步骤。初始化步骤是一种特殊类型的步骤，它用来启动工作流。在一个工作流程开始前，它是没有状态的，不处在任何一个步骤，用户必须采取某些动作才能开始这个流程。这些特殊步骤被定义在 <initial-actions>。例如下面的：</initial-actions></p> <p>这个动作只是简单的说明了下一个我们要去的步骤和状态。触发动作action发生后，工作流会流转到步骤1，并且状态会变为Queued。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>initial-actions</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Start Workflow<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Queued<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>initial-actions</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <p>下面，我们进一步分析其他构成元素。</p> <h3 id="step-步骤"><a href="#step-步骤" class="header-anchor">#</a> step（步骤）</h3> <p>Step表示工作流所处的位置，一个 Step 里面可以有一个或多个 Action（即actions数组）。执行哪一个action则取决于用户、外部事件或自动触发器。而一个工作流由多个Step来表示流程。</p> <p>从一个step触发可以流转到另一个Step，也可以在同一个step内部流转（因为一个step可以有多个状态status）。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workflow</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>steps</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>actions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
        ...
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>actions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>step</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>step</span><span class="token punctuation">&gt;</span></span>
    ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>steps</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workflow</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="action-动作"><a href="#action-动作" class="header-anchor">#</a> action（动作）</h3> <p>action表示动作，每个步骤都有一个或多个action。</p> <p>action 触发发生在 step 内或 step 之间的流转，或者说是基于 State 的流转。action 和step 之间的关系是，step 说明“在哪里”，action 说明“去哪里”。 每一个动作至少有一个无条件结果(unconditional result)和零到多个条件结果(conditional result) 。例如下面的例子：</p> <p>该步骤叫<code>First Draft</code>，它定义了2个动作，分别是：<code>Start First Draft</code>和<code>Finish First Draft</code>。每个步骤都有一个默认的无条件结果<code>unconditional-result</code>。</p> <p>其中old-status属性是用来指明当前步骤完成以后的状态是什么，大部分情况下通常用&quot;Finished&quot;表示。</p> <p>而status属性表示该流程实例的状态status，status的取值可以是Underway或者Queued。</p> <p>由于下面定义的两个动作没有任何限制，所以用户可以任意调用一个动作都可以。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>First Draft<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>actions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Start First Draft<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finish First Draft<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Queued<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>actions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>step</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>finished<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>正常来说上面应该要先完成<code>Start First Draft</code>，才能开始<code>Finish First Draft</code>。但是上面因为没有做限制导致没有先后顺序。</p> <p>要解决上面的问题，我们可以通过下面的condition条件做约束。</p> <h3 id="condition-条件"><a href="#condition-条件" class="header-anchor">#</a> condition（条件）</h3> <p>条件（Condition）是用于控制工作流转换（Transition）是否可以发生的关键组件。条件的结果为真（true）时，转换可以发生；结果为假（false）时，转换无法发生。每个动作可以设置0个或多个约束条件。</p> <p>在OSWorkflow中内置了很多条件，例如下面我们会用到的<code>com.opensymphony.workflow.util.StatusCondition</code>条件。</p> <p><code>com.opensymphony.workflow.util.StatusCondition</code>用于检查工作流实例的状态。具体来说，它会比较工作流实例当前步骤（Step）的状态与预定义的状态值，以确定条件是否满足。如果当前步骤的状态与预定义的状态值相等，则条件结果为真（true），否则为假（false）。</p> <p>要使用 StatusCondition，需要在工作流定义文件（例如 workflow.xml）中添加一个条件元素（condition element），并指定其类型为 <code>com.opensymphony.workflow.util.StatusCondition</code>。然后，需要配置一个参数（argument），用于指定预定义的状态值。例如下面我们对<code>Start First Draft</code>动作添加condition条件。</p> <div class="language-xml-dtd extra-class"><pre class="language-text"><code>&lt;action id=&quot;1&quot; name=&quot;Start First Draft&quot;&gt;
  &lt;restrict-to&gt;
    &lt;conditions&gt;
      &lt;condition type=&quot;class&quot;&gt;
        &lt;arg name=&quot;class.name&quot;&gt;com.opensymphony.workflow.util.StatusCondition&lt;/arg&gt;
        &lt;arg name=&quot;status&quot;&gt;Queued&lt;/arg&gt;
      &lt;/condition&gt;
    &lt;/conditions&gt;
  &lt;/restrict-to&gt;
  &lt;results&gt;
    &lt;unconditional-result old-status=&quot;Finished&quot; status=&quot;Underway&quot; step=&quot;1&quot;/&gt;
  &lt;/results&gt;
&lt;/action&gt;
</code></pre></div><p>其中的<code>&lt;restrict-to&gt;</code> 标签定义了一组条件，只有当这些条件都满足时，这个动作才能被执行。上面的条件定义保证了action动作1只能在当前状态为“Queued”的时候才能被调用，也就是说在初始化动作被调用以后。</p> <p>接下来，我们想在一个用户开始<code>Start First Draft</code>以后，设置他为“owner”。为了达到这样的目的，我们需要做2件事情：</p> <ol><li>通过一个函数设置<code>caller</code>变量在当前的环境设置里。</li> <li>根据<code>caller</code>变量来设置<code>owner</code>属性。<code>com.opensymphony.workflow.util.Caller</code>是Osworkflow提供的内置函数，该函数获得当前调用工作流的用户，并放入一个名为caller的字符型变量中。</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Start First Draft<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>restrict-to</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>com.opensymphony.workflow.util.StatusCondition<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Queued<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>restrict-to</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre-functions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>com.opensymphony.workflow.util.Caller<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre-functions</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">owner</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>＄{caller}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这段 XML 定义了一个动作，这个动作在工作流实例的当前步骤的状态为 &quot;Queued&quot; 时可以被执行，执行的结果是将工作流实例的状态改为 &quot;Underway&quot;，并将工作流实例移动到步骤 1。</p> <p>我们也对动作2设置条件，如下：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finish First Draft<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>restrict-to</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>AND<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>com.opensymphony.workflow.util.StatusCondition<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Underway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>com.opensymphony.workflow.util.AllowOwnerOnlyCondition<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>restrict-to</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Queued<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在这段XML定义中，<code>&lt;restrict-to&gt;</code> 使用了一个类型为 &quot;AND&quot; 的条件组合，表示这两个条件都需要满足才能执行。</p> <ul><li>第一个使用 StatusCondition 类来检查工作流实例的状态。具体来说，只有当工作流实例的当前步骤的状态为 &quot;Underway&quot; 时，这个动作才能被执行。</li> <li>第二个使用AllowOwnerOnlyCondition 类来检查当前用户是否为步骤的所有者。只有当当前用户是步骤的所有者时，这个动作才能被执行。</li></ul> <p>这段 XML 定义了一个动作，这个动作在工作流实例的当前步骤的状态为 &quot;Underway&quot; 且当前用户是步骤的所有者时可以被执行，执行的结果是将工作流实例的状态改为 &quot;Queued&quot;，并将工作流实例移动到步骤 2。</p> <h3 id="pre-function、post-function-前置函数、后置函数"><a href="#pre-function、post-function-前置函数、后置函数" class="header-anchor">#</a> pre-function、post-function（前置函数、后置函数）</h3> <h4 id="action动作中的函数定义"><a href="#action动作中的函数定义" class="header-anchor">#</a> action动作中的函数定义</h4> <p>在 OSWorkflow 中，每个动作（Action）都可以配置前置函数（Pre-function）和后置函数（Post-function）。这些函数在动作执行的前后被调用，用于执行一些特定的操作，例如修改工作流实例的属性、验证数据、发送通知等。</p> <p>![image-20240318225137351](./img/4.2 osworkflow-action函数调用.png)</p> <ol><li>前置函数（Pre-function）：这些函数在动作执行前被调用。它们通常用于准备动作的执行环境，例如设置动作的输入参数、验证数据的有效性、检查权限等。如果前置函数执行失败（例如数据验证失败），动作将不会被执行。</li> <li>后置函数（Post-function）：这些函数在动作执行后被调用。它们通常用于处理动作的执行结果，例如更新工作流实例的状态、保存数据、发送通知等。如果后置函数执行失败（例如数据保存失败），动作的执行结果可能会被回滚。</li></ol> <p>在 OSWorkflow 的 XML 定义中，前置函数和后置函数使用 <code>&lt;pre-functions&gt;</code> 和 <code>&lt;post-functions&gt;</code> 标签进行配置。每个函数都有一个类型（type）和一组参数（arg）。类型用于指定函数的实现类，参数用于配置函数的输入参数。例如：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Approve<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre-functions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>com.example.workflow.MyPreFunction<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre-functions</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>post-functions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>com.example.workflow.MyPostFunction<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>post-functions</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在这个例子中，动作 &quot;Approve&quot; 有一个前置函数 MyPreFunction 和一个后置函数 MyPostFunction。在动作执行前，MyPreFunction 将被调用；在动作执行后，MyPostFunction 将被调用。</p> <h4 id="step步骤中的函数定义"><a href="#step步骤中的函数定义" class="header-anchor">#</a> step步骤中的函数定义</h4> <p>如果是在一个 step 中定义的 pre-function 和 post-function，用法会有所不同，pre-function 将会在工作流流转到这个 step 之前执行。注意这个 pre-function 将会在任何目的是此步骤的流 转发生之前执行，甚至是这个步骤本身(举个例子，如果状态从 Queued 转换到 Finished 但并 未改变步骤也会执行 pre-function)。 同样的，step的post-functions 也将会在工作流传递出这个步骤之前调用，甚至当它自己改变状 态但步骤不发生改变也是如此。 下图的图解说明了调用顺序。注意 action 虚线内做了一些抽象，它自己也可以有 per-function 和 post-function。</p> <p>![image-20240318224915637](./img/4.2 osworkflow种step的函数调用.png)</p> <h3 id="result-结果"><a href="#result-结果" class="header-anchor">#</a> result（结果）</h3> <p>result（结果）是用于描述工作流动作（action）执行后的输出。它定义了工作流实例（workflow instance）在动作执行完成后应该转移到的下一个步骤（step），以及与之相关的状态、所有者和其他属性的变更。result 在工作流定义文件（例如 workflow.xml）中的 <code>&lt;results&gt;</code> 标签内进行配置。</p> <p>对于每一个动作，都要求至少存在一个结果，称为 Unconditional- Result（无条件结果）。结果只不过是一系列指令，告诉流程引擎下一步是什么。这涉及在构成给定工作流的状态机中从一个步骤到下一步的转换。</p> <p>在 OSWorkflow 中，有两种类型的结果：</p> <ul><li>无条件结果（Unconditional Result）：这是最常见的结果类型，表示在动作执行后，无论条件是否满足，都会发生的结果。无条件结果使用 <code>&lt;unconditional-result&gt;</code> 标签进行定义。例如：</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>InProgress<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Completed<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>在这个例子中，无条件结果将工作流实例的状态从 &quot;InProgress&quot; 更改为 &quot;Completed&quot;，并将实例移动到步骤 2。</p> <ul><li>条件结果（Conditional Result）：这种结果类型表示只有在满足某些条件时才会发生的结果。条件结果使用 <code>&lt;conditional-result&gt;</code> 标签进行定义，并在其中配置一个或多个条件（condition）。例如：</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditional-result</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>com.opensymphony.workflow.util.StatusCondition<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Approved<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>InProgress<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Completed<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditional-result</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在这个例子中，条件结果会检查工作流实例的当前步骤状态是否为 &quot;Approved&quot;。如果满足该条件，结果将工作流实例的状态从 &quot;InProgress&quot; 更改为 &quot;Completed&quot;，并将实例移动到步骤 2。</p> <blockquote><p>执行结果后的三种选择</p></blockquote> <p>在 OSWorkflow 中，执行完 result（结果）后，工作流实例（workflow instance）可能会转移到三种不同的情况：到达 step（步骤）、到达 split（分支）和到达 join（聚合）。下面分别介绍这三种情况：</p> <ul><li><p>到达 step（步骤）：这是最常见的情况，表示工作流实例在执行完动作（action）后，到达了一个新的步骤。步骤是工作流中的一个节点，用于表示工作流实例的状态和执行位置。在执行完 result 后，工作流实例会根据 result 的配置，将其状态、所有者等属性进行更改，并转移到下一个步骤。例如：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>InProgress<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Completed<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>在这个例子中，执行完 result 后，工作流实例的状态从 &quot;InProgress&quot; 更改为 &quot;Completed&quot;，并转移到步骤 2。</p></li> <li><p>到达 split（分支）：这种情况表示工作流实例在执行完动作后，到达了一个分支节点。分支节点用于在工作流中创建多个并行执行路径，从而实现复杂的业务逻辑。在到达分支节点后，工作流实例会根据分支节点的配置，同时进入多个步骤，并在这些步骤中并行执行。例如：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>InProgress<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Completed<span class="token punctuation">&quot;</span></span> <span class="token attr-name">split</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>splits</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>split</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>split</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>splits</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在这个例子中，执行完 result 后，工作流实例的状态从 &quot;InProgress&quot; 更改为 &quot;Completed&quot;，并转移到分支节点 2。</p></li> <li><p>到达 join（聚合）：这种情况表示工作流实例在执行完动作后，到达了一个聚合节点。聚合节点用于将多个并行执行路径重新合并为一个路径，从而实现对工作流实例的同步。在到达聚合节点后，工作流实例会等待所有并行执行路径都完成，然后根据聚合节点的配置，将其状态、所有者等属性进行更改，并转移到下一个步骤。例如：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!--</span> <span class="token attr-name">for</span> <span class="token attr-name">step</span> <span class="token attr-name">id</span> <span class="token attr-name">6</span> <span class="token attr-name">-</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">join</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!-</span> <span class="token attr-name">for</span> <span class="token attr-name">step</span> <span class="token attr-name">id</span> <span class="token attr-name">8</span> <span class="token attr-name">-</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">join</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>joins</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>join</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>AND<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanshell<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          &quot;Finished&quot;.equals(jn.getStep(6).getStatus()
          &amp;&amp; &quot;Finished&quot;.equals(jn.getStep(8).getStatus())
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>join</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>joins</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>我们定义了一个 ID 为 1 的聚合节点。这个聚合节点有一个条件，使用 BeanShell 脚本来检查步骤 6 和步骤 8 的状态是否都为 &quot;Finished&quot;。只有当这两个步骤的状态都为 &quot;Finished&quot; 时，这个聚合节点才会被执行。</p> <p>执行聚合节点后，有一个无条件结果，将工作流实例的状态更改为 &quot;Underway&quot;，并将实例移动到步骤 2。</p></li></ul> <h2 id="osworkflow-fsm核心方法剖析"><a href="#osworkflow-fsm核心方法剖析" class="header-anchor">#</a> OSWorkflow FSM核心方法剖析</h2> <h3 id="工作流案例"><a href="#工作流案例" class="header-anchor">#</a> 工作流案例</h3> <p>下面，我们通过创建一个简单的工作流，追踪它执行动作的代码过程来进行分析。</p> <p>首先应该载入流程定义文件创建定义工作流的文件（在 XML 里面）。</p> <p>在开始载入流程定义、调用动作以前，我们需要配置OSWorkflow的数据存储方式和定义文件的位置等。</p> <blockquote><p>osworkflow.xml</p></blockquote> <p>下面指明了我们准备使用内存 (MemoryWorkflowStore) 来保存流程数据。这样可以减少设置数据库的相关信息，减少出问题的可能性。用内存持久化对于测试来说是非常方便的。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>osworkflow</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>persistence</span>
		<span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.opensymphony.workflow.spi.memory.MemoryWorkflowStore<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>factory</span>
		<span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.opensymphony.workflow.loader.XMLWorkflowFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>resource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>workflows.xml<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>factory</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>osworkflow</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面的配置文件还指明了我们工作流工厂（XMLWorkflowFactory），工作流工厂的主要功能是管理流程定义文件，包括读取定义文件和修改定义文件的功能。通过<code>resource</code>这个属性指明了采用通过从classpath中读取流程定义文件的方式，按照这个定义，接下来我们需要在classpath中创建一个名为workflows.xml的文件。</p> <blockquote><p>workflows.xml</p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workflows</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workflow</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mytest<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>resource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myworkflow.xml<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workflows</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><p>myworkflow.xml</p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">workflow</span> <span class="token name">PUBLIC</span> 
  <span class="token string">&quot;-//OpenSymphony Group//DTD OSWorkflow 2.7//EN&quot;</span>
  <span class="token string">&quot;http://www.opensymphony.com/osworkflow/workflow_2_7.dtd&quot;</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>workflow</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>initial-actions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Start Workflow<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Queued<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>initial-actions</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>steps</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>First Draft<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>actions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Start First Draft<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>restrict-to</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                   com.opensymphony.workflow.util.StatusCondition
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Queued<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>restrict-to</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre-functions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                 com.opensymphony.workflow.util.Caller
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre-functions</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> 
            <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">owner</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>＄{caller}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finish First Draft<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>restrict-to</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>AND<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    com.opensymphony.workflow.util.StatusCondition
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Underway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>class.name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                  com.opensymphony.workflow.util.AllowOwnerOnlyCondition
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>restrict-to</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>results</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Queued<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>results</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>actions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>step</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>finished<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>steps</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>workflow</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="工作流测试"><a href="#工作流测试" class="header-anchor">#</a> 工作流测试</h3> <p>接下来，我们从测试工作流开始切入其源码分析。</p> <p>OSWorkflow关于状态机的核心代码都在AbstractWorkflow中，其中EJBWorkflow 、 SOAPWorkflow、BasicWorkflow扩展自它。AbstractWorkflow实现了Workflow接口，该接口包含了工作流的核心方法，其中最重要的就是doAction方法。 为了简单起见，我们使用最基本的一种： BasicWorkflow。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> caller <span class="token operator">=</span> <span class="token string">&quot;tester&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> workflowId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// 下一步是提供配置文件，在大多数情况下，只是简单的传递一个DefaultConfiguration实例：</span>
<span class="token comment">// 现在我们已经创建并且配置好了一个workflow，接下来就是开始调用它了。</span>
<span class="token class-name">DefaultConfiguration</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
workflow<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 首先我们需要调用initialize 方法来启动一个工作流程，这个方法有3个参数，workflow name （定义在workflows.xml里，通过workflow factory处理）, action ID （我们要调用的初始化动作的ID，这里是1），和初始化变量。 因为在例子里面不需初始化变量，所以我们只是传递一个null，</span>
<span class="token class-name">Workflow</span> workflow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicWorkflow</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
workflowId <span class="token operator">=</span> workflow<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token string">&quot;mytest&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这是简单的调用第一个动作，工作流引擎根据指定的条件，改变状态到‘Underway’，并且保持在当前步骤。</span>
workflow<span class="token punctuation">.</span><span class="token function">doAction</span><span class="token punctuation">(</span>workflowId<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="核心方法分析"><a href="#核心方法分析" class="header-anchor">#</a> 核心方法分析</h3> <p>根据前面工作流测试的代码，我们通过去分析其中几个核心方法的源码来了解OSWorkflow实现FSM的原理：</p> <h4 id="initialize方法"><a href="#initialize方法" class="header-anchor">#</a> initialize方法</h4> <p><code>initialize</code>方法是用来初始化一个工作流的。函数接收三个参数：一个字符串类型的workflowName，一个整数类型的initialAction和一个Map类型的inputs。</p> <p>initialize初始化方法主要完成了以下几个功能：</p> <ul><li>首先，它从配置中获取工作流描述符WorkflowDescriptor对象wf，然后从持久化存储中获取WorkflowStore对象store，并创建一个新的工作流条目WorkflowEntry对象entry。</li> <li>然后，将工作流条目的ID和名称放入inputs map中。创建一个新的属性集合PropertySet对象ps，它是从持久化存储中获取的，然后创建一个新的Map对象transientVars。</li> <li>如果inputs不为空，将其所有元素都添加到transientVars中。然后，使用populateTransientMap方法填充transientVars。</li> <li>接着，如果不能初始化工作流，则回滚上下文并抛出InvalidRoleException异常。</li> <li>然后，获取初始动作描述符ActionDescriptor对象action，然后尝试转换工作流。如果在转换过程中发生WorkflowException异常，则回滚上下文并抛出该异常。</li> <li>最后，获取工作流条目的ID，并返回该ID。</li></ul> <p>以下是<code>initialize</code>方法的完整代码：</p> <blockquote><p>路径：https://github.com/ailohq/osworkflow/blob/master/src/main/java/com/opensymphony/workflow/AbstractWorkflow.java#L607</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> workflowName<span class="token punctuation">,</span> <span class="token keyword">int</span> initialAction<span class="token punctuation">,</span> <span class="token class-name">Map</span> inputs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InvalidRoleException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidInputException</span><span class="token punctuation">,</span> <span class="token class-name">WorkflowException</span> <span class="token punctuation">{</span>
        <span class="token class-name">WorkflowDescriptor</span> wf <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWorkflow</span><span class="token punctuation">(</span>workflowName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WorkflowStore</span> store <span class="token operator">=</span> <span class="token function">getPersistence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WorkflowEntry</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">createEntry</span><span class="token punctuation">(</span>workflowName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Chanthu</span>
        inputs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">WORKFLOW_ID_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">WORKFLOW_NAME_KEY</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getWorkflowName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// start with a memory property set, but clone it after we have an ID</span>
        <span class="token class-name">PropertySet</span> ps <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getPropertySet</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> transientVars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            transientVars<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">populateTransientMap</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> wf<span class="token punctuation">.</span><span class="token function">getRegisters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>initialAction<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token constant">EMPTY_LIST</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canInitialize</span><span class="token punctuation">(</span>workflowName<span class="token punctuation">,</span> initialAction<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidRoleException</span><span class="token punctuation">(</span><span class="token string">&quot;You are restricted from initializing this workflow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ActionDescriptor</span> action <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getInitialAction</span><span class="token punctuation">(</span>initialAction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">transitionWorkflow</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token constant">EMPTY_LIST</span><span class="token punctuation">,</span> store<span class="token punctuation">,</span> wf<span class="token punctuation">,</span> action<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WorkflowException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">long</span> entryId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// now clone the memory PS to the real PS</span>
        <span class="token comment">// PropertySetManager.clone(ps, store.getPropertySet(entryId));</span>
        <span class="token keyword">return</span> entryId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>前面的初始化代码，我们看到获取了初始动作后，开始调用<code>transitionWorkflow</code>方法进行状态转换，接下来我们对这个方法进行分析。</p> <h4 id="transitionworkflow方法"><a href="#transitionworkflow方法" class="header-anchor">#</a> transitionWorkflow方法</h4> <blockquote><p>transitionWorkflow方法</p></blockquote> <p><code>transitionWorkflow</code>函数主要目的是处理工作流实例的状态转换。以下是这个函数的主要功能：</p> <ol><li><p>清除或初始化状态缓存。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span> cache <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> stateCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    stateCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>获取当前步骤。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Step</span> step <span class="token operator">=</span> <span class="token function">getCurrentStep</span><span class="token punctuation">(</span>wf<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentSteps<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>	
</code></pre></div></li> <li><p>验证输入。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">verifyInputs</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果动作有验证器，使用<code>verifyInputs</code>方法验证输入参数。</p></li> <li><p>执行步骤的后置函数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span> stepPostFunctions <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>step<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> stepPostFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果当前步骤不为空，执行步骤的后置函数。</p></li> <li><p>执行动作的前置函数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span> preFunctions <span class="token operator">=</span> action<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> preFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>遍历动作的前置函数列表，执行每个前置函数。</p></li> <li><p>处理条件结果</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span> conditionalResults <span class="token operator">=</span> action<span class="token punctuation">.</span><span class="token function">getConditionalResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> extraPreFunctions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> extraPostFunctions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">ResultDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> theResults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultDescriptor</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>这部分代码首先初始化条件结果、额外的前置函数和后置函数列表。然后遍历条件结果，检查是否满足条件。如果满足条件，执行额外的前置函数和后置函数。</p></li> <li><p>处理分支（split）和连接（join）操作，见下面代码片段。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getSplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>7.1 处理分支（split）</p></blockquote> <p>处理分支（Split）的代码用于处理工作流中的分支逻辑。分支意味着工作流会根据条件分解为多个并行的子流程。</p> <p>这里结合前面的spli的xml定义一起分析会更清晰。theResults是当前动作的结果，theResults[0]表示取第一个split元素。每个split里面有多个无条件结果，每个无条件结果都会指向新的步骤和状态。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>InProgress<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Completed<span class="token punctuation">&quot;</span></span> <span class="token attr-name">split</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>splits</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>split</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>split</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>splits</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>以下是对这部分代码的执行功能：</p> <ul><li><p>7.1.1 获取分支描述符和结果：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">SplitDescriptor</span> splitDesc <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getSplit</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getSplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Collection</span> results <span class="token operator">=</span> splitDesc<span class="token punctuation">.</span><span class="token function">getResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这部分代码首先获取分支描述符，然后从分支描述符中获取结果集合。</p></li> <li><p>7.1.2 验证输入和收集函数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ResultDescriptor</span> resultDescriptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResultDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultDescriptor<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">verifyInputs</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> resultDescriptor<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    splitPreFunctions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>resultDescriptor<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    splitPostFunctions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>resultDescriptor<span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码遍历结果集合，对每个结果进行输入验证，并收集所有的前置函数和后置函数。</p></li> <li><p>7.1.3 执行前置函数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> splitPreFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码遍历前置函数列表，执行每个前置函数。</p></li> <li><p>7.1.4 创建新的当前步骤：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">.</span><span class="token function">isFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> moveFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    theResults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultDescriptor</span><span class="token punctuation">[</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    results<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>theResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResultDescriptor</span> resultDescriptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResultDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Step</span> moveToHistoryStep <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>moveFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            moveToHistoryStep <span class="token operator">=</span> step<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> previousIds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            previousIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">createNewCurrentStep</span><span class="token punctuation">(</span>resultDescriptor<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> store<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> moveToHistoryStep<span class="token punctuation">,</span> previousIds<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        moveFirst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果当前动作不是结束动作，这部分代码会为每个分支结果创建一个新的当前步骤。<code>createNewCurrentStep</code>方法用于创建新的当前步骤，并将旧的当前步骤移动到历史步骤中。</p></li> <li><p>7.1.5 执行后置函数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> splitPostFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码遍历后置函数列表，执行每个后置函数。</p></li></ul> <blockquote><p>7.2 处理连接（join）</p></blockquote> <p>结合join的xml定义一起分析下面的代码：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>joins</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>join</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>AND<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanshell<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>script<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          &quot;Finished&quot;.equals(jn.getStep(6).getStatus()
          &amp;&amp; &quot;Finished&quot;.equals(jn.getStep(8).getStatus())
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>condition</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>unconditional-result</span> <span class="token attr-name">old-status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Finished<span class="token punctuation">&quot;</span></span> <span class="token attr-name">status</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Underway<span class="token punctuation">&quot;</span></span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>join</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>joins</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><p>7.2.1 获取连接描述符：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">JoinDescriptor</span> joinDesc <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
</code></pre></div></li> <li><p>7.2.2 标记当前步骤为已完成并移至历史步骤：</p> <div class="language-java extra-class"><pre class="language-java"><code>step <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">markFinished</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getOldStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
store<span class="token punctuation">.</span><span class="token function">moveToHistory</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这部分代码将当前步骤标记为已完成，并将其移至历史步骤中。</p></li> <li><p>7.2.3 收集参与连接的步骤：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Collection</span> joinSteps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
joinSteps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> currentSteps<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Step</span> currentStep <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Step</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStep<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StepDescriptor</span> stepDesc <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stepDesc<span class="token punctuation">.</span><span class="token function">resultsInJoin</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            joinSteps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码首先将当前步骤添加到参与连接的步骤集合中，然后遍历当前的步骤，如果步骤的描述符表示它会结果在当前的连接，那么就将它添加到参与连接的步骤集合中。</p></li> <li><p>7.2.4 检查历史步骤：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span> historySteps <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">findHistorySteps</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> i <span class="token operator">=</span> historySteps<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Step</span> historyStep <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Step</span><span class="token punctuation">)</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>historyStep<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StepDescriptor</span> stepDesc <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>historyStep<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stepDesc<span class="token punctuation">.</span><span class="token function">resultsInJoin</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            joinSteps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>historyStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>7.2.5 检查连接条件：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">JoinNodes</span> jn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JoinNodes</span><span class="token punctuation">(</span>joinSteps<span class="token punctuation">)</span><span class="token punctuation">;</span>
transientVars<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;jn&quot;</span><span class="token punctuation">,</span> jn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">passesConditions</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> joinDesc<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码首先创建一个<code>JoinNodes</code>对象，然后检查是否满足连接的条件。如果满足条件，就执行后续的代码。</p></li> <li><p>7.2.6 验证输入并执行前置函数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ResultDescriptor</span> joinresult <span class="token operator">=</span> joinDesc<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>joinresult<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">verifyInputs</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> joinresult<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> joinresult<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码首先获取连接的结果，然后验证输入参数，最后执行前置函数。</p></li> <li><p>7.2.7 创建新的当前步骤：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> previousIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span>joinSteps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> joinSteps<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Step</span> currentStep <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Step</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStep<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>historySteps<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            store<span class="token punctuation">.</span><span class="token function">moveToHistory</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        previousIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> currentStep<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">.</span><span class="token function">isFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    previousIds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> joinDesc<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createNewCurrentStep</span><span class="token punctuation">(</span>joinDesc<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">,</span> store<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> previousIds<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码首先创建一个数组用于保存参与连接的步骤的ID，然后遍历参与连接的步骤，将步骤移至历史步骤并保存其ID。然后，如果当前动作不是结束动作，就调用<code>createNewCurrentStep</code>方法创建新的当前步骤。</p></li> <li><p>7.2.8 执行后置函数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> joinresult<span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码遍历后置函数列表，执行每个后置函数。</p></li></ul></li> <li><p>如果程序进入到另一个步骤step（不是split和join），结束当前步骤并将其移至历史步骤中去。若动作未结束，则创建新的步 骤并执行新步骤中的 pre-function前置函数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> previousIds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    previousIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">.</span><span class="token function">isFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createNewCurrentStep</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entry<span class="token punctuation">,</span> store<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> step<span class="token punctuation">,</span> previousIds<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>执行动作的后置函数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span> postFunctions <span class="token operator">=</span> action<span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> postFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>遍历动作的后置函数列表，执行每个后置函数。</p></li> <li><p>更新工作流实例状态</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wf<span class="token punctuation">.</span><span class="token function">getInitialAction</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">WorkflowEntry</span><span class="token punctuation">.</span><span class="token constant">ACTIVATED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">changeEntryState</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">WorkflowEntry</span><span class="token punctuation">.</span><span class="token constant">ACTIVATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果执行的动作是初始动作且工作流实例的状态不是已激活（ACTIVATED），则更新工作流实例的状态为已激活。</p></li> <li><p>检查是否完成工作流实例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token function">isFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">completeEntry</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCurrentSteps</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">WorkflowEntry</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果执行的动作是结束动作，调用<code>completeEntry</code>方法完成工作流实例，并返回<code>true</code>。</p></li> <li><p>执行自动执行的动作</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>availableAutoActions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">doAction</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> availableAutoActions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这部分代码首先获取可用的自动执行动作，然后执行第一个自动执行动作。在OSWorkflow中，自动执行动作是指在当前动作完成后，系统会自动执行的后续动作。</p></li> <li><p>返回<code>false</code>表示工作流实例尚未完成：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p>​	如果代码执行到这里，说明工作流实例尚未完成，返回<code>false</code>。</p> <p>下面是完整的函数代码：</p> <blockquote><p>路径：https://github.com/ailohq/osworkflow/blob/master/src/main/java/com/opensymphony/workflow/AbstractWorkflow.java#L1025</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
     * @return true if the instance has been explicitly completed is this
     * transition, false otherwise
     * @throws WorkflowException
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">transitionWorkflow</span><span class="token punctuation">(</span><span class="token class-name">WorkflowEntry</span> entry<span class="token punctuation">,</span> <span class="token class-name">List</span> currentSteps<span class="token punctuation">,</span> <span class="token class-name">WorkflowStore</span> store<span class="token punctuation">,</span> <span class="token class-name">WorkflowDescriptor</span> wf<span class="token punctuation">,</span> <span class="token class-name">ActionDescriptor</span> action<span class="token punctuation">,</span> <span class="token class-name">Map</span> transientVars<span class="token punctuation">,</span> <span class="token class-name">Map</span> inputs<span class="token punctuation">,</span> <span class="token class-name">PropertySet</span> ps<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">WorkflowException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 清除或初始化状态缓存</span>
        <span class="token class-name">Map</span> cache <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> stateCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            stateCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取当前步骤</span>
        <span class="token class-name">Step</span> step <span class="token operator">=</span> <span class="token function">getCurrentStep</span><span class="token punctuation">(</span>wf<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentSteps<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
        <span class="token comment">// 如果动作有验证器，使用verifyInputs方法验证输入参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">verifyInputs</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 执行步骤的后置函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span> stepPostFunctions <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>step<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> stepPostFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 执行动作的前置函数</span>
        <span class="token class-name">List</span> preFunctions <span class="token operator">=</span> action<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> preFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 这部分代码首先初始化条件结果、额外的前置函数和后置函数列表。然后遍历条件结果，检查是否满足条件。如果满足条件，执行额外的前置函数和后置函数</span>
        <span class="token class-name">List</span> conditionalResults <span class="token operator">=</span> action<span class="token punctuation">.</span><span class="token function">getConditionalResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span> extraPreFunctions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span> extraPostFunctions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> theResults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultDescriptor</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> conditionalResults<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ConditionalResultDescriptor</span> conditionalResult <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConditionalResultDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">passesConditions</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> conditionalResult<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">,</span> <span class="token punctuation">(</span>step <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> step<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// if (evaluateExpression(conditionalResult.getCondition(),</span>
                <span class="token comment">// entry, wf.getRegisters(), null, transientVars)) {</span>
                theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> conditionalResult<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalResult<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">verifyInputs</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> conditionalResult<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                extraPreFunctions <span class="token operator">=</span> conditionalResult<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                extraPostFunctions <span class="token operator">=</span> conditionalResult<span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// use unconditional-result if a condition hasn't been met</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> action<span class="token punctuation">.</span><span class="token function">getUnconditionalResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">verifyInputs</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            extraPreFunctions <span class="token operator">=</span> theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            extraPostFunctions <span class="token operator">=</span> theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;theResult=&quot;</span> <span class="token operator">+</span> theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token char">' '</span> <span class="token operator">+</span> theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>extraPreFunctions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>extraPreFunctions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// run any extra pre-functions that haven't been run already</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> extraPreFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// go to next step</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getSplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理分支（Split）</span>
            <span class="token class-name">SplitDescriptor</span> splitDesc <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getSplit</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getSplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Collection</span> results <span class="token operator">=</span> splitDesc<span class="token punctuation">.</span><span class="token function">getResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span> splitPreFunctions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span> splitPostFunctions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// check all results in the split and verify the input against any</span>
            <span class="token comment">// validators specified</span>
            <span class="token comment">// also build up all the pre and post functions that should be</span>
            <span class="token comment">// called.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ResultDescriptor</span> resultDescriptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResultDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>resultDescriptor<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">verifyInputs</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> resultDescriptor<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                splitPreFunctions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>resultDescriptor<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                splitPostFunctions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>resultDescriptor<span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// now execute the pre-functions</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> splitPreFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">.</span><span class="token function">isFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// now make these steps...</span>
                <span class="token keyword">boolean</span> moveFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                theResults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultDescriptor</span><span class="token punctuation">[</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                results<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>theResults<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ResultDescriptor</span> resultDescriptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResultDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Step</span> moveToHistoryStep <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>moveFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        moveToHistoryStep <span class="token operator">=</span> step<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> previousIds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        previousIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token function">createNewCurrentStep</span><span class="token punctuation">(</span>resultDescriptor<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> store<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> moveToHistoryStep<span class="token punctuation">,</span> previousIds<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    moveFirst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// now execute the post-functions</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> splitPostFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理连接（Join）</span>
            <span class="token class-name">JoinDescriptor</span> joinDesc <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            step <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">markFinished</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getOldStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            store<span class="token punctuation">.</span><span class="token function">moveToHistory</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ... now check to see if the expression evaluates</span>
            <span class="token comment">// (get only current steps that have a result to this join)</span>
            <span class="token class-name">Collection</span> joinSteps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            joinSteps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// currentSteps = store.findCurrentSteps(id); // shouldn't need to</span>
            <span class="token comment">// refresh the list</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> currentSteps<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Step</span> currentStep <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Step</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStep<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">StepDescriptor</span> stepDesc <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>stepDesc<span class="token punctuation">.</span><span class="token function">resultsInJoin</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        joinSteps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// we also need to check history steps that were finished before</span>
            <span class="token comment">// this one</span>
            <span class="token comment">// that might be part of the join</span>
            <span class="token class-name">List</span> historySteps <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">findHistorySteps</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> i <span class="token operator">=</span> historySteps<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Step</span> historyStep <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Step</span><span class="token punctuation">)</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>historyStep<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">StepDescriptor</span> stepDesc <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>historyStep<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>stepDesc<span class="token punctuation">.</span><span class="token function">resultsInJoin</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getJoin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        joinSteps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>historyStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">JoinNodes</span> jn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JoinNodes</span><span class="token punctuation">(</span>joinSteps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            transientVars<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;jn&quot;</span><span class="token punctuation">,</span> jn<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// todo verify that 0 is the right value for currentstep here</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">passesConditions</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> joinDesc<span class="token punctuation">.</span><span class="token function">getConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// move the rest without creating a new step ...</span>
                <span class="token class-name">ResultDescriptor</span> joinresult <span class="token operator">=</span> joinDesc<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>joinresult<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">verifyInputs</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> joinresult<span class="token punctuation">.</span><span class="token function">getValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>transientVars<span class="token punctuation">)</span><span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// now execute the pre-functions</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> joinresult<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> previousIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span>joinSteps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> joinSteps<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Step</span> currentStep <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Step</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStep<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// if this is already a history step (eg, for all join</span>
                        <span class="token comment">// steps completed prior to this one),</span>
                        <span class="token comment">// we don't move it, since it's already history.</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>historySteps<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            store<span class="token punctuation">.</span><span class="token function">moveToHistory</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        previousIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> currentStep<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        i<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">.</span><span class="token function">isFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ... now finish this step normally</span>
                    previousIds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> joinDesc<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// we pass in null for the current step since we've already</span>
                    <span class="token comment">// moved it to history above</span>
                    <span class="token function">createNewCurrentStep</span><span class="token punctuation">(</span>joinDesc<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">,</span> store<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> previousIds<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// now execute the post-functions</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> joinresult<span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// normal finish, no splits or joins</span>
            <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> previousIds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                previousIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>step<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">.</span><span class="token function">isFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">createNewCurrentStep</span><span class="token punctuation">(</span>theResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entry<span class="token punctuation">,</span> store<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> step<span class="token punctuation">,</span> previousIds<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// postFunctions (BOTH)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>extraPostFunctions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> extraPostFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 执行后置函</span>
        <span class="token class-name">List</span> postFunctions <span class="token operator">=</span> action<span class="token punctuation">.</span><span class="token function">getPostFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> postFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// if executed action was an initial action then workflow is activated</span>
        <span class="token comment">// 如果执行的动作是初始动作且工作流实例的状态不是已激活（ACTIVATED），则更新工作流实例的状态为已激活</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wf<span class="token punctuation">.</span><span class="token function">getInitialAction</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">WorkflowEntry</span><span class="token punctuation">.</span><span class="token constant">ACTIVATED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">changeEntryState</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">WorkflowEntry</span><span class="token punctuation">.</span><span class="token constant">ACTIVATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果执行的动作是结束动作，调用completeEntry方法完成工作流实例，并返回true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span><span class="token function">isFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">completeEntry</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCurrentSteps</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">WorkflowEntry</span><span class="token punctuation">.</span><span class="token constant">COMPLETED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 执行自动执行的动作（调用上一步的doAction方法）</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> availableAutoActions <span class="token operator">=</span> <span class="token function">getAvailableAutoActions</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>availableAutoActions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">doAction</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> availableAutoActions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="doaction方法"><a href="#doaction方法" class="header-anchor">#</a> doAction方法</h4> <p><code>doAction</code>函数的主要目的是执行一个工作流中的某个动作。<code>doAction</code>方法负责处理状态转换、执行相关的动作（Action）、调用条件判断（Conditions）以及触发后续步骤（Steps）等。</p> <p>以下是对该函数的分段解释：</p> <ol><li>获取持久化的工作流存储对象，并根据传入的id查找对应的工作流实体（WorkflowEntry）。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">WorkflowStore</span> store <span class="token operator">=</span> <span class="token function">getPersistence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WorkflowEntry</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">findEntry</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>将工作流实体的ID和名称放入输入映射中。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>inputs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">WORKFLOW_ID_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inputs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">WORKFLOW_NAME_KEY</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getWorkflowName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>判断工作流实体的状态是否为激活状态，如果不是，则直接返回。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">WorkflowEntry</span><span class="token punctuation">.</span><span class="token constant">ACTIVATED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>获取工作流描述符对象（WorkflowDescriptor），并查找当前步骤列表。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">WorkflowDescriptor</span> wf <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWorkflow</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getWorkflowName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> currentSteps <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">findCurrentSteps</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="5"><li>初始化动作描述符（ActionDescriptor）对象、属性集（PropertySet）对象和临时变量映射。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ActionDescriptor</span> action <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">PropertySet</span> ps <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getPropertySet</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> transientVars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li>将输入映射中的内容添加到临时变量映射中，并调用<code>populateTransientMap</code>方法填充临时变量映射。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>inputs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    transientVars<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">populateTransientMap</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> wf<span class="token punctuation">.</span><span class="token function">getRegisters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>actionId<span class="token punctuation">)</span><span class="token punctuation">,</span> currentSteps<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="7"><li>遍历全局动作列表，查找与传入动作ID匹配的动作描述符，并检查该动作是否可用。如果可用，则将<code>validAction</code>设置为true。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> validAction <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> gIter <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getGlobalActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>validAction <span class="token operator">&amp;&amp;</span> gIter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ActionDescriptor</span> actionDesc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActionDescriptor</span><span class="token punctuation">)</span> gIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>actionDesc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> actionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        action <span class="token operator">=</span> actionDesc<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActionAvailable</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            validAction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="8"><li>如果在全局动作列表中未找到有效动作，则遍历当前步骤列表，并在每个步骤的动作列表中查找与传入动作ID匹配的动作描述符。同样地，检查该动作是否可用，如果可用，则将<code>validAction</code>设置为true。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iter <span class="token operator">=</span> currentSteps<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>validAction <span class="token operator">&amp;&amp;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Step</span> step <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Step</span><span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StepDescriptor</span> s <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>step<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>validAction <span class="token operator">&amp;&amp;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ActionDescriptor</span> actionDesc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionDesc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> actionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            action <span class="token operator">=</span> actionDesc<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActionAvailable</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                validAction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="9"><li>如果未找到有效动作，则抛出InvalidActionException异常。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidActionException</span><span class="token punctuation">(</span><span class="token string">&quot;Action &quot;</span> <span class="token operator">+</span> actionId <span class="token operator">+</span> <span class="token string">&quot; is invalid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="10"><li>调用<code>transitionWorkflow</code>方法尝试执行工作流转换。如果工作流未显式完成，则调用<code>checkImplicitFinish</code>方法检查是否可以隐式完成。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">transitionWorkflow</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> currentSteps<span class="token punctuation">,</span> store<span class="token punctuation">,</span> wf<span class="token punctuation">,</span> action<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkImplicitFinish</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WorkflowException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>整个函数的执行流程是：首先获取工作流实体和描述符，然后遍历全局动作和当前步骤的动作，查找有效动作。找到有效动作后，执行工作流转换，最后检查工作流是否完成。</p> <p>下面是函数完整代码：</p> <blockquote><p>路径：https://github.com/ailohq/osworkflow/blob/master/src/main/java/com/opensymphony/workflow/AbstractWorkflow.java#L515</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAction</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> actionId<span class="token punctuation">,</span> <span class="token class-name">Map</span> inputs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">WorkflowException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取工作流存储和工作流实例</span>
        <span class="token class-name">WorkflowStore</span> store <span class="token operator">=</span> <span class="token function">getPersistence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WorkflowEntry</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">findEntry</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        inputs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">WORKFLOW_ID_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">WORKFLOW_NAME_KEY</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getWorkflowName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果工作流实例的状态不是已激活（ACTIVATED），则直接返回，不执行后续的动作。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">WorkflowEntry</span><span class="token punctuation">.</span><span class="token constant">ACTIVATED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取工作流描述和当前步骤</span>
        <span class="token class-name">WorkflowDescriptor</span> wf <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWorkflow</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getWorkflowName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span> currentSteps <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">findCurrentSteps</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ActionDescriptor</span> action <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">PropertySet</span> ps <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getPropertySet</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> transientVars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            transientVars<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">populateTransientMap</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> wf<span class="token punctuation">.</span><span class="token function">getRegisters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>actionId<span class="token punctuation">)</span><span class="token punctuation">,</span> currentSteps<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 这部分代码首先检查全局动作，如果动作ID匹配并且动作可用，就将validAction设置为true</span>
        <span class="token keyword">boolean</span> validAction <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> gIter <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getGlobalActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>validAction <span class="token operator">&amp;&amp;</span> gIter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ActionDescriptor</span> actionDesc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActionDescriptor</span><span class="token punctuation">)</span> gIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>actionDesc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> actionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                action <span class="token operator">=</span> actionDesc<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActionAvailable</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    validAction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果全局动作检查不通过，检查当前步骤的动作</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iter <span class="token operator">=</span> currentSteps<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>validAction <span class="token operator">&amp;&amp;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Step</span> step <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Step</span><span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StepDescriptor</span> s <span class="token operator">=</span> wf<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>step<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">getActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>validAction <span class="token operator">&amp;&amp;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ActionDescriptor</span> actionDesc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>actionDesc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> actionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    action <span class="token operator">=</span> actionDesc<span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isActionAvailable</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        validAction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果动作无效，抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidActionException</span><span class="token punctuation">(</span><span class="token string">&quot;Action &quot;</span> <span class="token operator">+</span> actionId <span class="token operator">+</span> <span class="token string">&quot; is invalid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用transitionWorkflow方法执行工作流的转换</span>
            <span class="token comment">// 尝试执行工作流的转换，如果转换失败，检查是否可以隐式完成。如果在执行转换过程中发生异常，将上下文设置为只回滚，然后抛出异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">transitionWorkflow</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> currentSteps<span class="token punctuation">,</span> store<span class="token punctuation">,</span> wf<span class="token punctuation">,</span> action<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkImplicitFinish</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WorkflowException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="createnewcurrentstep方法"><a href="#createnewcurrentstep方法" class="header-anchor">#</a> createNewCurrentStep方法</h4> <p>这个函数的主要目标是在工作流中创建一个新的当前步骤。以下是对这个函数的分段解释：</p> <ol><li><p>这个函数首先获取结果描述符中的下一个步骤。如果下一个步骤为-1，那么它将检查当前步骤是否存在。如果当前步骤存在，那么下一个步骤就是当前步骤的ID，否则，将抛出一个异常，因为请求的新的当前步骤与当前步骤相同，但是没有指定当前步骤。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> nextStep <span class="token operator">=</span> theResult<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>nextStep <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStep <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextStep <span class="token operator">=</span> currentStep<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StoreException</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal argument: requested new current step same as current step, but current step not specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>函数获取结果描述符中的所有者，并使用变量解析器将所有者中的变量翻译为实际的值。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> owner <span class="token operator">=</span> theResult<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">VariableResolver</span> variableResolver <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVariableResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> variableResolver<span class="token punctuation">.</span><span class="token function">translateVariables</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    owner <span class="token operator">=</span> <span class="token punctuation">(</span>o <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> o<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>函数获取结果描述符中的旧状态和新状态，并使用变量解析器将这些状态中的变量翻译为实际的值。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> oldStatus <span class="token operator">=</span> theResult<span class="token punctuation">.</span><span class="token function">getOldStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
oldStatus <span class="token operator">=</span> variableResolver<span class="token punctuation">.</span><span class="token function">translateVariables</span><span class="token punctuation">(</span>oldStatus<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> status <span class="token operator">=</span> theResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
status <span class="token operator">=</span> variableResolver<span class="token punctuation">.</span><span class="token function">translateVariables</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>如果当前步骤存在，那么函数将标记当前步骤为已完成，并将当前步骤移动到历史记录中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>currentStep <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store<span class="token punctuation">.</span><span class="token function">markFinished</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">,</span> actionId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldStatus<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    store<span class="token punctuation">.</span><span class="token function">moveToHistory</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>函数创建开始日期和可能的截止日期。如果结果描述符中的截止日期不为空，那么函数将使用变量解析器将截止日期中的变量翻译为实际的值。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Date</span> startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Date</span> dueDate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>theResult<span class="token punctuation">.</span><span class="token function">getDueDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>theResult<span class="token punctuation">.</span><span class="token function">getDueDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> dueDateObject <span class="token operator">=</span> variableResolver<span class="token punctuation">.</span><span class="token function">translateVariables</span><span class="token punctuation">(</span>theResult<span class="token punctuation">.</span><span class="token function">getDueDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...省略了一些代码...</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>函数在工作流存储中创建新的当前步骤，并将新步骤添加到transientVars映射中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Step</span> newStep <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">createCurrentStep</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nextStep<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> startDate<span class="token punctuation">,</span> dueDate<span class="token punctuation">,</span> status<span class="token punctuation">,</span> previousIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
transientVars<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;createdStep&quot;</span><span class="token punctuation">,</span> newStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>如果previousIds参数不为null并且长度为0，同时当前步骤为null，那么函数将创建一个包含新步骤的列表，并将这个列表添加到transientVars映射中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>previousIds <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>previousIds<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>currentStep <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span> currentSteps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentSteps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    transientVars<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;currentSteps&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span>currentSteps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>函数从transientVars映射中获取工作流描述符，并从描述符中获取下一个步骤的描述符。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">WorkflowDescriptor</span> descriptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WorkflowDescriptor</span><span class="token punctuation">)</span> transientVars<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;descriptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StepDescriptor</span> step <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>nextStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WorkflowException</span><span class="token punctuation">(</span><span class="token string">&quot;step #&quot;</span> <span class="token operator">+</span> nextStep <span class="token operator">+</span> <span class="token string">&quot; does not exist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>函数获取下一个步骤的描述符中的前置函数列表，并执行这些函数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span> preFunctions <span class="token operator">=</span> step<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> preFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>最后，函数返回新的当前步骤。如果在函数执行过程中发生了异常，那么函数将设置回滚标志，并抛出异常。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略.....</span>
		<span class="token keyword">return</span> newStep<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WorkflowException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <p>下面是完整函数代码：</p> <blockquote><p>路径：https://github.com/ailohq/osworkflow/blob/master/src/main/java/com/opensymphony/workflow/AbstractWorkflow.java#L1449</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Step</span> <span class="token function">createNewCurrentStep</span><span class="token punctuation">(</span><span class="token class-name">ResultDescriptor</span> theResult<span class="token punctuation">,</span> <span class="token class-name">WorkflowEntry</span> entry<span class="token punctuation">,</span> <span class="token class-name">WorkflowStore</span> store<span class="token punctuation">,</span> <span class="token keyword">int</span> actionId<span class="token punctuation">,</span> <span class="token class-name">Step</span> currentStep<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> previousIds<span class="token punctuation">,</span> <span class="token class-name">Map</span> transientVars<span class="token punctuation">,</span> <span class="token class-name">PropertySet</span> ps<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">WorkflowException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nextStep <span class="token operator">=</span> theResult<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextStep <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStep <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextStep <span class="token operator">=</span> currentStep<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StoreException</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal argument: requested new current step same as current step, but current step not specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Outcome: stepId=&quot;</span> <span class="token operator">+</span> nextStep <span class="token operator">+</span> <span class="token string">&quot;, status=&quot;</span> <span class="token operator">+</span> theResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, owner=&quot;</span> <span class="token operator">+</span> theResult<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, actionId=&quot;</span> <span class="token operator">+</span> actionId <span class="token operator">+</span> <span class="token string">&quot;, currentStep=&quot;</span>
                        <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>currentStep <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> currentStep<span class="token punctuation">.</span><span class="token function">getStepId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>previousIds <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                previousIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> owner <span class="token operator">=</span> theResult<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">VariableResolver</span> variableResolver <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVariableResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Object</span> o <span class="token operator">=</span> variableResolver<span class="token punctuation">.</span><span class="token function">translateVariables</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                owner <span class="token operator">=</span> <span class="token punctuation">(</span>o <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> o<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> oldStatus <span class="token operator">=</span> theResult<span class="token punctuation">.</span><span class="token function">getOldStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            oldStatus <span class="token operator">=</span> variableResolver<span class="token punctuation">.</span><span class="token function">translateVariables</span><span class="token punctuation">(</span>oldStatus<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> status <span class="token operator">=</span> theResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> variableResolver<span class="token punctuation">.</span><span class="token function">translateVariables</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStep <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                store<span class="token punctuation">.</span><span class="token function">markFinished</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">,</span> actionId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldStatus<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                store<span class="token punctuation">.</span><span class="token function">moveToHistory</span><span class="token punctuation">(</span>currentStep<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// store.moveToHistory(actionId, new Date(), currentStep,</span>
                <span class="token comment">// oldStatus, context.getCaller());</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// construct the start date and optional due date</span>
            <span class="token class-name">Date</span> startDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Date</span> dueDate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>theResult<span class="token punctuation">.</span><span class="token function">getDueDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>theResult<span class="token punctuation">.</span><span class="token function">getDueDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Object</span> dueDateObject <span class="token operator">=</span> variableResolver<span class="token punctuation">.</span><span class="token function">translateVariables</span><span class="token punctuation">(</span>theResult<span class="token punctuation">.</span><span class="token function">getDueDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dueDateObject <span class="token keyword">instanceof</span> <span class="token class-name">Date</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dueDate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Date</span><span class="token punctuation">)</span> dueDateObject<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dueDateObject <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        offset <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> dueDateObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        dueDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>startDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dueDateObject <span class="token keyword">instanceof</span> <span class="token class-name">Number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Number</span> num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Number</span><span class="token punctuation">)</span> dueDateObject<span class="token punctuation">;</span>
                    <span class="token keyword">long</span> offset <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        dueDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>startDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Step</span> newStep <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">createCurrentStep</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nextStep<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> startDate<span class="token punctuation">,</span> dueDate<span class="token punctuation">,</span> status<span class="token punctuation">,</span> previousIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            transientVars<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;createdStep&quot;</span><span class="token punctuation">,</span> newStep<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>previousIds <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>previousIds<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>currentStep <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// At this point, it must be a brand new workflow, so we'll</span>
                <span class="token comment">// overwrite the empty currentSteps</span>
                <span class="token comment">// with an array of just this current step</span>
                <span class="token class-name">List</span> currentSteps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentSteps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newStep<span class="token punctuation">)</span><span class="token punctuation">;</span>
                transientVars<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;currentSteps&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span>currentSteps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">WorkflowDescriptor</span> descriptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WorkflowDescriptor</span><span class="token punctuation">)</span> transientVars<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;descriptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StepDescriptor</span> step <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">getStep</span><span class="token punctuation">(</span>nextStep<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WorkflowException</span><span class="token punctuation">(</span><span class="token string">&quot;step #&quot;</span> <span class="token operator">+</span> nextStep <span class="token operator">+</span> <span class="token string">&quot; does not exist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">List</span> preFunctions <span class="token operator">=</span> step<span class="token punctuation">.</span><span class="token function">getPreFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iterator <span class="token operator">=</span> preFunctions<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FunctionDescriptor</span> function <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FunctionDescriptor</span><span class="token punctuation">)</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">executeFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> transientVars<span class="token punctuation">,</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> newStep<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WorkflowException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="/assets/img/wechat.50adb4d4.png" style="zoom:15%;"></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">9/12/2024, 11:20:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/4.2.3-FSM调度算法原理与实践.html" class="prev">
        4.2.3 FSM调度算法原理与实践
      </a></span> <span class="next"><a href="/4.2.5-Petri网调度算法原理与实践.html">
        4.2.5 Petri网调度算法原理与实践
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b8820ad2.js" defer></script><script src="/assets/js/2.a6c4a04f.js" defer></script><script src="/assets/js/1.04b49174.js" defer></script><script src="/assets/js/52.3b23c6f4.js" defer></script>
  </body>
</html>
