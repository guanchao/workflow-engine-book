<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>流程引擎原理与实践</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?925c3dadc75643902ba1d4bef48fa406";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
        </script></script>
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="国内首本从工程角度系统性介绍流程引擎的技术体系">
    <meta name="baidu-site-verification" content="codeva-c7FETTq8fo">
    <meta name="keywords" content="开源电子书，工作流技术体系，流程引擎技术体系，工作流，流程引擎，事件驱动机制，权限系统设计，云原生工作流，Crontab工作流，工作流系统架构，流程建模，DAG，FSM，WFMC，BPMN，BPM，Airflow，OsWorkflow，Petri">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.b8820ad2.js" as="script"><link rel="preload" href="/assets/js/2.a6c4a04f.js" as="script"><link rel="preload" href="/assets/js/1.04b49174.js" as="script"><link rel="preload" href="/assets/js/21.94815126.js" as="script"><link rel="prefetch" href="/assets/js/10.01c85a43.js"><link rel="prefetch" href="/assets/js/11.36ba8367.js"><link rel="prefetch" href="/assets/js/12.49270403.js"><link rel="prefetch" href="/assets/js/13.9964bf6f.js"><link rel="prefetch" href="/assets/js/14.1ffdb2cc.js"><link rel="prefetch" href="/assets/js/15.3ec6e020.js"><link rel="prefetch" href="/assets/js/16.223f06e4.js"><link rel="prefetch" href="/assets/js/17.49a0611a.js"><link rel="prefetch" href="/assets/js/18.5e539e58.js"><link rel="prefetch" href="/assets/js/19.08beb14f.js"><link rel="prefetch" href="/assets/js/20.2fd50ddb.js"><link rel="prefetch" href="/assets/js/22.7335372f.js"><link rel="prefetch" href="/assets/js/23.efd43c2e.js"><link rel="prefetch" href="/assets/js/24.33511251.js"><link rel="prefetch" href="/assets/js/25.9103752e.js"><link rel="prefetch" href="/assets/js/26.be3c6fce.js"><link rel="prefetch" href="/assets/js/27.a66d9ab9.js"><link rel="prefetch" href="/assets/js/28.db24d1a7.js"><link rel="prefetch" href="/assets/js/29.e639cc41.js"><link rel="prefetch" href="/assets/js/3.8ee85a39.js"><link rel="prefetch" href="/assets/js/30.9f96cad1.js"><link rel="prefetch" href="/assets/js/31.76245b5d.js"><link rel="prefetch" href="/assets/js/32.01a0bbd7.js"><link rel="prefetch" href="/assets/js/33.6cb05ad6.js"><link rel="prefetch" href="/assets/js/34.370a24a6.js"><link rel="prefetch" href="/assets/js/35.83692dfe.js"><link rel="prefetch" href="/assets/js/36.c783d15a.js"><link rel="prefetch" href="/assets/js/37.ac210fe0.js"><link rel="prefetch" href="/assets/js/38.07dc64eb.js"><link rel="prefetch" href="/assets/js/39.4ef28dca.js"><link rel="prefetch" href="/assets/js/4.9d17ba4d.js"><link rel="prefetch" href="/assets/js/40.a8fcb556.js"><link rel="prefetch" href="/assets/js/41.98d7d1f0.js"><link rel="prefetch" href="/assets/js/42.e31dd182.js"><link rel="prefetch" href="/assets/js/43.822702b0.js"><link rel="prefetch" href="/assets/js/44.50c68594.js"><link rel="prefetch" href="/assets/js/45.4e32699e.js"><link rel="prefetch" href="/assets/js/46.09f04e77.js"><link rel="prefetch" href="/assets/js/47.35c13096.js"><link rel="prefetch" href="/assets/js/48.99dfb60f.js"><link rel="prefetch" href="/assets/js/49.e1984c48.js"><link rel="prefetch" href="/assets/js/5.5682b71e.js"><link rel="prefetch" href="/assets/js/50.4242e15e.js"><link rel="prefetch" href="/assets/js/51.bdee7514.js"><link rel="prefetch" href="/assets/js/52.3b23c6f4.js"><link rel="prefetch" href="/assets/js/53.b6798440.js"><link rel="prefetch" href="/assets/js/54.ac356f09.js"><link rel="prefetch" href="/assets/js/55.79840f1c.js"><link rel="prefetch" href="/assets/js/56.343306c2.js"><link rel="prefetch" href="/assets/js/57.90f7511a.js"><link rel="prefetch" href="/assets/js/58.59457ff7.js"><link rel="prefetch" href="/assets/js/59.a05e2b0c.js"><link rel="prefetch" href="/assets/js/6.6aa986f5.js"><link rel="prefetch" href="/assets/js/60.7d6e698d.js"><link rel="prefetch" href="/assets/js/61.d1952570.js"><link rel="prefetch" href="/assets/js/62.a15b1cb5.js"><link rel="prefetch" href="/assets/js/63.69030ee5.js"><link rel="prefetch" href="/assets/js/64.a60b63a8.js"><link rel="prefetch" href="/assets/js/65.c1986cb9.js"><link rel="prefetch" href="/assets/js/66.e5747c76.js"><link rel="prefetch" href="/assets/js/67.c7de5e6a.js"><link rel="prefetch" href="/assets/js/68.96f4e3c6.js"><link rel="prefetch" href="/assets/js/69.db66370e.js"><link rel="prefetch" href="/assets/js/7.1fb8aaeb.js"><link rel="prefetch" href="/assets/js/70.8962d544.js"><link rel="prefetch" href="/assets/js/71.695bacdf.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.7bd035a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.png" alt="流程引擎原理与实践" class="logo"> <span class="site-name can-hide">流程引擎原理与实践</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/1-引言.html" class="nav-link">
  1 引言
</a></li><li class="dropdown-item"><!----> <a href="/2-概念.html" class="nav-link">
  2 概念
</a></li><li class="dropdown-item"><!----> <a href="/3-流程建模和解析.html" class="nav-link">
  3 流程建模和解析
</a></li><li class="dropdown-item"><!----> <a href="/4-流程引擎的核心组件.html" class="nav-link">
  4 流程引擎的核心组件
</a></li><li class="dropdown-item"><!----> <a href="/5-事件驱动机制.html" class="nav-link">
  5 事件驱动机制
</a></li><li class="dropdown-item"><!----> <a href="/6-核心表结构与接口设计.html" class="nav-link">
  6 核心表结构与接口设计
</a></li><li class="dropdown-item"><!----> <a href="/7-权限系统设计.html" class="nav-link">
  7 权限系统设计
</a></li><li class="dropdown-item"><!----> <a href="/8-分布式Crontab任务调度.html" class="nav-link">
  8 分布式Crontab任务调度
</a></li><li class="dropdown-item"><!----> <a href="/9-流程分析.html" class="nav-link">
  9 流程分析
</a></li><li class="dropdown-item"><!----> <a href="/10-云原生工作流.html" class="nav-link">
  10 云原生工作流
</a></li><li class="dropdown-item"><!----> <a href="/11-多引擎分布式系统实现.html" class="nav-link">
  11 多引擎分布式系统实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="帮助" class="dropdown-title"><span class="title">帮助</span> <span class="arrow down"></span></button> <button type="button" aria-label="帮助" class="mobile-dropdown-title"><span class="title">帮助</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about.html" class="nav-link">
  关于
</a></li><li class="dropdown-item"><!----> <a href="/sponsor.html" class="nav-link">
  打赏赞助
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/guanchao/workflow-engine-book" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/1-引言.html" class="nav-link">
  1 引言
</a></li><li class="dropdown-item"><!----> <a href="/2-概念.html" class="nav-link">
  2 概念
</a></li><li class="dropdown-item"><!----> <a href="/3-流程建模和解析.html" class="nav-link">
  3 流程建模和解析
</a></li><li class="dropdown-item"><!----> <a href="/4-流程引擎的核心组件.html" class="nav-link">
  4 流程引擎的核心组件
</a></li><li class="dropdown-item"><!----> <a href="/5-事件驱动机制.html" class="nav-link">
  5 事件驱动机制
</a></li><li class="dropdown-item"><!----> <a href="/6-核心表结构与接口设计.html" class="nav-link">
  6 核心表结构与接口设计
</a></li><li class="dropdown-item"><!----> <a href="/7-权限系统设计.html" class="nav-link">
  7 权限系统设计
</a></li><li class="dropdown-item"><!----> <a href="/8-分布式Crontab任务调度.html" class="nav-link">
  8 分布式Crontab任务调度
</a></li><li class="dropdown-item"><!----> <a href="/9-流程分析.html" class="nav-link">
  9 流程分析
</a></li><li class="dropdown-item"><!----> <a href="/10-云原生工作流.html" class="nav-link">
  10 云原生工作流
</a></li><li class="dropdown-item"><!----> <a href="/11-多引擎分布式系统实现.html" class="nav-link">
  11 多引擎分布式系统实现
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="帮助" class="dropdown-title"><span class="title">帮助</span> <span class="arrow down"></span></button> <button type="button" aria-label="帮助" class="mobile-dropdown-title"><span class="title">帮助</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about.html" class="nav-link">
  关于
</a></li><li class="dropdown-item"><!----> <a href="/sponsor.html" class="nav-link">
  打赏赞助
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/guanchao/workflow-engine-book" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第一部份：流程引擎基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>第二部份：流程引擎实现</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>4 流程引擎的核心组件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/4.1-WFMC工作流参考模型.html" class="sidebar-link">4.1 WFMC工作流参考模型</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>4.2 任务调度机制</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/4.3-工作流模式-控制流模式.html" class="sidebar-link">4.3 工作流模式-控制流模式</a></li><li><a href="/4.4-资源调度机制-资源模式.html" class="sidebar-link">4.4 资源调度机制-资源模式</a></li><li><a href="/4.5-数据管理机制-数据模式.html" class="sidebar-link">4.5 数据管理机制-数据模式</a></li><li><a href="/4.6-异常处理机制-异常处理模式.html" class="sidebar-link">4.6 异常处理机制-异常处理模式</a></li><li><a href="/4.7-引擎执行模式.html" class="sidebar-link">4.7 引擎执行模式</a></li></ul></section></li><li><a href="/5-事件驱动机制.html" class="sidebar-link">5 事件驱动机制</a></li><li><a href="/6-核心表结构与接口设计.html" class="sidebar-link">6 核心表结构与接口设计</a></li><li><a href="/7-权限系统设计.html" class="active sidebar-link">7 权限系统设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#acl权限模型" class="sidebar-link">ACL权限模型</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#rbac权限模型" class="sidebar-link">RBAC权限模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#rbac的基本组成" class="sidebar-link">RBAC的基本组成</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#rbac的四个层次" class="sidebar-link">RBAC的四个层次</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#案例改进" class="sidebar-link">案例改进</a></li></ul></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#abac权限模型" class="sidebar-link">ABAC权限模型</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#perm元模型" class="sidebar-link">PERM元模型</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#casbin框架应用实践" class="sidebar-link">Casbin框架应用实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#casbin的acl实现" class="sidebar-link">Casbin的ACL实现</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#casbin的rbac实现" class="sidebar-link">Casbin的RBAC实现</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#casbin的abac实现" class="sidebar-link">Casbin的ABAC实现</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#casbin综合实践" class="sidebar-link">Casbin综合实践</a></li><li class="sidebar-sub-header"><a href="/7-权限系统设计.html#参考" class="sidebar-link">参考</a></li></ul></li></ul></li><li><a href="/8-分布式Crontab任务调度.html" class="sidebar-link">8 分布式Crontab任务调度</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第三部份：流程引擎进阶</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>权限系统，例如：ACL[1], RBAC[2], ABAC[3]等，它们本质上，都是在解决**谁（Subject）可以对什么资源（Object）进行什么操作（Action）**这个问题。</p> <h2 id="acl权限模型"><a href="#acl权限模型" class="header-anchor">#</a> ACL权限模型</h2> <p>Access Control List（ACL，访问控制列表）是一种常见的权限管理技术，它用于定义谁可以访问特定资源以及可以执行的操作。ACL通常用于文件系统、数据库、网络设备等环境中，用于控制对资源的访问。</p> <p>一个ACL是一个列表，其中每一项都包含一个主体（如用户或用户组）和一组权限。主体可以是单个用户、用户组或者所有用户（通常表示为“所有人”或“公共”）。<strong>权限则定义了主体可以对资源执行的操作</strong>，如读取、写入、执行等。</p> <p>例如在API设计时应用ACL模型，权限可以这样设计：</p> <table><thead><tr><th>用户（Subject）</th> <th>操作（Action）</th> <th>资源（Object）</th></tr></thead> <tbody><tr><td>Alice</td> <td>GET</td> <td>/article</td></tr> <tr><td>Alice</td> <td>PUT</td> <td>/article</td></tr> <tr><td>Bob</td> <td>GET</td> <td>/article</td></tr> <tr><td>Bob</td> <td>DELETE</td> <td>/article</td></tr></tbody></table> <p>上面的ACL策略表示Alice可以去访问和修改文章，Bob可以访问和删除文章，其他人则没有任何权限。</p> <p>同样，在Linux系统中，文件的访问权限基于ACL（Access Control List，访问控制列表）设计。</p> <p>Linux文件系统中的每个文件或目录都有一个关联的ACL，用于定义三类主体对文件的访问权限：文件所有者(user)、文件所属的用户组(group)以及其他用户(other)。每一类主体可以拥有读（r）、写（w）和执行（x）三种权限。</p> <p>Linux文件的ACL通常表示为一个由10个字符组成的字符串，如“-rw-r--r--”。这个字符串从左到右分为四部分：</p> <ol><li>第一个字符表示文件类型：'-'表示普通文件，'d'表示目录，'l'表示符号链接等。</li> <li>接下来的三个字符表示文件所有者的权限：'r'表示可读，'w'表示可写，'x'表示可执行。没有某个权限的话，对应的位置会被标为'-'。</li> <li>再接下来的三个字符表示文件所属用户组的权限，同样用'r'、'w'和'x'表示。</li> <li>最后三个字符表示其他用户的权限，也是用'r'、'w'和'x'表示。</li></ol> <p>例如，下面的resource_2文件ACL字符串为“-rw-r-----”，表示：</p> <ol><li>这是一个普通文件（-）。</li> <li>文件所有者具有读（r）和写（w）权限。</li> <li>文件所属的用户组具有读（r）权限。</li> <li>其他用户没有任何权限。</li></ol> <div class="language-cmd extra-class"><pre class="language-text"><code>[root@VM-32-12-tencentos test]# ll
total 4
drwxr-xr-x 2 root root 4096 Dec  9 12:59 resource_1
-rw-r----- 1 root root    0 Dec  9 12:59 resource_2
</code></pre></div><p>在Linux系统中，可以使用<code>chmod</code>命令修改文件的ACL。例如，要将一个文件的权限设置为所有者可读写，用户组和其他用户只可读，可以执行以下命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">chmod</span> <span class="token number">644</span> filename
</code></pre></div><p>此外，Linux还支持扩展的ACL（Extended Access Control List），它允许为特定用户或用户组分配更细粒度的权限。扩展ACL可以使用<code>getfacl</code>和<code>setfacl</code>命令进行查询和设置。例如，要为用户Alice添加对文件的读写权限，可以执行以下命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>setfacl <span class="token parameter variable">-m</span> u:alice:rw resource_2
</code></pre></div><p>通过getfacl可以查看到设置的ACL策略：</p> <div class="language-cmd extra-class"><pre class="language-text"><code>[root@VM-32-12-tencentos test]# getfacl resource_2
# file: resource_2
# owner: root
# group: root
user::rw-
user:alice:rw-
group::r--
mask::rw-
other::---
</code></pre></div><p>从上面的举例，可以看到ACL提供了一种灵活的权限管理机制，可以支持各种复杂的访问控制需求。</p> <p>然而，管理大量的ACL可能会变得复杂，特别是在大型系统中。像前面API接口设计使用ACL模型，那么意味着后续每来一个新客户都需要添加对应的策略，随着新用户的增多，这个ACL策略表也会变得越来越大很难维护。</p> <p>因此，许多系统还提供了角色或属性等其他机制，以简化权限管理和提高安全性。</p> <h2 id="rbac权限模型"><a href="#rbac权限模型" class="header-anchor">#</a> RBAC权限模型</h2> <h3 id="rbac的基本组成"><a href="#rbac的基本组成" class="header-anchor">#</a> RBAC的基本组成</h3> <p>尽管ACL提供了一种灵活的权限管理机制，但在实际应用中，它也存在一些问题，例如：</p> <ol><li>管理复杂性：当系统中的资源和用户数量较大时，管理大量的ACL可能变得非常复杂。为每个文件或资源分配权限可能会导致管理负担加重，尤其是当需要修改或更新权限时。</li> <li>难以追踪和审计：由于权限是分散在各个资源的ACL中的，追踪和审计用户的访问权限可能变得困难。例如，要查找具有特定权限的所有用户，可能需要检查所有资源的ACL。</li> <li>权限维护困难：当用户的角色或职责发生变化时，可能需要修改多个ACL以更新用户的权限。这不仅耗时，而且容易出错。</li> <li>缺乏抽象和封装：ACL直接将权限分配给用户或用户组，缺乏对权限的抽象和封装。这可能导致权限管理变得繁琐和低效。</li></ol> <p>RBAC（Role-Based Access Control，基于角色的访问控制）模型通过引入角色的概念来解决这些问题，使得权限管理更加简单、高效和可维护。在RBAC模型中，权限不再直接分配给用户，而是分配给角色。用户根据需要分配一个或多个角色，从而间接获得角色所包含的权限。</p> <img src="/assets/img/7-rbac-demo.b797731b.jpg" style="zoom:67%;"> <p>以下是RBAC模型的关键组成部分：</p> <ol><li>用户（Users）：用户是系统中的实体，如人员、服务或应用程序。用户需要访问系统资源以完成特定任务。</li> <li>角色（Roles）：角色是一组相关权限的集合，通常与特定职责或职位相对应。例如，管理员、普通用户和访客等。角色应该具有明确的职责和权限范围，遵循最小权限原则，即只分配角色所需的最小权限。</li> <li>权限（Permissions）：权限是对资源的访问或操作的授权。例如，对文件的读、写和删除权限。在RBAC模型中，权限分配给角色，而不是直接分配给用户。</li> <li>资源（Resources）：资源是系统中需要受到保护的对象，如文件、数据库表、服务等。资源可以根据需要分配给角色，以控制用户对资源的访问和操作。</li></ol> <blockquote><p>RBAC的优点</p></blockquote> <p>通过以上步骤，可以实现基于RBAC模型的权限设计，这个模型可以弥补前面ACL模型的各种缺陷，具体来说就是有以下这些优势：</p> <ol><li>简化管理：通过将权限分配给角色而非直接分配给用户，RBAC模型简化了权限管理。管理员只需要管理角色和用户与角色之间的关系，而不是为每个用户分配权限。</li> <li>更易于追踪和审计：在RBAC模型中，权限集中在角色中，更容易追踪和审计用户的访问权限。例如，要查找具有特定权限的所有用户，只需检查与该权限相关的角色，然后查找分配了这些角色的用户。</li> <li>权限维护更简单：当用户的角色或职责发生变化时，只需修改用户的角色分配，而无需逐个修改资源的ACL。这使得权限维护更加简单和高效。</li> <li>权限抽象和封装：RBAC模型通过角色对权限进行抽象和封装，使得权限管理更加模块化和结构化。这有助于提高权限管理的可维护性和可扩展性。</li></ol> <img src="/assets/img/7 rbac-1.05a3f24e.png" alt="image-20231209164208685" style="zoom:50%;"> <p>如上图所示，一个基于RBAC的权限系统可以分成如下三大块进行管理：</p> <h4 id="权限管理"><a href="#权限管理" class="header-anchor">#</a> 权限管理</h4> <p>前面，我们说了权限管理本质上都是在解决**谁（Subject）可以对什么资源（Object）进行什么操作（Action）**这个问题。</p> <p>资源对应的就是限制用户能访问的数据范围，操作就是限制用户能对这些资源做哪些行为。</p> <p>这两个都是在后台做的一个权限限制，前端用户只能通过错误提示来得知。但在实际设计权限管理系统时，为了更好的用户体验，我们还会加多一个前端的权限控制，包括：菜单、页面、按钮的控制显示，如果没有对应权限就不显示相应的菜单、页面和按钮。没有权限的的操作，前端就直接不可见，这样用户体验上会更好。</p> <p>所以，一个权限管理分别从如下方面来做限制：</p> <img src="/assets/img/7 权限管理.a9c4e13c.png" alt="image-20231209162126111" style="zoom:50%;"> <p>前端权限在实际实现时，一般通过控制菜单的可视范围来配置，比较少具体到页面和按钮这种细粒度的控制。</p> <p>例如下面某个系统，一般系统左侧是菜单栏，包含一级或二级菜单，而对应到角色权限配置页面上，则是对应把菜单的所有层级结构展示出来，然后供管理员进行配置。对应的菜单会关联API操作权限。</p> <p><img src="/assets/img/7 菜单按钮权限-1.c84976ae.png" alt="image-20240924224030782" style="zoom:33%;"> <img src="/assets/img/7 菜单控制设计-1.4f8dd374.png" alt="image-20231212091303140" style="zoom:33%;"></p> <p>所以在配置每个API的时候，还需要去整理关联每个API归属于哪个菜单，可以通过#号来区分层级。一般在设计接口路径时，每个路径的中间名称可以对应一个菜单，例如下面的/v1/work路径对应的Dashboard#工作台，/v1/index路径对应的是Dashboard#首页。这样API设计和菜单关联逻辑上保持一致，更容易后期整理维护。</p> <table><thead><tr><th>API权限</th> <th>菜单</th> <th></th></tr></thead> <tbody><tr><td>/v1/user/list</td> <td>用户管理</td> <td></td></tr> <tr><td>/v1/user/edit</td> <td>用户管理</td> <td></td></tr> <tr><td>/v1/index/index</td> <td>Dashboard#首页</td> <td></td></tr> <tr><td>/v1/work/overview</td> <td>Dashboard#工作台</td> <td></td></tr></tbody></table> <p>那么角色在关联菜单的时候，实际上就关联了对应的API接口操作权限。</p> <h4 id="角色管理"><a href="#角色管理" class="header-anchor">#</a> 角色管理</h4> <p>在RBAC（Role-Based Access Control，基于角色的访问控制）模型中，角色管理是一个关键的组成部分。角色管理主要涉及角色的创建、分配、修改和删除等操作。以下是RBAC模型中角色管理的主要步骤：</p> <ol><li>角色定义：首先，需要定义系统中的角色。角色通常对应于组织中的职位或职责，如“管理员”、“编辑”、“访客”等。每个角色都应该有一个明确的职责和权限范围。</li> <li>权限分配：为每个角色分配一组相应的权限。权限通常是对系统资源的访问或操作的授权，如“读”、“写”、“删除”等。</li> <li>用户与角色关联：将用户分配到一个或多个角色。用户通过角色获得访问系统资源的权限。</li> <li>角色修改和删除：当组织或业务需求发生变化时，可能需要修改或删除角色。例如，当一个角色的职责发生变化时，可能需要修改该角色的权限；当一个角色不再需要时，可以删除该角色。</li></ol> <p>在实际应用中，角色管理通常需要配合用户管理和权限管理一起使用。例如，当新用户加入系统时，需要为其分配适当的角色；当系统资源或权限策略发生变化时，可能需要更新角色的权限。</p> <p>在进行角色管理时，需要采取如下的安全原则进行合理设计来提高系统安全性：</p> <ul><li>最小权限原则：RBAC可以将角色配置成其完成任务所需的最小的权限集合</li> <li>责任分离原则：可以通过调用相互独立互斥的角色共同完成敏感的任务，例如要求一个记账员和财务管理员共同参与统一过账操作</li> <li>数据抽象原则：可以通过权限的抽象来体现，例如财务操作用借款、存款等抽象权限，而不是使用典型的读、写等执行权限</li></ul> <h4 id="用户管理"><a href="#用户管理" class="header-anchor">#</a> 用户管理</h4> <p>用户管理主要做两方面工作流：</p> <ul><li>确定用户在哪个组织</li> <li>确定用户在这个组织里有哪些权限（即绑定什么角色）</li></ul> <img src="/assets/img/7 rbac-组织架构.cbbd4a03.png" alt="image-20240924231159840" style="zoom:50%;"> <h3 id="rbac的四个层次"><a href="#rbac的四个层次" class="header-anchor">#</a> RBAC的四个层次</h3> <p>在RBAC模型中，为了更好地描述和理解不同程度的角色管理和访问控制，研究者将RBAC模型分为四个层次：RBAC0、RBAC1、RBAC2和RBAC3。这些层次从简单到复杂，逐步增加了角色管理和访问控制的功能。</p> <h4 id="rbac0"><a href="#rbac0" class="header-anchor">#</a> RBAC0</h4> <ol><li>RBAC0：RBAC0是RBAC模型的最基本层次，它包括用户（User）、角色（Role）和权限（Permission）三个基本元素。在RBAC0中，用户通过分配角色来获得权限。RBAC0模型关注于将权限分配给角色，以及将角色分配给用户。它不涉及角色之间的关系，也不包括角色继承。这种在大部分系统上是最常见的设计，可以满足绝大部分系统的权限模块设计需求。</li></ol> <img src="/assets/img/7 rbac0.dc97268f.png" alt="image-20231211124757655" style="zoom:67%;"> <h4 id="rbac1"><a href="#rbac1" class="header-anchor">#</a> RBAC1</h4> <p>RBAC1：<strong>RBAC1在RBAC0的基础上引入了角色继承（Role Hierarchy）机制</strong>。角色继承允许一个角色继承另一个角色的权限。这种层次化的角色结构有助于简化权限管理，使权限分配更加结构化和模块化。</p> <p>角色继承的主要特点如下：</p> <ol><li>层次化：角色继承允许创建具有层次结构的角色。在这种结构中，一个角色可以继承一个或多个父角色的所有权限。这有助于组织和管理角色，使权限分配更加结构化和模块化。</li> <li>权限累积：当一个角色继承另一个角色时，它将自动获得被继承角色的所有权限。这意味着在分配权限时，只需为每个角色分配特定的权限，而无需重复分配共享的权限。</li> <li>灵活性：角色继承提供了一种灵活的方式来管理和分配权限。当需要调整权限时，只需修改角色继承关系，而无需逐个修改用户的权限。这使得权限管理更加灵活和高效。</li></ol> <img src="/assets/img/7 rbac1.9d034d4e.png" alt="image-20231211124833928" style="zoom:67%;"> <p>举个例子，假设我们有以下角色：</p> <ul><li>一般员工（Employee）</li> <li>经理（Manager）</li> <li>系统管理员（System Administrator）</li></ul> <p>在这个例子中，我们可以使用角色继承来实现以下权限分配：</p> <ul><li>一般员工（Employee）具有基本的访问权限，如查看文件、发送电子邮件等。</li> <li>经理（Manager）继承一般员工（Employee）的所有权限，并具有额外的权限，如审批报告、管理项目等。</li> <li>系统管理员（System Administrator）继承经理（Manager）的所有权限，并具有额外的权限，如管理用户、配置系统等。</li></ul> <h4 id="rbac2"><a href="#rbac2" class="header-anchor">#</a> RBAC2</h4> <p>RBAC2：<strong>RBAC2在RBAC1的基础上引入了约束（Constraint）机制</strong>。约束用于限制用户与角色、角色与权限之间的关联，以增强访问控制的安全性和灵活性。约束可以是静态的（例如，一个用户最多可以分配两个角色），也可以是动态的（例如，一个用户不能同时拥有某两个互斥的角色）。</p> <img src="/assets/img/7 rbac2.4f9a51ce.png" alt="image-20231211124855265" style="zoom:67%;"> <p>约束可以分为静态约束和动态约束，以下是一些常见的RBAC2约束类型及示例：</p> <ol><li><p>互斥角色（Mutually Exclusive Roles）：互斥角色约束要求一个用户不能同时拥有某些特定的角色。这可以防止潜在的冲突或滥用权限。例如，在一个银行系统中，一个用户可能不能同时拥有“出纳员”和“审计员”的角色，以防止内部欺诈。</p></li> <li><p>基数约束（Cardinality Constraint）：基数约束限制了分配给用户的角色数量或分配给角色的权限数量。这有助于遵循最小权限原则，降低潜在的安全风险。例如，一个用户最多可以分配两个角色；或者一个角色最多可以拥有五个权限。</p></li> <li><p>权责分离约束（Separation of Duties，SoD）：权责分离约束要求将潜在冲突的任务分配给不同的角色。这有助于防止滥用权限和内部欺诈。例如，在一个采购系统中，“采购申请者”和“采购审批者”应该是两个独立的角色，以确保采购过程的透明和公正。</p></li> <li><p>前置角色约束（Prrequisite Roles Constraint）：只有当用户已是角色 B 的成员时，才能将其分配给角色 A。例如要经历过主管的角色之后，才能晋级总监角色。</p></li></ol> <p>在实际应用中，可以根据具体的业务需求和安全策略来定义和实施RBAC2约束。这些约束可以通过编程逻辑或数据库规则等方式来实现。</p> <h4 id="rbac3"><a href="#rbac3" class="header-anchor">#</a> RBAC3</h4> <p><strong>RBAC3 = RBAC1+RBAC2，既有角色继承机制也有约束机制</strong>。</p> <img src="/assets/img/7 rbac3.ad4535aa.png" alt="image-20231211124918489" style="zoom:67%;"> <p>总之，RBAC0、RBAC1、RBAC2和RBAC3是RBAC模型的四个层次，它们从简单到复杂，逐步增加了角色管理和访问控制的功能。在实际应用中，可以根据具体的业务需求和场景来选择合适的RBAC层次，对于大部分中小系统来说，RBAC0是够用的了。</p> <h3 id="案例改进"><a href="#案例改进" class="header-anchor">#</a> 案例改进</h3> <p>例如前面ACL的例子改成RBAC的模型实现，可以这样设计：</p> <p>首先是设计角色关联的权限：</p> <table><thead><tr><th>角色（Role）</th> <th>操作（Action）</th> <th>资源（Object）</th></tr></thead> <tbody><tr><td>Editor</td> <td>GET</td> <td>/article</td></tr> <tr><td>Editor</td> <td>PUT</td> <td>/article</td></tr> <tr><td>Editor</td> <td>DELETE</td> <td>/article</td></tr> <tr><td>Viewer</td> <td>GET</td> <td>/article</td></tr></tbody></table> <p>然后是关联角色和用户：</p> <table><thead><tr><th>用户（Subject）</th> <th>角色（Role）</th></tr></thead> <tbody><tr><td>Alice</td> <td>Editor</td></tr> <tr><td>Bob</td> <td>Viewer</td></tr></tbody></table> <p>这样Alice就拥有Editor这个角色的所有权限，而Editor角色可以实现对文章的读取、更改和删除，而Bob是Viewer角色，则只能查看文章。</p> <h2 id="abac权限模型"><a href="#abac权限模型" class="header-anchor">#</a> ABAC权限模型</h2> <p>尽管RBAC（Role-Based Access Control，基于角色的访问控制）模型相对于ACL模型简化了权限管理，提高了安全性和可维护性，但它也存在一些缺点或局限性：</p> <ol><li>静态角色：RBAC模型中的角色通常是预先定义好的，这可能导致在面对复杂和动态的访问控制需求时，灵活性较低。例如，如果需要根据时间、地点或其他上下文信息来控制访问权限，RBAC模型可能难以满足需求。</li> <li>角色爆炸：在某些场景下，为了满足细粒度的访问控制需求，可能需要创建大量的角色，这会导致角色管理变得复杂，也称为“角色爆炸”。</li> <li>缺乏属性支持：RBAC模型主要依赖于角色来控制访问权限，而不支持基于用户、资源或环境等属性的访问控制。这可能导致在需要支持基于属性的访问控制的场景中，RBAC模型难以满足需求。</li></ol> <p>ABAC（Attribute-Based Access Control，基于属性的访问控制）模型正是为了解决这些问题而提出的。<strong>ABAC模型允许基于用户、资源、操作和环境等多个属性来控制访问权限</strong>。这些属性可以是静态的（例如用户的部门、资源的类型）或动态的（例如当前时间、用户的位置）。</p> <p>ABAC模型通过引入属性和动态访问控制策略，解决了RBAC模型在复杂和动态访问控制场景中的缺点和局限性，使得权限管理更加灵活和高效。然而，实现ABAC模型可能相对复杂，需要对属性和策略进行管理和维护。</p> <h2 id="perm元模型"><a href="#perm元模型" class="header-anchor">#</a> PERM元模型</h2> <p>PERM（Policy, Effect, Request, Matchers）建模语言(PERM modeling language, 简称PML)，是一种用于访问控制的模型。模型中的每个元素都有其特定的含义和作用：</p> <img src="/assets/img/7 perm模型.3d74508a.png" alt="image-20231209121129052" style="zoom:50%;"> <ol><li><p>Request（请求）：请求是用户试图执行的操作，通常一个基础的请求是一个三元组，包括用户身份（subject）、目标资源（object）和操作类型（action）信息，即：<code>r = {sub, obj, act}</code>。例如，用户试图删除一个文件，这就构成了一个请求。</p></li> <li><p>Policy（策略）：策略是定义谁可以执行哪些操作，或者在哪些条件下可以访问哪些资源的规则，即：<code>p = {sub, obj, act}或p={sub, obj, act, eft}</code>。例如，策略可能会规定“管理员可以删除所有文件”，或者“只有在工作时间内，员工才能访问公司数据库”。</p></li> <li><p>Matchers（匹配器）：匹配器是用来比较请求（Request）和策略（Policy）的工具，如果请求和策略匹配，那么将执行策略定义的效果，匹配器可以是简单的比较操作，也可以是复杂的逻辑表达式。例如：<code>m = r.sub == p.sub &amp;&amp; r.action == p.action &amp;&amp; r.resource == p.resource</code>，这个简单的匹配规则表示，如果请求的参数<code>(subject, object, action)</code>能在策略中找到对应的匹配结果，则返回策略结果<code>p.eft</code>，其中策略结果保存在<code>p.eft</code>中。</p></li> <li><p>Effect（效果）：效果描述了当策略匹配请求时应该执行的操作，通常有两种效果：“允许”和“拒绝”。</p> <p>例如：<code>e = some(where(p.eft == allow))</code>，表示如果策略匹配结果理由有某些结果是“允许”，那么最终结果返回真。</p> <p>另一个例子：<code>e = some(where (p.eft == allow)) &amp;&amp; !some(where (p.eft == deny))</code>，这个组合的逻辑表示：如果有策略匹配结果为允许，且没有策略匹配结果是拒绝时，结果返回真。也就是说，当匹配的策略都是允许是，结果为真；如果有任何一个拒绝，则结果为假。</p></li></ol> <p>如下图，访问控制的过程通常是这样的：首先，用户发出一个请求，然后系统使用匹配器将请求与策略进行比较，如果请求匹配策略，那么将执行策略定义的效果（允许或拒绝）。</p> <img src="/assets/img/7-perm.f126f13b.png" style="zoom:80%;"> <p>PERM模型的优点是它非常灵活，可以支持各种复杂的访问控制需求。同时，它也支持动态的访问控制，因为策略和匹配器都可以根据需要进行修改。</p> <p>关于该模型的具体设计细节，可以参考原论文：<a href="https://arxiv.org/abs/1903.09756" target="_blank" rel="noopener noreferrer">PML: 基于解释器的Web服务访问控制策略语言<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://www.jos.org.cn/jos/article/abstract/5624" target="_blank" rel="noopener noreferrer">基于元模型的访问控制策略规范语言（中文）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="casbin框架应用实践"><a href="#casbin框架应用实践" class="header-anchor">#</a> Casbin框架应用实践</h2> <p>Casbin是一个强大的、高效的开源访问控制库，用于Golang、Java、Node.js、PHP等多种编程语言。它支持多种访问控制模型，如ACL（访问控制列表）、RBAC（基于角色的访问控制）和ABAC（基于属性的访问控制），可以帮助开发者轻松地实现对应用程序中资源的访问控制。</p> <p>前面介绍的是各个权限模型的原理，以及Casbin开源框架的理论基础：PERM元模型。接下来的内容，我们讲介绍和使用Casbin框架来实现前面的几种权限模型。</p> <p>下图是Casbin的原理说明：</p> <img src="/assets/img/7-casbin.e339c086.jpeg" alt="img" style="zoom:80%;"> <h3 id="casbin的acl实现"><a href="#casbin的acl实现" class="header-anchor">#</a> Casbin的ACL实现</h3> <p>如下是一个ACL模型的定义：</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token comment"># Request definition</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">request_definition</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">r</span> <span class="token punctuation">=</span> <span class="token value attr-value">sub, obj, act</span>

<span class="token comment"># Policy definition</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">policy_definition</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">p</span> <span class="token punctuation">=</span> <span class="token value attr-value">sub, obj, act</span>

<span class="token comment"># Policy effect</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">policy_effect</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">e</span> <span class="token punctuation">=</span> <span class="token value attr-value">some(where (p.eft == allow))</span>

<span class="token comment"># Matchers</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">matchers</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">m</span> <span class="token punctuation">=</span> <span class="token value attr-value">r.sub == p.sub &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</span>

</code></pre></div><ul><li><p><strong>request_definition</strong> 是系统的查询模板。例如，请求 alice, write, data1 可以解释为 &quot;主体 Alice 能否对对象'data1'执行'写'操作？</p></li> <li><p><strong>policy_definition</strong> 是系统的赋值模板。例如，通过创建 policy alice, write, data1，就等于为主体 Alice 分配了在对象 &quot;data1 &quot;上执行 &quot;写 &quot;操作的权限。</p></li> <li><p><strong>policy_effect</strong> 定义了策略的效果。</p></li> <li><p><strong>matchers</strong>使用 r.sub == p.sub &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act 条件将请求与策略进行匹配。</p></li></ul> <p>下面举例一个策略来检测这个ACL模型：</p> <div class="language- extra-class"><pre class="language-text"><code>p, alice, data1, read
p, bob, data2, write
</code></pre></div><p>这个策略表示：</p> <ul><li>alice可以读取data1</li> <li>bob可以编写data2</li></ul> <p>下图是ACL模型中policy和request的匹配过程：</p> <img src="/assets/img/7-casbin-acl.ebbe76f8.png" style="zoom:80%;"> <p>上面的例子，我们通过casbin的golang库实现如下：</p> <p>首先安装Casbin库：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>go get <span class="token parameter variable">-u</span> github.com/casbin/casbin/v2
</code></pre></div><p>接着，我们创建一个名为<code>main.go</code>的文件，用于实现ACL权限模型。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>

	<span class="token string">&quot;github.com/casbin/casbin/v2&quot;</span>
	<span class="token string">&quot;github.com/casbin/casbin/v2/model&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 初始化一个Casbin的Enforcer，这里我们直接使用字符串来定义模型</span>
	m<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> model<span class="token punctuation">.</span><span class="token function">NewModelFromString</span><span class="token punctuation">(</span><span class="token string">`
		[request_definition]
		r = sub, obj, act

		[policy_definition]
		p = sub, obj, act

		[policy_effect]
		e = some(where (p.eft == allow))

		[matchers]
		m = r.sub == p.sub &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act
	`</span><span class="token punctuation">)</span>

	enforcer<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>

	<span class="token comment">// 2. 添加策略</span>
	<span class="token comment">// 用户alice可以访问数据1的读操作</span>
	enforcer<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// 用户bob可以访问数据2的写操作</span>
	enforcer<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// 3. 检查访问权限</span>
	<span class="token comment">// 检查alice是否可以访问data1的读操作</span>
	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span><span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Alice can read data1: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>

	<span class="token comment">// 检查bob是否可以访问data2的写操作</span>
	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Bob can write data2: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>

	<span class="token comment">// 检查alice是否可以访问data2的写操作</span>
	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span><span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Alice can write data2: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个示例中，我们首先定义了一个简单的ACL模型，然后添加了两条策略：</p> <ul><li><p>alice可以访问data1的读操作</p></li> <li><p>bob可以访问data2的写操作。</p> <p>最后，我们检查了用户的访问权限。</p></li></ul> <p>运行这个程序，你将看到以下输出：</p> <div class="language- extra-class"><pre class="language-text"><code>Alice can read data1: true
Bob can write data2: true
Alice can write data2: false
</code></pre></div><h3 id="casbin的rbac实现"><a href="#casbin的rbac实现" class="header-anchor">#</a> Casbin的RBAC实现</h3> <p>Casbin 支持约束规则，这些规则用于在访问控制过程中对权限进行更细粒度的控制。约束规则的定义通常使用 <code>c</code> 标识符。</p> <p>在 Casbin 中，约束规则的定义为：</p> <div class="language- extra-class"><pre class="language-text"><code>[policy_definition]
c = _, _, constraint_name
</code></pre></div><p>其中，<code>constraint_name</code> 是约束的名称，代表对应的约束规则。现在，我来介绍一些常见的约束规则以及它们的示例：</p> <ol><li><strong>日期约束：</strong> 允许用户只在特定日期范围内访问某个资源。</li></ol> <div class="language- extra-class"><pre class="language-text"><code>[policy_definition]
c = _, _, date
</code></pre></div><p>在这个例子中，<code>date</code> 可以是资源可以访问的日期范围，例如 <code>2022-01-01 to 2022-12-31</code>。</p> <ol start="2"><li><strong>时间约束：</strong> 允许用户只在特定时间段内访问某个资源。</li></ol> <div class="language- extra-class"><pre class="language-text"><code>[policy_definition]
c = _, _, time
</code></pre></div><p>在这个例子中，<code>time</code> 可以是资源可以访问的时间范围，例如 <code>9:00 AM to 5:00 PM</code>。</p> <ol start="3"><li><strong>数量约束：</strong></li></ol> <div class="language- extra-class"><pre class="language-text"><code>[policy_definition]
c = _, _, max_operations
</code></pre></div><p>在这个例子中，<code>max_operations</code> 可以是用户对资源执行操作的最大次数，例如 <code>10</code>。</p> <ol start="4"><li><strong>自定义约束：</strong></li></ol> <p>允许用户定义自己的约束规则，例如根据用户属性、环境变量等条件限制访问。</p> <div class="language- extra-class"><pre class="language-text"><code>[policy_definition]
c = _, _, custom_constraint
</code></pre></div><p>在这个例子中，<code>custom_constraint</code> 是用户自定义的约束规则。</p> <p>当 Casbin 执行权限检查时，会根据加载的策略和匹配的请求条件，结合约束规则来判断是否允许访问。实际使用时，约束规则的定义和语义是根据业务需求而定的，用户可以根据具体情况定义和使用约束规则。</p> <p>我们设计一个简单的RBAC模型，如下：</p> <div class="language- extra-class"><pre class="language-text"><code>[request_definition]
r = sub, act, obj

[policy_definition]
p = sub, act, obj

[role_definition]
g = _, _
g2 = _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = r.sub == p.sub &amp;&amp; g(p.act, r.act) &amp;&amp; r.obj == p.obj
</code></pre></div><p>我们创建一个名为<code>main.go</code>的文件，用于实现RBAC权限模型。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>

	<span class="token string">&quot;github.com/casbin/casbin/v2&quot;</span>
	<span class="token string">&quot;github.com/casbin/casbin/v2/model&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 初始化一个Casbin的Enforcer，这里我们直接使用字符串来定义模型</span>
	m<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> model<span class="token punctuation">.</span><span class="token function">NewModelFromString</span><span class="token punctuation">(</span><span class="token string">`
		[request_definition]
		r = sub, obj, act

		[policy_definition]
		p = sub, obj, act

		[role_definition]
		g = _, _

		[policy_effect]
		e = some(where (p.eft == allow))

		[matchers]
		m = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act
	
	`</span><span class="token punctuation">)</span>

	enforcer<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>

	<span class="token comment">// 2.定义角色的策略</span>
	<span class="token comment">//admin角色可以访问data1的读写操作</span>
	enforcer<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
	enforcer<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// member角色只可以访问data2的读操作</span>
	enforcer<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;member&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// 3. 给用户添加角色</span>
	<span class="token comment">// 用户alice拥有admin角色</span>
	enforcer<span class="token punctuation">.</span><span class="token function">AddGroupingPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// 用户bob拥有member角色</span>
	enforcer<span class="token punctuation">.</span><span class="token function">AddGroupingPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;member&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// 4. 检查访问权限</span>
	<span class="token comment">// 检查alice是否可以访问data1的读操作</span>
	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span><span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Alice can read data1: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>

	<span class="token comment">// 检查alice是否可以访问data1的写操作</span>
	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span><span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Alice can write data1: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>

	<span class="token comment">// 检查bob是否可以访问data2的读操作</span>
	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Bob can read data2: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>

	<span class="token comment">// 检查bob是否可以访问data1的写操作</span>
	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Bob can write data1: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面是这个代码示例的解释：</p> <ol><li>首先，我们使用字符串定义了一个RBAC模型。在这个模型中，我们定义了请求（<code>r = sub, obj, act</code>），策略（<code>p = sub, obj, act</code>），角色的定义（<code>g = _, _</code>），策略效果（<code>e = some(where (p.eft == allow))</code>）和匹配表达式（<code>m = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</code>）。</li> <li>然后，我们初始化了一个Casbin的Enforcer。</li> <li>添加了角色和策略。我们将alice添加到admin角色，将bob添加到member角色。然后定义admin角色可以对data1进行读写操作，member角色只可以对data2进行读操作。</li> <li>使用<code>Enforce</code>方法检查用户的访问权限。在这个示例中，我们检查了alice和bob对data1和data2的读写权限。</li></ol> <p>运行这个程序，你将看到以下输出：</p> <div class="language- extra-class"><pre class="language-text"><code>Alice can read data1: true
Alice can write data1: true
Bob can read data2: true
Bob can write data1: false
</code></pre></div><h3 id="casbin的abac实现"><a href="#casbin的abac实现" class="header-anchor">#</a> Casbin的ABAC实现</h3> <p>我们创建一个名为<code>main.go</code>的文件，用于实现ABAC权限模型。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>

	<span class="token string">&quot;github.com/casbin/casbin/v2&quot;</span>
	<span class="token string">&quot;github.com/casbin/casbin/v2/model&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// User 定义用户属性</span>
<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span>
	Age  <span class="token builtin">int</span>
	Role <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// Resource 定义资源属性</span>
<span class="token keyword">type</span> Resource <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name     <span class="token builtin">string</span>
	Location <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义一个自定义的策略函数</span>
<span class="token keyword">func</span> <span class="token function">policyFunc</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	user <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">)</span>
	resource <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Resource<span class="token punctuation">)</span>
	action <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>

	<span class="token comment">// 如果用户角色是admin，或者用户角色是owner并且资源在USA，或者用户年龄大于18并且操作是read，则允许访问</span>
	<span class="token keyword">if</span> user<span class="token punctuation">.</span>Role <span class="token operator">==</span> <span class="token string">&quot;admin&quot;</span> <span class="token operator">||</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>Role <span class="token operator">==</span> <span class="token string">&quot;owner&quot;</span> <span class="token operator">&amp;&amp;</span> resource<span class="token punctuation">.</span>Location <span class="token operator">==</span> <span class="token string">&quot;USA&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>Age <span class="token operator">&gt;</span> <span class="token number">18</span> <span class="token operator">&amp;&amp;</span> action <span class="token operator">==</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 使用字符串定义模型</span>
	m<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> model<span class="token punctuation">.</span><span class="token function">NewModelFromString</span><span class="token punctuation">(</span><span class="token string">`
		[request_definition]
		r = sub, obj, act

		[policy_definition]
		p = sub, obj, act

		[policy_effect]
		e = some(where (p.eft == allow))

		[matchers]
		m = PolicyFunc(r.sub, r.obj, r.act)
	`</span><span class="token punctuation">)</span>

	<span class="token comment">// 初始化一个Casbin的Enforcer</span>
	enforcer<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>

	<span class="token comment">// 添加自定义策略函数</span>
	enforcer<span class="token punctuation">.</span><span class="token function">AddFunction</span><span class="token punctuation">(</span><span class="token string">&quot;PolicyFunc&quot;</span><span class="token punctuation">,</span> policyFunc<span class="token punctuation">)</span>

	<span class="token comment">// 创建用户和资源</span>
	userAlice <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> Role<span class="token punctuation">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">}</span>
	userBob <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> Role<span class="token punctuation">:</span> <span class="token string">&quot;member&quot;</span><span class="token punctuation">}</span>
	resourceData1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Resource<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">,</span> Location<span class="token punctuation">:</span> <span class="token string">&quot;USA&quot;</span><span class="token punctuation">}</span>

	<span class="token comment">// 检查访问权限</span>
	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>userAlice<span class="token punctuation">,</span> resourceData1<span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Alice can read data1: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>

	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>userBob<span class="token punctuation">,</span> resourceData1<span class="token punctuation">,</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Bob can read data1: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>

	ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> enforcer<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>userBob<span class="token punctuation">,</span> resourceData1<span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Bob can write data1: %v\n&quot;</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在上面的代码中，我们实现了一个基于Casbin的ABAC（基于属性的访问控制）权限模型。下面是对代码的详细解释：</p> <ol><li>首先，我们定义了两个结构体：<code>User</code> 和 <code>Resource</code>。<code>User</code> 结构体包含了用户的属性（名称、年龄、角色），<code>Resource</code> 结构体包含了资源的属性（名称、位置）。</li> <li>接下来，我们定义了一个自定义的策略函数 <code>policyFunc</code>。这个函数接受三个参数：用户、资源和操作。根据这些参数，函数判断用户是否有权限访问资源。在这个示例中，我们定义了以下规则：
<ul><li>如果用户是 admin，允许访问；</li> <li>如果用户是 owner，并且资源位于 USA，允许访问；</li> <li>如果用户年龄大于 18，并且操作是 read，允许访问。</li></ul></li> <li>初始化一个Casbin的Enforcer，并使用 <code>AddFunction</code> 方法将自定义策略函数添加到 Enforcer 中。</li> <li>创建用户和资源实例：<code>userAlice</code>、<code>userBob</code> 和 <code>resourceData1</code>。</li> <li>使用 <code>Enforce</code> 方法检查用户对资源的访问权限。在这个示例中，我们检查了 Alice 和 Bob 对 <code>data1</code> 资源的读写权限。</li></ol> <p>运行这个程序，你将看到以下输出：</p> <div class="language- extra-class"><pre class="language-text"><code>Alice can read data1: true
Bob can read data1: false
Bob can write data1: false
</code></pre></div><h3 id="casbin综合实践"><a href="#casbin综合实践" class="header-anchor">#</a> Casbin综合实践</h3> <h4 id="表结构定义"><a href="#表结构定义" class="header-anchor">#</a> 表结构定义</h4> <p>接下来，我们通过go的casbin库来完整实现一个RBAC权限模型，通过在API服务器中调用RBAC模型进行权限校验。</p> <p>首先，创建MySQL表结构：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 用户表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    password <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 角色表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> roles <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 权限表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> permissions <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    menu <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在这里，用户表(users)存储用户信息，角色表(roles)存储角色信息，权限表(permissions)存储权限信息。<code>role_constraints</code> 表用于存储角色的约束信息。</p> <p>当使用Casbin库存储策略到数据库时，Casbin会创建一个规则表用于存储策略信息。这个表的结构取决于具体的数据库适配器。对于Gorm适配器（<code>gorm-adapter</code>），Casbin将创建一个表，通常命名为<code>casbin_rule</code>，用于存储策略规则。实际在开发的时候，用户角色关联表（user_roles）、角色权限关联信息（role_permissions）这个三个表可以不用创建，直接复用下面的casbin_rule表。所以实际开发的时候，只需要用户表（users）、角色表（roles）、约束表（role_constraints）和规则表（casbin_rule）四张表即可。</p> <p>以下是一个简化的Casbin规则表结构的例子：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> casbin_rule <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    ptype <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    v0 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    v1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    v2 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    v3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    v4 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    v5 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>解释表结构中的字段：</p> <ul><li><p><code>id</code>: 规则的唯一标识，通常是一个自增的整数。</p></li> <li><p><code>ptype</code>: 策略类型，通常是&quot;p&quot;表示权限策略（policy）或&quot;g&quot;表示角色关联策略（grouping policy）或角色继承。</p></li> <li><p><code>v0, v1, v2, v3, v4, v5</code>: 规则的各个参数值，这些参数值的含义依赖于策略类型。</p> <ul><li>对于权限策略，通常是（sub, obj, act）三元组。</li> <li>对于角色关联策略，通常是用户与角色之间的关联。</li> <li>对于角色继承，通常是子角色和父角色之间的关系。</li></ul></li></ul> <p>例如，一条权限策略规则可能如下，这表示用户&quot;alice&quot;具有对资源&quot;data1&quot;执行&quot;read&quot;操作的权限。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'alice'</span><span class="token punctuation">,</span> <span class="token string">'data1'</span><span class="token punctuation">,</span> <span class="token string">'read'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
</code></pre></div><p>而一条角色关联策略规则可能如下，这表示用户&quot;alice&quot;拥有角色&quot;admin&quot;。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'alice'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>而角色继承规则可能如下，这条语句表示'user'角色继承'admin'角色。'g'表示这是一个角色继承关系，v0是父角色，v1是子角色。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="权限模型定义"><a href="#权限模型定义" class="header-anchor">#</a> 权限模型定义</h4> <p>然后，初始化Casbin的RBAC模型配置文件（rbac_model.conf）如下：</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token comment"># rbac_model.conf</span>

<span class="token comment"># 定义请求的匹配规则</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">request_definition</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">r</span> <span class="token punctuation">=</span> <span class="token value attr-value">sub, obj, act</span>

<span class="token comment"># 定义策略规则</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">policy_definition</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">p</span> <span class="token punctuation">=</span> <span class="token value attr-value">sub, obj, act</span>

<span class="token comment"># 定义策略效果</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">policy_effect</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">e</span> <span class="token punctuation">=</span> <span class="token value attr-value">some(where (p.eft == allow))</span>

<span class="token comment"># 定义匹配器规则</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">matchers</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">m</span> <span class="token punctuation">=</span> <span class="token value attr-value">g(r.sub, p.sub) &amp;&amp; keyMatch(r.obj, p.obj) &amp;&amp; (r.act == p.act || p.act == &quot;*&quot;)</span>

<span class="token comment"># 角色继承规则的默认效果</span>
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">role_definition</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">g</span> <span class="token punctuation">=</span> <span class="token value attr-value">_, _</span>

</code></pre></div><p>这个文件的解释如下：</p> <ul><li><code>[request_definition]</code>：定义了一个请求需要的元素。在这里，请求需要三个元素：主体（sub，表示用户）、对象（obj，表示资源）和操作（act，表示对资源的操作，如读、写等）。</li> <li><code>[policy_definition]</code>：定义了策略规则需要的元素。与请求定义相同，策略规则也需要三个元素：主体、对象和操作。</li> <li><code>[policy_effect]</code>：定义了策略效果。在这里，策略效果是“some(where (p.eft == allow))”，表示只要有一个策略规则允许访问，请求就被允许。</li> <li><code>[matchers]</code>：定义了匹配器规则。匹配器规则用于确定请求和策略规则是否匹配。在这里，匹配器规则包括三部分：
<ul><li><code>g(r.sub, p.sub)</code>：表示请求的主体需要具有策略规则中定义的角色。</li> <li><code>keyMatch(r.obj, p.obj)</code>：表示请求的对象需要与策略规则中的对象匹配。<code>keyMatch</code>是Casbin内置的匹配函数，支持部分匹配和通配符。</li> <li><code>(r.act == p.act || p.act == &quot;*&quot;)</code>：表示请求的操作需要与策略规则中的操作匹配，或者策略规则中的操作是通配符（表示允许所有操作）。</li></ul></li> <li><code>[role_definition]</code>：定义了角色继承规则。在这里，角色继承规则是<code>g = _, _</code>，表示角色可以继承其他角色。这在实际应用中很有用，例如，你可以定义一个管理员角色，继承了所有普通用户角色的权限。</li></ul> <h4 id="源码"><a href="#源码" class="header-anchor">#</a> 源码</h4> <p>当使用 Go 中的 HTTP 中间件时，你可以创建一个中间件函数，该函数在每个请求到达 HTTP 处理器之前执行权限校验。</p> <blockquote><p>rbac.go文件</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>

	<span class="token string">&quot;github.com/casbin/casbin/v2&quot;</span>
	gormadapter <span class="token string">&quot;github.com/casbin/gorm-adapter/v3&quot;</span>
	<span class="token string">&quot;gorm.io/driver/mysql&quot;</span>
	<span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// 数据库连接信息</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	DBUsername <span class="token operator">=</span> <span class="token string">&quot;root&quot;</span>
	DBPassword <span class="token operator">=</span> <span class="token string">&quot;123&quot;</span>
	DBHost     <span class="token operator">=</span> <span class="token string">&quot;localhost&quot;</span>
	DBPort     <span class="token operator">=</span> <span class="token string">&quot;3306&quot;</span>
	DBName     <span class="token operator">=</span> <span class="token string">&quot;rbac&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// 初始化 Casbin Enforcer</span>
<span class="token keyword">func</span> <span class="token function">InitCasbinEnforcer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>casbin<span class="token punctuation">.</span>Enforcer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	dsn <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%s@tcp(%s:%s)/%s?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span><span class="token punctuation">,</span> DBUsername<span class="token punctuation">,</span> DBPassword<span class="token punctuation">,</span> DBHost<span class="token punctuation">,</span> DBPort<span class="token punctuation">,</span> DBName<span class="token punctuation">)</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	adapter<span class="token punctuation">,</span> err <span class="token operator">:=</span> gormadapter<span class="token punctuation">.</span><span class="token function">NewAdapterByDB</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	enforcer<span class="token punctuation">,</span> err <span class="token operator">:=</span> casbin<span class="token punctuation">.</span><span class="token function">NewEnforcer</span><span class="token punctuation">(</span><span class="token string">&quot;rbac_model.conf&quot;</span><span class="token punctuation">,</span> adapter<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> enforcer<span class="token punctuation">.</span><span class="token function">LoadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> enforcer<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 鉴权</span>
<span class="token keyword">func</span> <span class="token function">Authorizer</span><span class="token punctuation">(</span>e <span class="token operator">*</span>casbin<span class="token punctuation">.</span>Enforcer<span class="token punctuation">,</span> username <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
		fn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			role <span class="token operator">:=</span> <span class="token function">GetRole</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
			<span class="token keyword">if</span> role <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
				role <span class="token operator">=</span> <span class="token string">&quot;anonymous&quot;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// casbin rule enforcing</span>
			res<span class="token punctuation">,</span> err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Enforce</span><span class="token punctuation">(</span>role<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Method<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;[1] Internal Server Error&quot;</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> res <span class="token punctuation">{</span>
				next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;[2] Access Forbidden(%s,%s,%s)&quot;</span><span class="token punctuation">,</span> role<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取用户拥有的角色</span>
<span class="token keyword">func</span> <span class="token function">GetRole</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>role <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 初始化数据库连接</span>
	dsn <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%s@tcp(%s:%s)/%s?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span><span class="token punctuation">,</span> DBUsername<span class="token punctuation">,</span> DBPassword<span class="token punctuation">,</span> DBHost<span class="token punctuation">,</span> DBPort<span class="token punctuation">,</span> DBName<span class="token punctuation">)</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> arr <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;select v1 from casbin_rule where v0=? and ptype=?&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token string">&quot;g&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		role <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取用户拥有的所有权限（包括继承角色的）</span>
<span class="token keyword">func</span> <span class="token function">GetPermissions</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">,</span> enforcer <span class="token operator">*</span>casbin<span class="token punctuation">.</span>Enforcer<span class="token punctuation">)</span> <span class="token punctuation">(</span>permissions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	arr<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> enforcer<span class="token punctuation">.</span><span class="token function">GetImplicitPermissionsForUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>

	<span class="token comment">// arr结构：[[&quot;admin&quot;,&quot;/*&quot;,&quot;*&quot;],[&quot;anonymous&quot;,&quot;/login&quot;,&quot;*&quot;],[&quot;member&quot;,&quot;/logout&quot;,&quot;*&quot;],[&quot;member&quot;,&quot;/member/*&quot;,&quot;*&quot;]]</span>
	<span class="token comment">// 数组组成是角色、资源、操作</span>
	visited <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> policy <span class="token operator">:=</span> <span class="token keyword">range</span> arr <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> visited<span class="token punctuation">[</span>policy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			visited<span class="token punctuation">[</span>policy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
			permissions <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>permissions<span class="token punctuation">,</span> policy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取用户拥有的菜单按钮权限</span>
<span class="token keyword">func</span> <span class="token function">GetMenus</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">,</span> enforcer <span class="token operator">*</span>casbin<span class="token punctuation">.</span>Enforcer<span class="token punctuation">)</span> <span class="token punctuation">(</span>menus <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 获取用户拥有的所有权限（包括继承角色的）</span>
	arr<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> enforcer<span class="token punctuation">.</span><span class="token function">GetImplicitPermissionsForUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
	<span class="token keyword">var</span> permissions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

	<span class="token comment">// arr结构：[[&quot;admin&quot;,&quot;/*&quot;,&quot;*&quot;],[&quot;anonymous&quot;,&quot;/login&quot;,&quot;*&quot;],[&quot;member&quot;,&quot;/logout&quot;,&quot;*&quot;],[&quot;member&quot;,&quot;/member/*&quot;,&quot;*&quot;]]</span>
	<span class="token comment">// 数组组成是角色、资源、操作</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> policy <span class="token operator">:=</span> <span class="token keyword">range</span> arr <span class="token punctuation">{</span>
		permissions <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>permissions<span class="token punctuation">,</span> policy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 初始化数据库连接</span>
	dsn <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%s@tcp(%s:%s)/%s?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span><span class="token punctuation">,</span> DBUsername<span class="token punctuation">,</span> DBPassword<span class="token punctuation">,</span> DBHost<span class="token punctuation">,</span> DBPort<span class="token punctuation">,</span> DBName<span class="token punctuation">)</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>dsn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	db<span class="token punctuation">.</span><span class="token function">Raw</span><span class="token punctuation">(</span><span class="token string">&quot;select distinct menu from permissions where name in ?&quot;</span><span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>menus<span class="token punctuation">)</span>

	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">logoutHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;Logout success\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">loginHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;Login success\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">currentMemberHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Get current member success:%s\n&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">adminHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;I'm an Admin!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 初始化 Casbin Enforcer</span>
	enforcer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">InitCasbinEnforcer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to initialize Casbin enforcer:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	username <span class="token operator">:=</span> <span class="token string">&quot;alice&quot;</span> <span class="token comment">// 假设当前用户</span>
	<span class="token comment">// 获取用户所有角色（包括角色继承的）</span>
	roles<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> enforcer<span class="token punctuation">.</span><span class="token function">GetImplicitRolesForUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s has these roles:%v&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// 获取用户所拥有的权限</span>
	permissions <span class="token operator">:=</span> <span class="token function">GetPermissions</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> enforcer<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s has these permissions:%v&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// 获取用户所拥有的菜单权限</span>
	menus <span class="token operator">:=</span> <span class="token function">GetMenus</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> enforcer<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s has these menus:%v&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> menus<span class="token punctuation">)</span><span class="token punctuation">)</span>

	mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token function">loginHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span> <span class="token function">logoutHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/member/lisi&quot;</span><span class="token punctuation">,</span> <span class="token function">currentMemberHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/member/zhangsan&quot;</span><span class="token punctuation">,</span> <span class="token function">currentMemberHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/admin/stuff&quot;</span><span class="token punctuation">,</span> <span class="token function">adminHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// 启动API服务器</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Server is running on :8080&quot;</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8080&quot;</span><span class="token punctuation">,</span> <span class="token function">Authorizer</span><span class="token punctuation">(</span>enforcer<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">(</span>mux<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>


</code></pre></div><h4 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h4> <p>为了测试RBAC模型，我们初始化一些测试数据。</p> <p>首先是初始化一些用户、角色和权限表。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 初始化用户</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users<span class="token punctuation">(</span>username<span class="token punctuation">,</span>passowrd<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'tom'</span><span class="token punctuation">,</span> <span class="token string">'pwd1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users<span class="token punctuation">(</span>username<span class="token punctuation">,</span>passowrd<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'alice'</span><span class="token punctuation">,</span> <span class="token string">'pwd1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users<span class="token punctuation">(</span>username<span class="token punctuation">,</span>passowrd<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'bob'</span><span class="token punctuation">,</span> <span class="token string">'pwd1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 初始化角色</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'anonymous'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'member'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 初始化权限表</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> permissions<span class="token punctuation">(</span>name<span class="token punctuation">,</span> menu<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token string">'用户模块'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> permissions<span class="token punctuation">(</span>name<span class="token punctuation">,</span> menu<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token string">'用户模块'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> permissions<span class="token punctuation">(</span>name<span class="token punctuation">,</span> menu<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'/member/*'</span><span class="token punctuation">,</span> <span class="token string">'成员模块'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> permissions<span class="token punctuation">(</span>name<span class="token punctuation">,</span> menu<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'/admin/staff'</span><span class="token punctuation">,</span> <span class="token string">'管理员模块'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>因为我们要关联接口对应的菜单关系，所以在permissions表里维护接口菜单关系时，接口名称要具体到完整路径，不能用类似<code>/*</code>这种模糊匹配。</p> <p>然后在设计策略的时候，角色关联的接口权限也要具体到完整接口路径，这个后面可以和前面的permissions表里根据接口地址获取到对应的菜单列表，前端就可以根据菜单列表做控制展示。</p> <p>下面的策略规则表示如下：</p> <ul><li>admin角色拥有所有接口权限</li> <li>anonymous角色只有登录接口权限</li> <li>member角色可以登录、退出以及访问/member/路径的接口权限</li></ul> <div class="language- extra-class"><pre class="language-text"><code>p, admin, /*, *
p, admin, /login, *
p, admin, /logout, *
p, admin, /member/*, *
p, admin, /admin/staff, *

p, anonymous, /login, *

p, member, /login, *
p, member, /logout, *
p, member, /member/*, *

g, tom, admin
g, alice, member
g, bob, member

g, member, anonymous
g, admin, member
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'/*'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'/member/*'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'/admin/staff'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'anonymous'</span><span class="token punctuation">,</span> <span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'member'</span><span class="token punctuation">,</span> <span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'member'</span><span class="token punctuation">,</span> <span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'member'</span><span class="token punctuation">,</span> <span class="token string">'/member/*'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后我们给3个用户初始化对应的角色，并且让member角色继承anonymous角色，也就是说member角色也包含anonymous角色的权限，同样的admin角色继承了member角色，也就间接继承了member角色和anonymous角色的所有权限。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'tom'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'alice'</span><span class="token punctuation">,</span> <span class="token string">'member'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'bob'</span><span class="token punctuation">,</span> <span class="token string">'anonymous'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'member'</span><span class="token punctuation">,</span> <span class="token string">'anonymous'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> casbin_rule <span class="token punctuation">(</span>ptype<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'member'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>前面代码，我们假设请求的当前用户是alice，启动前面的代码，我们可以看到输出如下，可以看到alice拥有的角色member，同时因为member是继承anonymous角色，所以也间接拥有anonymous角色。最终可以看到alice拥有member和anonymous两个角色的接口权限。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>go run rbac.go

<span class="token number">2023</span>/xx/xx <span class="token number">17</span>:20:52 alice has these roles:<span class="token punctuation">[</span>member anonymous<span class="token punctuation">]</span>
<span class="token number">2023</span>/xx/xx <span class="token number">17</span>:20:52 alice has these permissions:<span class="token punctuation">[</span>/login /logout /member/*<span class="token punctuation">]</span>
<span class="token number">2023</span>/xx/xx <span class="token number">17</span>:20:52 alice has these menus:<span class="token punctuation">[</span>用户模块 成员模块<span class="token punctuation">]</span>
</code></pre></div><p>实际去请求下面4个接口，返回是通过的，跟策略一样。</p> <div class="language- extra-class"><pre class="language-text"><code>请求：curl -d '{}' http://localhost:8080/login
响应：Login success
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>请求：curl -d '{}' http://localhost:8080/logout
响应：Logout success
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>请求：curl -d '{}' http://localhost:8080/member/lisi
响应：Get current member success:/member/lisi
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>请求：curl -d '{}' http://localhost:8080/member/zhangsan
响应：Get current member success:/member/zhangsan
</code></pre></div><p>当请求admin角色的接口时，就收到无权限的提示，符合预期设置的策略规则。</p> <div class="language- extra-class"><pre class="language-text"><code>请求：curl -d '{}' http://localhost:8080/admin/staff
响应：[2] Access Forbidden(role:member,/admin/staff,POST)
</code></pre></div><p>假设当前用户是bob，他是anonymous角色，执行<code>go run rbac.go</code>输出如下：</p> <div class="language- extra-class"><pre class="language-text"><code>2023/xx/xx 17:24:08 bob has these roles:[anonymous]
2023/xx/xx 17:24:08 bob has these permissions:[/login]
2023/xx/xx 17:24:08 bob has these menus:[用户模块]
</code></pre></div><p>假设当前用户是tom，他是admin角色，执行<code>go run rbac.go</code>输出如下：</p> <div class="language- extra-class"><pre class="language-text"><code>2023/xx/xx 17:24:48 tom has these roles:[admin member anonymous]
2023/xx/xx 17:24:48 tom has these permissions:[/login /logout /member/* /admin/staff]
2023/xx/xx 17:24:48 tom has these menus:[管理员模块 用户模块 成员模块]
</code></pre></div><h3 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h3> <p>[1] https://www.profsandhu.com/infs767/infs767fall03/lecture01-2.pdf</p> <p>[2] https://www.profsandhu.com/infs767/infs767fall03/</p> <p>[3] https://www.cnblogs.com/wang_yb/archive/2018/11/20/9987397.html</p> <p>[4] https://arxiv.org/pdf/1903.09756.pdf</p> <p>[5] https://casbin.org/zh/docs/tutorials</p> <p>[6] https://narendraj9.github.io/posts/generalized-authz.html</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">4/6/2024, 8:27:42 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/6-核心表结构与接口设计.html" class="prev">
        6 核心表结构与接口设计
      </a></span> <span class="next"><a href="/8-分布式Crontab任务调度.html">
        8 分布式Crontab任务调度
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b8820ad2.js" defer></script><script src="/assets/js/2.a6c4a04f.js" defer></script><script src="/assets/js/1.04b49174.js" defer></script><script src="/assets/js/21.94815126.js" defer></script>
  </body>
</html>
